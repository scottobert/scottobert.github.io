<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="Explore essential communication patterns for microservices architectures, including synchronous and asynchronous patterns, event-driven design, and resilience strategies in TypeScript and AWS."><link rel=canonical href=https://scottobert.com/posts/microservices-communication-patterns/><meta property="og:title" content="Microservices Communication Patterns: Building Resilient Distributed Systems"><meta property="og:description" content="Explore essential communication patterns for microservices architectures, including synchronous and asynchronous patterns, event-driven design, and resilience strategies in TypeScript and AWS."><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.com/posts/microservices-communication-patterns/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="Microservices Communication Patterns: Building Resilient Distributed Systems"><meta name=twitter:description content="Explore essential communication patterns for microservices architectures, including synchronous and asynchronous patterns, event-driven design, and resilience strategies in TypeScript and AWS."><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a>
<a href=/about/>About</a></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><div class=content-layout><main class=main-content><article class=post><h1>Microservices Communication Patterns: Building Resilient Distributed Systems</h1><div class=post-meta><span>Oct 17, 2021</span>
<span>| Tags: Microservices, TypeScript, AWS, Event-Driven Architecture, Communication Patterns, Distributed Systems</span></div><div class=post-content><h2 id=introduction>Introduction</h2><p>In our Modern Development Practices series, we&rsquo;ve explored test-driven development, code quality gates, and API design patterns. Today, we&rsquo;re diving into microservices communication patterns â€“ the backbone of any successful distributed system. Effective communication between services determines the resilience, scalability, and maintainability of your entire architecture.</p><h2 id=synchronous-communication-patterns>Synchronous Communication Patterns</h2><h3 id=httprest-with-circuit-breaker-pattern>HTTP/REST with Circuit Breaker Pattern</h3><p>The most common synchronous pattern uses HTTP/REST calls with resilience mechanisms:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>CircuitBreakerConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>failureThreshold</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetTimeout</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>monitoringPeriod</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CircuitBreaker</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>state</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CLOSED&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;OPEN&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;HALF_OPEN&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CLOSED&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>failureCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>lastFailureTime?</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>CircuitBreakerConfig</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>&lt;<span style=color:#f92672>T</span>&gt;(<span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt;)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;OPEN&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>shouldAttemptReset</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;HALF_OPEN&#39;</span>;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Circuit breaker is OPEN&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>operation</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onSuccess</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>onFailure</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>onSuccess</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>failureCount</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CLOSED&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>onFailure</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>failureCount</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFailureTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>failureCount</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>failureThreshold</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>state</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;OPEN&#39;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>shouldAttemptReset</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeSinceLastFailure</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lastFailureTime</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>timeSinceLastFailure</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>resetTimeout</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Usage in a service client
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>UserServiceClient</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>circuitBreaker</span>: <span style=color:#66d9ef>CircuitBreaker</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>circuitBreaker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CircuitBreaker</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>failureThreshold</span>: <span style=color:#66d9ef>5</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resetTimeout</span>: <span style=color:#66d9ef>60000</span>, <span style=color:#75715e>// 1 minute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>monitoringPeriod</span>: <span style=color:#66d9ef>10000</span> <span style=color:#75715e>// 10 seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getUser</span>(<span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>User</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>circuitBreaker</span>.<span style=color:#a6e22e>execute</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>baseUrl</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/users/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#66d9ef>5000</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authToken</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to fetch user: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=request-response-with-retry-and-timeout>Request-Response with Retry and Timeout</h3><p>Implement robust retry mechanisms with exponential backoff:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RetryConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxAttempts</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>baseDelay</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxDelay</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>backoffMultiplier</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RetryableHttpClient</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>retryConfig</span>: <span style=color:#66d9ef>RetryConfig</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>request</span>&lt;<span style=color:#f92672>T</span>&gt;(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>RequestInit</span> <span style=color:#f92672>&amp;</span> { <span style=color:#a6e22e>timeout?</span>: <span style=color:#66d9ef>number</span> } <span style=color:#f92672>=</span> {}
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>10000</span>, ...<span style=color:#a6e22e>fetchOptions</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>options</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retryConfig</span>.<span style=color:#a6e22e>maxAttempts</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>controller</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AbortController</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeoutId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>controller</span>.<span style=color:#a6e22e>abort</span>(), <span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>fetchOptions</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>signal</span>: <span style=color:#66d9ef>controller.signal</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timeoutId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Don&#39;t retry on client errors (4xx)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>400</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>500</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Client error: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Server error: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retryConfig</span>.<span style=color:#a6e22e>maxAttempts</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>delay</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retryConfig</span>.<span style=color:#a6e22e>baseDelay</span> <span style=color:#f92672>*</span> Math.<span style=color:#a6e22e>pow</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retryConfig</span>.<span style=color:#a6e22e>backoffMultiplier</span>, <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retryConfig</span>.<span style=color:#a6e22e>maxDelay</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>delay</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Max retry attempts exceeded&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>ms</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>(<span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>ms</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=asynchronous-communication-patterns>Asynchronous Communication Patterns</h2><h3 id=event-driven-architecture-with-aws-snssqs>Event-Driven Architecture with AWS SNS/SQS</h3><p>Implement robust event-driven communication using AWS services:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SNSClient</span>, <span style=color:#a6e22e>PublishCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-sns&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SQSClient</span>, <span style=color:#a6e22e>ReceiveMessageCommand</span>, <span style=color:#a6e22e>DeleteMessageCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-sqs&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DomainEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>eventType</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>metadata?</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventPublisher</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>snsClient</span>: <span style=color:#66d9ef>SNSClient</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>snsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SNSClient</span>({ <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>process.env.AWS_REGION</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>publishEvent</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>DomainEvent</span>, <span style=color:#a6e22e>topicArn</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>event</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>event.timestamp.toISOString</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PublishCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TopicArn</span>: <span style=color:#66d9ef>topicArn</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Message</span>: <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>message</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MessageAttributes</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>eventType</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DataType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;String&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>StringValue</span>: <span style=color:#66d9ef>event.eventType</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>aggregateId</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>DataType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;String&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>StringValue</span>: <span style=color:#66d9ef>event.aggregateId</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>snsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventHandler</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>sqsClient</span>: <span style=color:#66d9ef>SQSClient</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sqsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SQSClient</span>({ <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>process.env.AWS_REGION</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>processMessages</span>(<span style=color:#a6e22e>queueUrl</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>handler</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>DomainEvent</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (<span style=color:#66d9ef>true</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReceiveMessageCommand</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>QueueUrl</span>: <span style=color:#66d9ef>queueUrl</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>MaxNumberOfMessages</span>: <span style=color:#66d9ef>10</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>WaitTimeSeconds</span>: <span style=color:#66d9ef>20</span>, <span style=color:#75715e>// Long polling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#a6e22e>VisibilityTimeoutSeconds</span>: <span style=color:#66d9ef>60</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sqsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Messages</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Messages</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Messages</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>snsMessage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>Body</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;{}&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>DomainEvent</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>snsMessage</span>.<span style=color:#a6e22e>Message</span>);
</span></span><span style=display:flex><span>            
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Delete message only after successful processing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sqsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DeleteMessageCommand</span>({
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>QueueUrl</span>: <span style=color:#66d9ef>queueUrl</span>,
</span></span><span style=display:flex><span>              <span style=color:#a6e22e>ReceiptHandle</span>: <span style=color:#66d9ef>message.ReceiptHandle</span>
</span></span><span style=display:flex><span>            }));
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Failed to process message:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>            <span style=color:#75715e>// Message will become visible again after visibility timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error receiving messages:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sleep</span>(<span style=color:#ae81ff>5000</span>); <span style=color:#75715e>// Wait before retrying
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>sleep</span>(<span style=color:#a6e22e>ms</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>(<span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>ms</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=saga-pattern-for-distributed-transactions>Saga Pattern for Distributed Transactions</h3><p>Implement the Saga pattern for managing distributed transactions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SagaStep</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>execute</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>compensate</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderSaga</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>steps</span>: <span style=color:#66d9ef>SagaStep</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>completedSteps</span>: <span style=color:#66d9ef>SagaStep</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>orderService</span>: <span style=color:#66d9ef>OrderService</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>paymentService</span>: <span style=color:#66d9ef>PaymentService</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>inventoryService</span>: <span style=color:#66d9ef>InventoryService</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>shippingService</span>: <span style=color:#66d9ef>ShippingService</span>
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>(<span style=color:#a6e22e>orderData</span>: <span style=color:#66d9ef>CreateOrderRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>steps</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CreateOrderStep</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderService</span>, <span style=color:#a6e22e>orderData</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReserveInventoryStep</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>inventoryService</span>, <span style=color:#a6e22e>orderData</span>.<span style=color:#a6e22e>items</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ProcessPaymentStep</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>paymentService</span>, <span style=color:#a6e22e>orderData</span>.<span style=color:#a6e22e>payment</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CreateShipmentStep</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>shippingService</span>, <span style=color:#a6e22e>orderData</span>)
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>step</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>steps</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>step</span>.<span style=color:#a6e22e>execute</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>completedSteps</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>step</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>compensate</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>compensate</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Execute compensation in reverse order
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>completedSteps</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>completedSteps</span>[<span style=color:#a6e22e>i</span>].<span style=color:#a6e22e>compensate</span>();
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>compensationError</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Compensation failed:&#39;</span>, <span style=color:#a6e22e>compensationError</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Log for manual intervention
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CreateOrderStep</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>SagaStep</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>orderId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>orderService</span>: <span style=color:#66d9ef>OrderService</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>orderData</span>: <span style=color:#66d9ef>CreateOrderRequest</span>
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderService</span>.<span style=color:#a6e22e>createOrder</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderData</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderId</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>compensate</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderService</span>.<span style=color:#a6e22e>cancelOrder</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ReserveInventoryStep</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>SagaStep</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>reservationId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>inventoryService</span>: <span style=color:#66d9ef>InventoryService</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>OrderItem</span>[]
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reservationId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>inventoryService</span>.<span style=color:#a6e22e>reserveItems</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reservationId</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>compensate</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reservationId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>inventoryService</span>.<span style=color:#a6e22e>releaseReservation</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reservationId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=event-sourcing-with-cqrs>Event Sourcing with CQRS</h2><p>Implement event sourcing for audit trails and eventual consistency:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>Event</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>eventType</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>version</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>EventStore</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>Event</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>appendEvents</span>(<span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Event</span>[], <span style=color:#a6e22e>expectedVersion</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>existingEvents</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>events</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>aggregateId</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>existingEvents</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>expectedVersion</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Concurrency conflict&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>events</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>aggregateId</span>, [...<span style=color:#a6e22e>existingEvents</span>, ...<span style=color:#a6e22e>events</span>]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getEvents</span>(<span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>fromVersion?</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Event</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>events</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>aggregateId</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>fromVersion</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>e</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>version</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>fromVersion</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>events</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>abstract</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AggregateRoot</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>uncommittedEvents</span>: <span style=color:#66d9ef>Event</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>getUncommittedEvents</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Event</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uncommittedEvents</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>markEventsAsCommitted</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uncommittedEvents</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>loadFromHistory</span>(<span style=color:#a6e22e>events</span>: <span style=color:#66d9ef>Event</span>[])<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>forEach</span>(<span style=color:#a6e22e>event</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyEvent</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>version</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>addEvent</span>(<span style=color:#a6e22e>eventType</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>Event</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>this.generateId</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>this.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>eventType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span>: <span style=color:#66d9ef>this.version</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>uncommittedEvents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyEvent</span>(<span style=color:#a6e22e>event</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>version</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>version</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#66d9ef>abstract</span> <span style=color:#a6e22e>applyEvent</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>Event</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateId</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>9</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Order</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>AggregateRoot</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PENDING&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;CONFIRMED&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;SHIPPED&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;CANCELLED&#39;</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>OrderItem</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#a6e22e>create</span>(<span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>OrderItem</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Order</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>order</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Order</span>(<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>addEvent</span>(<span style=color:#e6db74>&#39;OrderCreated&#39;</span>, { <span style=color:#a6e22e>items</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>order</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>confirm</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Order cannot be confirmed&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addEvent</span>(<span style=color:#e6db74>&#39;OrderConfirmed&#39;</span>, {});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>protected</span> <span style=color:#a6e22e>applyEvent</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>Event</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>eventType</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;OrderCreated&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>items</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>items</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PENDING&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;OrderConfirmed&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CONFIRMED&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ... other events
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=service-mesh-and-api-gateway-patterns>Service Mesh and API Gateway Patterns</h2><h3 id=api-gateway-with-rate-limiting>API Gateway with Rate Limiting</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RateLimitConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>windowSize</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// in seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>maxRequests</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RateLimiter</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>requests</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>number</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>RateLimitConfig</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isAllowed</span>(<span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>windowStart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clientRequests</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>clientId</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validRequests</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>clientRequests</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>windowStart</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>validRequests</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>maxRequests</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>validRequests</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>now</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requests</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>clientId</span>, <span style=color:#a6e22e>validRequests</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// AWS Lambda API Gateway integration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>APIGatewayProxyEvent</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>APIGatewayProxyResult</span>&gt; <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rateLimiter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RateLimiter</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>windowSize</span>: <span style=color:#66d9ef>60</span>, <span style=color:#75715e>// 1 minute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>maxRequests</span>: <span style=color:#66d9ef>100</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>clientId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>requestContext</span>.<span style=color:#a6e22e>identity</span>.<span style=color:#a6e22e>sourceIp</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>rateLimiter</span>.<span style=color:#a6e22e>isAllowed</span>(<span style=color:#a6e22e>clientId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>429</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Retry-After&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;60&#39;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>JSON.stringify</span>({ <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Rate limit exceeded&#39;</span> })
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Process request...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>200</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>JSON.stringify</span>({ <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Success&#39;</span> })
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=monitoring-and-observability>Monitoring and Observability</h2><h3 id=distributed-tracing>Distributed Tracing</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>trace</span>, <span style=color:#a6e22e>SpanStatusCode</span>, <span style=color:#a6e22e>SpanKind</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@opentelemetry/api&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TracedHttpClient</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>tracer</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>trace</span>.<span style=color:#a6e22e>getTracer</span>(<span style=color:#e6db74>&#39;http-client&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>request</span>&lt;<span style=color:#f92672>T</span>&gt;(<span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>RequestInit</span> <span style=color:#f92672>=</span> {})<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>span</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tracer</span>.<span style=color:#a6e22e>startSpan</span>(<span style=color:#e6db74>&#39;http.request&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>kind</span>: <span style=color:#66d9ef>SpanKind.CLIENT</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>attributes</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.method&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>method</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.url&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>url</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.user_agent&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;microservice-client&#39;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#a6e22e>url</span>, {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>options</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>headers</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;traceparent&#39;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getTraceParent</span>(<span style=color:#a6e22e>span</span>)
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>setAttributes</span>({
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.status_code&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;http.response.size&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#66d9ef>get</span>(<span style=color:#e6db74>&#39;content-length&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>setStatus</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>SpanStatusCode.ERROR</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`HTTP </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`HTTP </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>setStatus</span>({ <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>SpanStatusCode.OK</span> });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>setStatus</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>SpanStatusCode.ERROR</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>finally</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>span</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>getTraceParent</span>(<span style=color:#a6e22e>span</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implementation would extract trace context for propagation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;trace-context-header&#39;</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=testing-communication-patterns>Testing Communication Patterns</h2><h3 id=contract-testing-with-pact>Contract Testing with Pact</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>Pact</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@pact-foundation/pact&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>UserServiceClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./user-service-client&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>describe</span>(<span style=color:#e6db74>&#39;User Service Contract&#39;</span>, () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provider</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Pact</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>consumer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;order-service&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>provider</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user-service&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>1234</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>: <span style=color:#66d9ef>path.resolve</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;logs&#39;</span>, <span style=color:#e6db74>&#39;pact.log&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>dir</span>: <span style=color:#66d9ef>path.resolve</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>cwd</span>(), <span style=color:#e6db74>&#39;pacts&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logLevel</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;INFO&#39;</span>
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>beforeAll</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>setup</span>());
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>afterAll</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>finalize</span>());
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>afterEach</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>verify</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>it</span>(<span style=color:#e6db74>&#39;should get user by id&#39;</span>, <span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>provider</span>.<span style=color:#a6e22e>addInteraction</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>state</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user exists&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>uponReceiving</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;a request for user with id 123&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withRequest</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/users/123&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Accept&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>willRespondWith</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>200</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;123&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;John Doe&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;john@example.com&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>client</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UserServiceClient</span>(<span style=color:#e6db74>&#39;http://localhost:1234&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>getUser</span>(<span style=color:#e6db74>&#39;123&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;123&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>expect</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>name</span>).<span style=color:#a6e22e>toBe</span>(<span style=color:#e6db74>&#39;John Doe&#39;</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><h2 id=best-practices-and-anti-patterns>Best Practices and Anti-Patterns</h2><h3 id=service-boundaries-and-data-consistency>Service Boundaries and Data Consistency</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Good: Services own their data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createOrder</span>(<span style=color:#a6e22e>customerId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>OrderItem</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Order</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Don&#39;t call customer service to validate - use eventual consistency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>order</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Order</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Publish event for other services to react
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>eventPublisher</span>.<span style=color:#a6e22e>publishEvent</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>eventType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;OrderCreated&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>aggregateId</span>: <span style=color:#66d9ef>order.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>items</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span>: <span style=color:#66d9ef>1</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>order</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Bad: Distributed transactions across services
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BadOrderService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createOrder</span>(<span style=color:#a6e22e>customerId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>items</span>: <span style=color:#66d9ef>OrderItem</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>Order</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Anti-pattern: Synchronous calls to multiple services
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>customerService</span>.<span style=color:#a6e22e>validateCustomer</span>(<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>inventoryService</span>.<span style=color:#a6e22e>reserveItems</span>(<span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>paymentService</span>.<span style=color:#a6e22e>authorizePayment</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>total</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If any of these fail, the entire transaction fails
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>orderRepository</span>.<span style=color:#a6e22e>save</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Order</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>items</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Effective microservices communication requires careful consideration of patterns, resilience, and consistency models. The patterns we&rsquo;ve explored â€“ from circuit breakers and saga patterns to event sourcing and service mesh â€“ provide the foundation for building robust distributed systems.</p><p>Key takeaways:</p><ul><li>Use synchronous communication sparingly and always with resilience patterns</li><li>Embrace asynchronous, event-driven communication for loose coupling</li><li>Implement proper monitoring and distributed tracing</li><li>Design for failure and eventual consistency</li><li>Test communication patterns with contract testing</li></ul><p>In our next post, &ldquo;Database Design for Serverless Applications,&rdquo; we&rsquo;ll explore how data architecture patterns align with these communication strategies in cloud-native environments.</p><h2 id=further-reading>Further Reading</h2><ul><li><a href=https://microservices.io/patterns/>Microservices Patterns by Chris Richardson</a></li><li><a href=https://www.oreilly.com/library/view/building-event-driven-microservices/9781492057888/>Building Event-Driven Microservices by Adam Bellemare</a></li><li><a href=https://docs.aws.amazon.com/wellarchitected/latest/reliability-pillar/welcome.html>AWS Well-Architected Framework - Reliability Pillar</a></li></ul></div></article></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li><li><a href=/posts/using-ai-in-software-engineering/>Harnessing AI in Software Engineering: Opportunities and Challenges</a>
<span class=post-date>May 29, 2025</span></li><li><a href=/posts/aws-serverless-cost-optimization/>Cost Optimization Strategies for AWS Serverless Applications</a>
<span class=post-date>Jun 17, 2023</span></li><li><a href=/posts/aws-sns-sqs-typescript/>Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span></li><li><a href=/posts/securing-aws-lambda/>Securing AWS Lambda Functions: Best Practices and Implementation Guide</a>
<span class=post-date>Apr 7, 2023</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/aws-sns-sqs-typescript/>AWS and Typescript: Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 3 posts in series â†’</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series â†’</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series â†’</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series â†’</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (1)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (8)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (16)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/development-tools>development tools (2)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (1)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:3rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:1rem>best practices
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:2rem>typescript
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>