<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="Building modern applications often requires the ability to perform full-text searches with fuzzy matching capabilities on data that&rsquo;s primarily stored in ‚Ä¶"><link rel=canonical href=https://scottobert.github.io/posts/dynamodb-streams-opensearch-sync/><meta property="og:title" content="Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current"><meta property="og:description" content="Building modern applications often requires the ability to perform full-text searches with fuzzy matching capabilities on data that&rsquo;s primarily stored in ‚Ä¶"><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.github.io/posts/dynamodb-streams-opensearch-sync/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current"><meta name=twitter:description content="Building modern applications often requires the ability to perform full-text searches with fuzzy matching capabilities on data that&rsquo;s primarily stored in ‚Ä¶"><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a>
<a href=/about/>About</a></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><div class=content-layout><main class=main-content><article class=post><h1>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</h1><div class=post-meta><span>Jun 6, 2025</span>
<span>| Tags: DynamoDB, Lambda, OpenSearch, AWS, real-time, search, TypeScript, streams</span></div><div class=post-content><p>Building modern applications often requires the ability to perform full-text searches with fuzzy matching capabilities on data that&rsquo;s primarily stored in NoSQL databases like DynamoDB. While DynamoDB excels at fast key-based lookups and can handle massive scale, it lacks the sophisticated search capabilities that applications need for features like autocomplete, typo-tolerant search, and complex text analysis. OpenSearch (the open-source fork of Elasticsearch) provides these advanced search capabilities, but keeping it synchronized with your primary data store presents unique challenges.</p><p>The combination of DynamoDB Streams and AWS Lambda offers an elegant solution for maintaining real-time synchronization between your transactional database and search index. This architectural pattern enables you to leverage DynamoDB&rsquo;s performance and scalability for your primary data operations while providing rich search experiences through OpenSearch, all while maintaining data consistency and proper ordering of updates.</p><div class=plantuml-container><img id=plantuml- class=plantuml-diagram>
<a id=plantuml-link- href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>üîç</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml DynamoDB to OpenSearch Sync Architecture

skinparam rectangle {
    BackgroundColor lightblue
    BorderColor darkblue
}

skinparam database {
    BackgroundColor lightgreen
    BorderColor darkgreen
}

skinparam queue {
    BackgroundColor lightyellow
    BorderColor orange
}

left to right direction

rectangle "Application Layer" as app {
  rectangle "Client Application" as client
}

rectangle "Data Layer" as data {
  database "DynamoDB\\nTable" as dynamodb
  database "OpenSearch\\nCluster" as opensearch
}

rectangle "Processing Layer" as processing {
  rectangle "Stream Processor\\nLambda" as streamProcessor
  queue "Dead Letter\\nQueue" as dlq
}

client --> dynamodb : "Write Operations\\n(PUT, UPDATE, DELETE)"
dynamodb --> streamProcessor : "DynamoDB Stream\\nEvents with\\nSequenceNumber"
streamProcessor --> opensearch : "Index/Update/Delete\\nDocuments"
streamProcessor --> dlq : "Failed Events\\nfor Retry"

note right of streamProcessor
  Processes events in order using SequenceNumber
  Handles INSERT, MODIFY, REMOVE events
  Implements retry logic with exponential backoff
  Transforms DynamoDB items to OpenSearch documents
end note

@enduml
`)</script><h2 id=understanding-dynamodb-streams-and-event-ordering>Understanding DynamoDB Streams and Event Ordering</h2><p>DynamoDB Streams capture data modification events in your DynamoDB tables in near real-time. When you enable a stream on a table, DynamoDB writes a stream record whenever an application creates, updates, or deletes items in that table. Each stream record appears exactly once in the stream, and the records appear in the same sequence as the actual modifications to the DynamoDB table.</p><p>The critical aspect for maintaining data consistency is understanding how DynamoDB Streams handle ordering through the SequenceNumber. Each stream record contains a SequenceNumber that determines the order in which the events were written to the stream. This sequence number is crucial because it ensures that if multiple updates happen to the same item in rapid succession, they are processed in the correct order to maintain consistency between your DynamoDB table and OpenSearch index.</p><h3 id=sequencenumber-properties-and-ordering>SequenceNumber Properties and Ordering</h3><p>SequenceNumbers in DynamoDB Streams have specific characteristics that are essential to understand for proper event processing:</p><ul><li><strong>String Format</strong>: SequenceNumbers are strings with a length between 21 and 40 characters that can be compared lexicographically to determine order</li><li><strong>Shard-Level Uniqueness</strong>: Each SequenceNumber is unique per partition key within a shard, ensuring deterministic ordering for records affecting the same item</li><li><strong>Lexicographic Ordering</strong>: You can compare SequenceNumbers using standard string comparison operators to determine chronological order</li><li><strong>Partition Key Grouping</strong>: Events for the same partition key are guaranteed to be processed in order within a single shard</li></ul><p>However, there&rsquo;s an important nuance to understand about ordering guarantees. DynamoDB Streams only guarantee ordering at the shard level, not across the entire stream. This means that events for different partition keys might be processed out of order relative to each other, but events for the same partition key will always be processed in the correct sequence. For most applications, this shard-level ordering is sufficient because it ensures that updates to individual records are processed correctly.</p><h2 id=implementing-the-lambda-stream-processor>Implementing the Lambda Stream Processor</h2><p>The Lambda function that processes DynamoDB stream events serves as the bridge between your primary data store and search index. This function must handle three types of events: INSERT (when new items are added), MODIFY (when existing items are updated), and REMOVE (when items are deleted). Each event type requires different handling in OpenSearch to maintain synchronization.</p><p>Here&rsquo;s a robust implementation of a stream processor using AWS SDK v3:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DynamoDBStreamEvent</span>, <span style=color:#a6e22e>DynamoDBRecord</span>, <span style=color:#a6e22e>Context</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;aws-lambda&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>OpenSearchClient</span>, <span style=color:#a6e22e>IndexCommand</span>, <span style=color:#a6e22e>UpdateCommand</span>, <span style=color:#a6e22e>DeleteCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-opensearch&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DynamoDBDocumentClient</span>, <span style=color:#a6e22e>GetCommand</span>, <span style=color:#a6e22e>PutCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/lib-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DynamoDBClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SQSClient</span>, <span style=color:#a6e22e>SendMessageCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-sqs&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProductDocument</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>category</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>searchText</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastModified</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ProcessingState</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastProcessedSequence</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>StreamProcessor</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>openSearchClient</span>: <span style=color:#66d9ef>OpenSearchClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>sqsClient</span>: <span style=color:#66d9ef>SQSClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>dynamoClient</span>: <span style=color:#66d9ef>DynamoDBDocumentClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>deadLetterQueueUrl</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>openSearchIndexName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>stateTableName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>OpenSearchClient</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>process.env.AWS_REGION</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>endpoint</span>: <span style=color:#66d9ef>process.env.OPENSEARCH_ENDPOINT</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sqsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SQSClient</span>({ <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>process.env.AWS_REGION</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dynamoClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DynamoDBDocumentClient</span>.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DynamoDBClient</span>({ 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>process.env.AWS_REGION</span> 
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>deadLetterQueueUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>DEAD_LETTER_QUEUE_URL</span><span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchIndexName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>OPENSEARCH_INDEX_NAME</span><span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stateTableName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>PROCESSING_STATE_TABLE_NAME</span><span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>processRecord</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>eventName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>eventName</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sequenceNumber</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>SequenceNumber</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>itemKey</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extractItemKey</span>(<span style=color:#a6e22e>record</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>sequenceNumber</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Missing SequenceNumber in stream record&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if this record should be processed based on sequence ordering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>shouldProcess</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>shouldProcessRecord</span>(<span style=color:#a6e22e>itemKey</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>shouldProcess</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Skipping out-of-order record for key </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>itemKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>, sequence </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sequenceNumber</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>eventName</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;INSERT&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleInsert</span>(<span style=color:#a6e22e>record</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;MODIFY&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleModify</span>(<span style=color:#a6e22e>record</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;REMOVE&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleRemove</span>(<span style=color:#a6e22e>record</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>`Unknown event type: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>eventName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Update the last processed sequence for this item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateLastProcessedSequence</span>(<span style=color:#a6e22e>itemKey</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to process record with sequence </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sequenceNumber</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>extractItemKey</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Extract the primary key from the record to group sequences per item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keys</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>Keys</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>keys</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Missing Keys in stream record&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a composite key from all primary key attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyParts</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>entries</span>(<span style=color:#a6e22e>keys</span>).<span style=color:#a6e22e>map</span>(([<span style=color:#a6e22e>attr</span>, <span style=color:#a6e22e>value</span>]) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>.<span style=color:#a6e22e>S</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>value</span>.<span style=color:#a6e22e>N</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>value</span>.<span style=color:#a6e22e>B</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>attr</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>val</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>keyParts</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;#&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>shouldProcessRecord</span>(<span style=color:#a6e22e>itemKey</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dynamoClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.stateTableName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>itemKey</span> }
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Item</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// First time processing this item
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      }      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastProcessedSequence</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>Item</span>.<span style=color:#a6e22e>lastProcessedSequence</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Compare sequence numbers (they are strings that can be compared lexicographically)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// SequenceNumbers maintain ordering within a shard for a given partition key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>compareSequenceNumbers</span>(<span style=color:#a6e22e>sequenceNumber</span>, <span style=color:#a6e22e>lastProcessedSequence</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Error checking processing state for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>itemKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// On error, allow processing to continue but log the issue
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>compareSequenceNumbers</span>(<span style=color:#a6e22e>seq1</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>seq2</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// SequenceNumbers are strings that can be compared lexicographically
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// They are unique per partition-key within a shard and maintain ordering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>seq1</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>seq2</span>) <span style=color:#66d9ef>return</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>seq1</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>seq2</span>) <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateLastProcessedSequence</span>(<span style=color:#a6e22e>itemKey</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>dynamoClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.stateTableName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>itemKey</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>lastProcessedSequence</span>: <span style=color:#66d9ef>sequenceNumber</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to update processing state for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>itemKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Don&#39;t throw here as the main operation succeeded
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleInsert</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>NewImage</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>newImage</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> document <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>transformToSearchDocument</span>(<span style=color:#a6e22e>newImage</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>IndexCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>index</span>: <span style=color:#66d9ef>this.openSearchIndexName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>document.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>document</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refresh</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;wait_for&#39;</span>, <span style=color:#75715e>// Ensure document is immediately searchable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeWithRetry</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleModify</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>NewImage</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>newImage</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> document <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>transformToSearchDocument</span>(<span style=color:#a6e22e>newImage</span>, <span style=color:#a6e22e>sequenceNumber</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if we have a newer version already indexed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>existingDoc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getExistingDocument</span>(document.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>existingDoc</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>compareSequenceNumbers</span>(<span style=color:#a6e22e>sequenceNumber</span>, <span style=color:#a6e22e>existingDoc</span>.<span style=color:#a6e22e>sequenceNumber</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Skipping update for </span><span style=color:#e6db74>${</span>document.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> - newer version already indexed`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use update with doc_as_upsert to handle cases where document might not exist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UpdateCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>index</span>: <span style=color:#66d9ef>this.openSearchIndexName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>document.id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>doc</span>: <span style=color:#66d9ef>document</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>doc_as_upsert</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refresh</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;wait_for&#39;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeWithRetry</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleRemove</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldImage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>OldImage</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>oldImage</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>id</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>S</span>) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>documentId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>oldImage</span>.<span style=color:#a6e22e>id</span>.<span style=color:#a6e22e>S</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if we have a newer version that was created after this delete
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>existingDoc</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getExistingDocument</span>(<span style=color:#a6e22e>documentId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>existingDoc</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>compareSequenceNumbers</span>(<span style=color:#a6e22e>sequenceNumber</span>, <span style=color:#a6e22e>existingDoc</span>.<span style=color:#a6e22e>sequenceNumber</span>) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Skipping delete for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>documentId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> - newer version exists`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DeleteCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>index</span>: <span style=color:#66d9ef>this.openSearchIndexName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>documentId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refresh</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;wait_for&#39;</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeWithRetry</span>(() <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>));
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Ignore 404 errors for delete operations as the document might already be gone
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>!==</span> <span style=color:#ae81ff>404</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getExistingDocument</span>(<span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ProductDocument</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchClient</span>.<span style=color:#a6e22e>send</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>openSearchIndexName</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/_doc/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>_source</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>404</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>transformToSearchDocument</span>(<span style=color:#a6e22e>dynamoImage</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>ProductDocument</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a searchable text field combining multiple attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>searchableFields</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dynamoImage</span>.<span style=color:#a6e22e>name</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dynamoImage</span>.<span style=color:#a6e22e>description</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dynamoImage</span>.<span style=color:#a6e22e>category</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      ...(<span style=color:#a6e22e>dynamoImage</span>.<span style=color:#a6e22e>tags</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>SS</span> <span style=color:#f92672>||</span> [])
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>dynamoImage.id.S</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>dynamoImage.name?.S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>dynamoImage.description?.S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>category</span>: <span style=color:#66d9ef>dynamoImage.category?.S</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>price</span>: <span style=color:#66d9ef>dynamoImage.price?.N</span> <span style=color:#f92672>?</span> parseFloat(<span style=color:#a6e22e>dynamoImage</span>.<span style=color:#a6e22e>price</span>.<span style=color:#a6e22e>N</span>) <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tags</span>: <span style=color:#66d9ef>dynamoImage.tags?.SS</span> <span style=color:#f92672>||</span> [],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>searchText</span>: <span style=color:#66d9ef>searchableFields.join</span>(<span style=color:#e6db74>&#39; &#39;</span>).<span style=color:#a6e22e>toLowerCase</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastModified</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>sequenceNumber</span>, <span style=color:#75715e>// Store the sequence number for ordering checks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>executeWithRetry</span>&lt;<span style=color:#f92672>T</span>&gt;(<span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> () <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt;, <span style=color:#a6e22e>maxRetries</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>T</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lastError</span>: <span style=color:#66d9ef>Error</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>maxRetries</span>; <span style=color:#a6e22e>attempt</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>operation</span>();
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>lastError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>attempt</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>maxRetries</span>) <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Exponential backoff with jitter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>delay</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> Math.<span style=color:#a6e22e>pow</span>(<span style=color:#ae81ff>2</span>, <span style=color:#a6e22e>attempt</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>), <span style=color:#ae81ff>10000</span>) <span style=color:#f92672>+</span> Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>(<span style=color:#a6e22e>resolve</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>setTimeout</span>(<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>delay</span>));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>lastError</span><span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendToDeadLetterQueue</span>(<span style=color:#a6e22e>record</span>: <span style=color:#66d9ef>DynamoDBRecord</span>, <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>Error</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>record</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>error.message</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>record.dynamodb?.SequenceNumber</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SendMessageCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>QueueUrl</span>: <span style=color:#66d9ef>this.deadLetterQueueUrl</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>MessageBody</span>: <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>message</span>),
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sqsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>DynamoDBStreamEvent</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>Context</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>processor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StreamProcessor</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>failures</span>: <span style=color:#66d9ef>any</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Sort records by sequence number within each shard to ensure proper ordering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sortedRecords</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>Records</span>.<span style=color:#a6e22e>sort</span>((<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>seqA</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>SequenceNumber</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>seqB</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>SequenceNumber</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Compare sequence numbers lexicographically for proper ordering
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>seqA</span>.<span style=color:#a6e22e>localeCompare</span>(<span style=color:#a6e22e>seqB</span>);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Process records sequentially to maintain ordering per shard
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>record</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>sortedRecords</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>processRecord</span>(<span style=color:#a6e22e>record</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to process record </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>record</span>.<span style=color:#a6e22e>dynamodb</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>SequenceNumber</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>processor</span>.<span style=color:#a6e22e>sendToDeadLetterQueue</span>(<span style=color:#a6e22e>record</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>failures</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>itemIdentifier</span>: <span style=color:#66d9ef>record.dynamodb?.Keys</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorCode</span>: <span style=color:#66d9ef>error.name</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>errorMessage</span>: <span style=color:#66d9ef>error.message</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sequenceNumber</span>: <span style=color:#66d9ef>record.dynamodb?.SequenceNumber</span>,
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// If there were failures, throw an error with details
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#75715e>// This will cause Lambda to retry the entire batch
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>failures</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to process </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>failures</span>.<span style=color:#a6e22e>length</span><span style=color:#e6db74>}</span><span style=color:#e6db74> records: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>failures</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h2 id=critical-considerations-for-sequencenumber-handling>Critical Considerations for SequenceNumber Handling</h2><p>The SequenceNumber in DynamoDB stream records is not just a timestamp or incrementing counter‚Äîit&rsquo;s a string value that represents the precise order of writes within a shard. Understanding how to properly handle these sequence numbers is crucial for maintaining data consistency, especially when dealing with rapid updates to the same item or when implementing custom retry mechanisms.</p><p>When Lambda processes stream events, it automatically handles the complexity of checkpointing and resuming from the correct position using these sequence numbers. However, there are scenarios where you need to be particularly careful. If your Lambda function fails partway through processing a batch of records, Lambda will retry the entire batch starting from the earliest unprocessed sequence number. This means your processing logic must be idempotent‚Äîrunning the same operation multiple times should produce the same result.</p><p>For OpenSearch operations, achieving idempotency requires careful consideration of how you structure your index operations. Using the DynamoDB item&rsquo;s primary key as the OpenSearch document ID ensures that repeated index operations will update the same document rather than creating duplicates. Additionally, including a version field or timestamp in your documents can help you implement optimistic concurrency control if needed.</p><p>One common pitfall occurs when developers attempt to implement custom batching or reordering of stream events based on their own logic rather than trusting DynamoDB&rsquo;s sequence numbers. This approach almost invariably leads to race conditions and data inconsistencies. The sequence number provides the authoritative ordering within each shard, and any custom reordering should only be done with extreme caution and thorough testing.</p><h2 id=advanced-error-handling-and-recovery-strategies>Advanced Error Handling and Recovery Strategies</h2><p>Production systems require sophisticated error handling strategies that go beyond simple retry logic. Network timeouts, OpenSearch cluster unavailability, and temporary capacity constraints are common issues that your stream processor must handle gracefully without losing data or breaking the synchronization between your stores.</p><p>The implementation above includes a dead letter queue pattern for handling records that consistently fail to process. This pattern is essential because DynamoDB Streams have a 24-hour retention period‚Äîif a record cannot be processed within that window, it will be lost forever. By sending failed records to a dead letter queue, you create an opportunity for manual intervention or automated recovery processes to handle these edge cases.</p><p>When implementing retry logic, consider the nature of different types of errors. Transient network errors or temporary capacity constraints should be retried with exponential backoff, while authentication errors or malformed data should be sent directly to the dead letter queue since retrying won&rsquo;t resolve these issues. The retry strategy should also consider the Lambda function&rsquo;s execution time limits‚Äîcomplex retry logic that takes too long might cause the function to timeout and restart, leading to duplicate processing.</p><p>For scenarios where you need guaranteed exactly-once processing semantics, consider implementing a custom deduplication mechanism using a separate DynamoDB table to track processed sequence numbers. While this adds complexity, it can be necessary for financial or other critical applications where duplicate processing could have serious consequences.</p><h2 id=optimizing-opensearch-performance-and-index-design>Optimizing OpenSearch Performance and Index Design</h2><p>The design of your OpenSearch index significantly impacts both the performance of your synchronization process and the quality of your search results. When designing your index mapping, consider how your data will be searched and optimize the field types and analyzers accordingly. Text fields that will be used for fuzzy matching should use appropriate analyzers that can handle stemming, synonyms, and phonetic matching.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>indexMapping</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mappings</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>id</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;keyword&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>analyzer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;standard&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fields</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>keyword</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;keyword&#39;</span> },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>suggest</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;completion&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>analyzer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;simple&#39;</span>,
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>analyzer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;english&#39;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>searchText</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>analyzer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;standard&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>search_analyzer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;fuzzy_search_analyzer&#39;</span>,
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>category</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;keyword&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>price</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;double&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tags</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;keyword&#39;</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastModified</span><span style=color:#f92672>:</span> { <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;date&#39;</span> },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>settings</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>analysis</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>analyzer</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fuzzy_search_analyzer</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>tokenizer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;standard&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>filter</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;lowercase&#39;</span>, <span style=color:#e6db74>&#39;asciifolding&#39;</span>, <span style=color:#e6db74>&#39;fuzzy_filter&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>filter</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fuzzy_filter</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;phonetic&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>encoder</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;soundex&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>Bulk operations can significantly improve the performance of your synchronization process when handling high-volume updates. Instead of sending individual index requests for each stream record, consider accumulating changes and using OpenSearch&rsquo;s bulk API. However, be careful to balance batch size with latency requirements‚Äîlarger batches are more efficient but increase the time between when data changes in DynamoDB and when it becomes searchable in OpenSearch.</p><h2 id=monitoring-and-observability>Monitoring and Observability</h2><p>Effective monitoring is essential for maintaining a reliable real-time synchronization system. Key metrics to track include the age of the oldest unprocessed stream record (stream lag), the rate of processing errors, OpenSearch indexing latency, and the Lambda function&rsquo;s duration and memory usage. CloudWatch custom metrics can provide insights into your application-specific concerns, such as the number of documents processed per minute or the average time between DynamoDB writes and OpenSearch availability.</p><p>Set up alarms for critical conditions such as stream lag exceeding acceptable thresholds, error rates climbing above normal levels, or dead letter queue messages accumulating. These early warning systems allow you to address issues before they impact user experience. Consider implementing health check endpoints that can verify the synchronization status by comparing record counts or checksums between DynamoDB and OpenSearch.</p><p>Distributed tracing using AWS X-Ray can provide valuable insights into the end-to-end flow of data through your system, helping you identify bottlenecks and optimize performance. Correlation IDs that flow from the initial DynamoDB write through the stream processing to the final OpenSearch indexing can help you trace individual requests and debug issues.</p><h2 id=testing-strategies-for-stream-processing>Testing Strategies for Stream Processing</h2><p>Testing real-time data synchronization systems presents unique challenges because of their asynchronous, event-driven nature. Unit tests should cover the core transformation logic and error handling scenarios, while integration tests need to verify the end-to-end flow from DynamoDB writes to OpenSearch updates. Consider using tools like LocalStack or DynamoDB Local to create reproducible test environments that don&rsquo;t require AWS resources.</p><p>Event ordering tests are particularly important because race conditions and ordering issues often only manifest under high load or specific timing conditions. Create tests that simulate rapid updates to the same DynamoDB item and verify that the final state in OpenSearch matches the expected result. Use controlled delays and forced failures to test your error handling and recovery mechanisms.</p><p>Load testing should simulate realistic traffic patterns and include scenarios such as sudden spikes in write volume, temporary OpenSearch unavailability, and Lambda cold starts. These tests help you understand the system&rsquo;s behavior under stress and identify capacity planning requirements.</p><h2 id=common-pitfalls-and-best-practices>Common Pitfalls and Best Practices</h2><p>Many teams underestimate the complexity of maintaining consistency between different data stores with different consistency models and performance characteristics. DynamoDB provides strong consistency for reads immediately after writes within the same region, but DynamoDB Streams operate on an eventually consistent model. This means there can be a delay between when data is written to DynamoDB and when the corresponding stream event is generated, though this delay is typically measured in milliseconds.</p><p>Another common mistake is assuming that stream events will always contain complete item data. Depending on your stream view type configuration, you might only receive the changed attributes rather than the full item. When using KEYS_ONLY or OLD_IMAGE view types, you&rsquo;ll need to implement additional logic to fetch the current item state from DynamoDB before updating OpenSearch.</p><p>Schema evolution presents ongoing challenges in real-time synchronization systems. When you add new fields to your DynamoDB items, you need to ensure that your Lambda function can handle both old and new record formats gracefully. Similarly, changes to your OpenSearch mapping might require reindexing existing data, which needs to be coordinated carefully to avoid search downtime.</p><p>Resource limits and quotas can cause subtle issues that only appear under load. DynamoDB Streams have limits on the number of concurrent Lambda executions per shard, and OpenSearch clusters have limits on indexing throughput and concurrent requests. Design your system with these limits in mind and implement appropriate backpressure mechanisms to handle traffic spikes gracefully.</p><p>The combination of DynamoDB Streams and Lambda provides a powerful foundation for real-time data synchronization, enabling you to build systems that leverage the strengths of both transactional and search-optimized data stores. Success requires careful attention to ordering semantics, robust error handling, and thorough testing, but the result is a scalable architecture that can support sophisticated search experiences while maintaining data consistency and high availability.</p></div></article></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li><li><a href=/posts/using-ai-in-software-engineering/>Harnessing AI in Software Engineering: Opportunities and Challenges</a>
<span class=post-date>May 29, 2025</span></li><li><a href=/posts/aws-serverless-cost-optimization/>Cost Optimization Strategies for AWS Serverless Applications</a>
<span class=post-date>Jun 17, 2023</span></li><li><a href=/posts/aws-sns-sqs-typescript/>Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span></li><li><a href=/posts/securing-aws-lambda/>Securing AWS Lambda Functions: Best Practices and Implementation Guide</a>
<span class=post-date>Apr 7, 2023</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/aws-sns-sqs-typescript/>AWS and Typescript: Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 3 posts in series ‚Üí</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series ‚Üí</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series ‚Üí</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series ‚Üí</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (1)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (8)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (16)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/development-tools>development tools (2)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (1)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:3rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:1rem>best practices
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:2rem>typescript
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>