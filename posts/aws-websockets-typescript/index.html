<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="Modern applications increasingly demand real-time capabilities—from live chat systems and collaborative editing to real-time dashboards and gaming. In this …"><link rel=canonical href=https://scottobert.com/posts/aws-websockets-typescript/><meta property="og:title" content="Real-time Applications with AWS WebSockets and TypeScript"><meta property="og:description" content="Modern applications increasingly demand real-time capabilities—from live chat systems and collaborative editing to real-time dashboards and gaming. In this …"><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.com/posts/aws-websockets-typescript/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="Real-time Applications with AWS WebSockets and TypeScript"><meta name=twitter:description content="Modern applications increasingly demand real-time capabilities—from live chat systems and collaborative editing to real-time dashboards and gaming. In this …"><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script src=/js/search.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a>
<a href=/album/>Photo Album</a>
<button type=button class=search-toggle id=search-toggle-btn aria-label="Open search" title=Search>
<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61.0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
<span>Search</span></button></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><nav class=breadcrumbs aria-label="Breadcrumb navigation"><ol class=breadcrumb-list><li class=breadcrumb-item><a href=https://scottobert.com/ title=Home><svg class="breadcrumb-home-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
<span>Home</span></a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/posts/ title=Posts>Posts</a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/series/aws-and-typescript/ title="Series: AWS and Typescript"><svg class="breadcrumb-series-icon" viewBox="0 0 24 24"><path d="M9 4v1.38c-.83-.33-1.72-.5-2.61-.5-1.79.0-3.58.68-4.95 2.05l3.33 3.33h1.11v1.11c.86.86 1.98 1.31 3.11 1.31 1.13.0 2.25-.45 3.11-1.31V9.26h1.11l3.33-3.33c-1.37-1.37-3.16-2.05-4.95-2.05-.89.0-1.78.17-2.61.5V4H9z"/></svg>
<span>AWS and Typescript</span></a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/categories/cloud-computing title="Category: Cloud Computing"><svg class="breadcrumb-category-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
<span>Cloud Computing</span></a></li><li class="breadcrumb-item breadcrumb-current"><span class=breadcrumb-separator aria-hidden=true>/</span>
<span class=breadcrumb-current-page aria-current=page>Real-time Applications with AWS WebSockets and TypeScript</span></li></ol></nav><div class=content-layout><main class=main-content><article class=post><h1>Real-time Applications with AWS WebSockets and TypeScript</h1><div class=post-meta><div class=post-meta-left><span>Aug 13, 2023</span>
<span>| Tags: AWS, TypeScript, WebSockets, Real-time, API Gateway, Serverless</span></div><div class=post-meta-right><div class=quick-social-share><button type=button class=quick-share-toggle id=quick-share-toggle title="Share this post">
<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
<span>Share</span></button><div class=quick-share-buttons id=quick-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="quick-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="quick-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="quick-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&title=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="quick-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&t=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="quick-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="quick-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=Real-time+Applications+with+AWS+WebSockets+and+TypeScript&body=Check+out+this+article%3A+Real-time+Applications+with+AWS+WebSockets+and+TypeScript+-+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" class="quick-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="quick-share-button copy-link" data-url=https://scottobert.com/posts/aws-websockets-typescript/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const i=document.querySelector(".quick-social-share"),e=document.getElementById("quick-share-toggle"),t=document.getElementById("quick-share-buttons");if(!i||!e||!t)return;let n=!1;e.addEventListener("click",function(){n=!n,n?(t.classList.add("visible"),e.classList.add("active")):(t.classList.remove("visible"),e.classList.remove("active"))});const a=document.querySelectorAll(".quick-share-button.copy-link");a.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{o(this)}).catch(()=>{s(e,this)}):s(e,this)})});function s(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),o(t)}catch(e){console.error("Fallback: Unable to copy",e),r(t)}document.body.removeChild(n)}function o(e){const n=e.getAttribute("title");e.setAttribute("title","Copied!"),e.classList.add("copied");const t=document.createElement("div");t.textContent="Copied!",t.style.position="absolute",t.style.bottom="100%",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#28a745",t.style.color="white",t.style.padding="4px 8px",t.style.borderRadius="4px",t.style.fontSize="0.75rem",t.style.whiteSpace="nowrap",t.style.zIndex="1000",t.style.marginBottom="5px",e.style.position="relative",e.appendChild(t),setTimeout(()=>{e.setAttribute("title",n),e.classList.remove("copied"),t.parentNode&&e.removeChild(t)},2e3)}function r(e){const t=e.getAttribute("title");e.setAttribute("title","Copy failed"),e.classList.add("error"),setTimeout(()=>{e.setAttribute("title",t),e.classList.remove("error")},2e3)}})()</script></div></div><div class=post-content><p>Modern applications increasingly demand real-time capabilities—from live chat systems and collaborative editing to real-time dashboards and gaming. In this final post of our AWS and TypeScript series, we&rsquo;ll explore how to build scalable real-time applications using AWS API Gateway WebSocket APIs, Lambda functions, and TypeScript to create robust, type-safe real-time communication systems.</p><div class=plantuml-container><img id=plantuml-websocket-architecture class=plantuml-diagram>
<a id=plantuml-link-websocket-architecture href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>🔍</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-websocket-architecture"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-websocket-architecture");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml WebSocket Architecture
!define RECTANGLE class

cloud "Client Applications" as clients
package "AWS Cloud" {
  rectangle "API Gateway WebSocket" as apigw {
    rectangle "Connect Route" as connect
    rectangle "Disconnect Route" as disconnect
    rectangle "Message Routes" as routes
  }
  
  package "Lambda Functions" {
    rectangle "Connection Handler" as conn_handler
    rectangle "Message Handler" as msg_handler
    rectangle "Room Manager" as room_handler
    rectangle "Broadcast Service" as broadcast
  }
  
  database "DynamoDB" as dynamo {
    rectangle "Connections Table" as conn_table
    rectangle "Messages Table" as msg_table
    rectangle "Rooms Table" as room_table
  }
  
  rectangle "API Gateway Management API" as mgmt_api
}

clients <--> connect : WebSocket Connection
clients <--> disconnect : WebSocket Disconnection
clients <--> routes : Real-time Messages

connect --> conn_handler : $connect
disconnect --> conn_handler : $disconnect
routes --> msg_handler : Custom Routes
routes --> room_handler : Room Operations

conn_handler --> conn_table : Store Connection
msg_handler --> msg_table : Store Message
room_handler --> room_table : Manage Rooms

broadcast --> mgmt_api : Send to Connections
mgmt_api --> clients : Real-time Updates

note right of apigw
  • Persistent connections
  • Bidirectional communication  • Auto-scaling
  • Route-based message handling
end note

note right of dynamo
  • Connection state storage
  • Message persistence
  • Room membership
  • TTL for cleanup
end note
@enduml
`)</script><h2 id=understanding-websocket-apis-with-aws>Understanding WebSocket APIs with AWS</h2><p>AWS API Gateway WebSocket APIs provide a fully managed service for building real-time, bidirectional communication applications. Key advantages include:</p><ul><li><strong>Persistent Connections</strong>: Maintain long-lived connections for instant messaging</li><li><strong>Automatic Scaling</strong>: Handle thousands of concurrent connections without infrastructure management</li><li><strong>Pay-per-Use</strong>: Cost-effective pricing model with no idle charges</li><li><strong>AWS Integration</strong>: Seamless integration with Lambda, DynamoDB, and other AWS services</li><li><strong>Route-Based Architecture</strong>: Organize message handling with custom routes</li></ul><h2 id=prerequisites>Prerequisites</h2><p>Essential knowledge and tools for WebSocket development:</p><ul><li><strong>Previous Series Posts</strong>: Lambda, DynamoDB, and API Gateway fundamentals</li><li><strong>AWS SDK v3</strong>: API Gateway Management API and DynamoDB clients</li><li><strong>WebSocket Concepts</strong>: Connection lifecycle, message routing, and error handling</li><li><strong>Real-time Patterns</strong>: Broadcasting, presence management, and state synchronization</li></ul><h2 id=type-safe-websocket-architecture>Type-Safe WebSocket Architecture</h2><p>Define comprehensive type definitions for WebSocket operations:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/types/websocket.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>WebSocketEvent</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestContext</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>routeKey</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stage</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>apiId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>domainName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>eventType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CONNECT&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;DISCONNECT&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;MESSAGE&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messageId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestTime</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>requestTimeEpoch</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identity</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sourceIp</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authorizer</span><span style=color:#f92672>?:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>      [<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>string</span>]<span style=color:#f92672>:</span> <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isBase64Encoded</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>string</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>queryStringParameters?</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>string</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>WebSocketResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>headers?</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>string</span>&gt;;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>body?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ConnectionData</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roomId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectedAt</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastSeenAt</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ipAddress</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ChatMessage</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>messageType</span>: <span style=color:#66d9ef>MessageType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>editedAt?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>replyToMessageId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ChatRoom</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createdBy</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isPrivate</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>members</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastMessageAt?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastMessagePreview?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>MessageType</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TEXT</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TEXT&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IMAGE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;IMAGE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FILE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FILE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SYSTEM</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SYSTEM&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TYPING</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TYPING&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>WebSocketAction</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>JOIN_ROOM</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;joinRoom&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LEAVE_ROOM</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;leaveRoom&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SEND_MESSAGE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;sendMessage&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>EDIT_MESSAGE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;editMessage&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DELETE_MESSAGE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;deleteMessage&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TYPING_START</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;typingStart&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TYPING_STOP</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;typingStop&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LIST_ROOMS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;listRooms&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CREATE_ROOM</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;createRoom&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GET_ROOM_HISTORY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;getRoomHistory&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>WebSocketMessage</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>WebSocketAction</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>WebSocketBroadcast</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;message&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;user_joined&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;user_left&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;typing&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;room_update&#39;</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roomId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>excludeConnectionId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=connection-management-service>Connection Management Service</h2><div class=plantuml-container><img id=plantuml-connection-lifecycle class=plantuml-diagram>
<a id=plantuml-link-connection-lifecycle href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>🔍</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-connection-lifecycle"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-connection-lifecycle");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml Connection Lifecycle
!define RECTANGLE class

participant "Client" as client
participant "API Gateway" as apigw
participant "Connect Handler" as connect
participant "Message Handler" as message
participant "Disconnect Handler" as disconnect
participant "DynamoDB" as dynamo
participant "Broadcast Service" as broadcast

client -> apigw : WebSocket Connect
apigw -> connect : $connect route
connect -> dynamo : Store connection data
connect -> broadcast : Notify room of new user
connect --> client : Connection established

loop Active Session
  client -> apigw : Send message
  apigw -> message : Route message
  message -> dynamo : Store message
  message -> broadcast : Send to room members
  broadcast --> client : Real-time delivery
end

client -> apigw : WebSocket Disconnect
apigw -> disconnect : $disconnect route
disconnect -> dynamo : Remove connection
disconnect -> broadcast : Notify room of user leaving
@enduml
`)</script><p>Implement robust connection management with DynamoDB storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/services/connection-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DynamoDBClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DynamoDBDocumentClient</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>PutCommand</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GetCommand</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DeleteCommand</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>QueryCommand</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UpdateCommand</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/lib-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ConnectionData</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../types/websocket&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ConnectionService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>docClient</span>: <span style=color:#66d9ef>DynamoDBDocumentClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>tableName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>tableName</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DynamoDBDocumentClient</span>.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DynamoDBClient</span>({}));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tableName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tableName</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>saveConnection</span>(<span style=color:#a6e22e>connectionData</span>: <span style=color:#66d9ef>ConnectionData</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`USER#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>connectedAt</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi2pk</span>: <span style=color:#66d9ef>connectionData.roomId</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi2sk</span>: <span style=color:#66d9ef>connectionData.roomId</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionData</span>.<span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>undefined</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entityType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;CONNECTION&#39;</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>connectionData</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ttl</span>: <span style=color:#66d9ef>Math.floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>+</span> (<span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>) <span style=color:#75715e>// 24 hours TTL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getConnection</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ConnectionData</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Item</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Item</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToConnection</span>(<span style=color:#a6e22e>Item</span>) <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>deleteConnection</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DeleteCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateConnectionRoom</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updateExpression</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>roomId</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;SET roomId = :roomId, gsi2pk = :gsi2pk, gsi2sk = :gsi2sk, lastSeenAt = :lastSeenAt&#39;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SET lastSeenAt = :lastSeenAt REMOVE roomId, gsi2pk, gsi2sk&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>attributeValues</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt; <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;:lastSeenAt&#39;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>      Object.<span style=color:#a6e22e>assign</span>(<span style=color:#a6e22e>attributeValues</span>, {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:roomId&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>roomId</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:gsi2pk&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:gsi2sk&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UpdateCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`CONNECTION#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UpdateExpression</span>: <span style=color:#66d9ef>updateExpression</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span>: <span style=color:#66d9ef>attributeValues</span>
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getConnectionsByRoom</span>(<span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ConnectionData</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Items</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>IndexName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GSI2&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeyConditionExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gsi2pk = :roomPk&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#39;:roomPk&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Items</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToConnection</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getConnectionsByUser</span>(<span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ConnectionData</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Items</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>IndexName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GSI1&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeyConditionExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gsi1pk = :userPk&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> { <span style=color:#e6db74>&#39;:userPk&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`USER#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Items</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToConnection</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>mapItemToConnection</span>(<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>ConnectionData</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>item.connectionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>item.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>item.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>item.roomId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connectedAt</span>: <span style=color:#66d9ef>item.connectedAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastSeenAt</span>: <span style=color:#66d9ef>item.lastSeenAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>item.userAgent</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ipAddress</span>: <span style=color:#66d9ef>item.ipAddress</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=websocket-communication-service>WebSocket Communication Service</h2><p>Create a service for sending messages to WebSocket connections:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/services/websocket-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ApiGatewayManagementApiClient</span>, <span style=color:#a6e22e>PostToConnectionCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-apigatewaymanagementapi&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ConnectionService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;./connection-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketBroadcast</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../types/websocket&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WebSocketService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>apiGatewayClient</span>: <span style=color:#66d9ef>ApiGatewayManagementApiClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>connectionService</span>: <span style=color:#66d9ef>ConnectionService</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>endpoint</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>connectionService</span>: <span style=color:#66d9ef>ConnectionService</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>apiGatewayClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ApiGatewayManagementApiClient</span>({ <span style=color:#a6e22e>endpoint</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connectionService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connectionService</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendToConnection</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>apiGatewayClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PostToConnectionCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ConnectionId</span>: <span style=color:#66d9ef>connectionId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Data</span>: <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to send to </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Clean up stale connections (410 Gone)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>410</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>deleteConnection</span>(<span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>broadcastToRoom</span>(<span style=color:#a6e22e>broadcast</span>: <span style=color:#66d9ef>WebSocketBroadcast</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>{ <span style=color:#a6e22e>successful</span>: <span style=color:#66d9ef>number</span>; <span style=color:#a6e22e>failed</span>: <span style=color:#66d9ef>number</span> }<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>broadcast</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Room ID required for room broadcasts&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connections</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>getConnectionsByRoom</span>(<span style=color:#a6e22e>broadcast</span>.<span style=color:#a6e22e>roomId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filteredConnections</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>conn</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>connectionId</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>broadcast</span>.<span style=color:#a6e22e>excludeConnectionId</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>results</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>allSettled</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>filteredConnections</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>connection</span> <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToConnection</span>(<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>connectionId</span>, <span style=color:#a6e22e>broadcast</span>.<span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>successful</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;fulfilled&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    ).<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>successful</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>failed</span>: <span style=color:#66d9ef>filteredConnections.length</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>successful</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>broadcastToUser</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludeConnectionId?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>{ <span style=color:#a6e22e>successful</span>: <span style=color:#66d9ef>number</span>; <span style=color:#a6e22e>failed</span>: <span style=color:#66d9ef>number</span> }<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connections</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>getConnectionsByUser</span>(<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filteredConnections</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connections</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>conn</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>connectionId</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>excludeConnectionId</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>results</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>allSettled</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>filteredConnections</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>connection</span> <span style=color:#f92672>=&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToConnection</span>(<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>connectionId</span>, <span style=color:#a6e22e>data</span>)
</span></span><span style=display:flex><span>      )
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>successful</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;fulfilled&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>value</span>
</span></span><span style=display:flex><span>    ).<span style=color:#a6e22e>length</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>successful</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>failed</span>: <span style=color:#66d9ef>filteredConnections.length</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>successful</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>requestId?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToConnection</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;error&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>requestId?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendToConnection</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;success&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=chat-and-room-management>Chat and Room Management</h2><div class=plantuml-container><img id=plantuml-message-flow class=plantuml-diagram>
<a id=plantuml-link-message-flow href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>🔍</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-message-flow"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-message-flow");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml Message Flow
!define RECTANGLE class

participant "User A" as userA
participant "User B" as userB
participant "WebSocket API" as api
participant "Message Handler" as handler
participant "Chat Service" as chat
participant "DynamoDB" as dynamo
participant "Broadcast Service" as broadcast

userA -> api : Send message to room
api -> handler : Route to message handler
handler -> chat : Store message
chat -> dynamo : Persist message data

handler -> broadcast : Broadcast to room
broadcast -> dynamo : Get room connections
dynamo -> broadcast : Return active connections
broadcast -> api : Send to all connections
api -> userB : Real-time message delivery
api -> userA : Delivery confirmation

note right of chat
  • Message validation
  • Content filtering
  • Thread management
  • Edit/delete support
end note

note right of broadcast
  • Connection filtering
  • Stale connection cleanup
  • Delivery status tracking
  • Error handling
end note
@enduml
`)</script><p>Implement comprehensive chat functionality:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/services/chat-service.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>DynamoDBClient</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/client-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DynamoDBDocumentClient</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>PutCommand</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GetCommand</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>QueryCommand</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UpdateCommand</span>
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;@aws-sdk/lib-dynamodb&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>v4</span> <span style=color:#66d9ef>as</span> <span style=color:#a6e22e>uuidv4</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;uuid&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ChatMessage</span>, <span style=color:#a6e22e>ChatRoom</span>, <span style=color:#a6e22e>MessageType</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../types/websocket&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChatService</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>docClient</span>: <span style=color:#66d9ef>DynamoDBDocumentClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>tableName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>tableName</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>DynamoDBDocumentClient</span>.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>DynamoDBClient</span>({}));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tableName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tableName</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createRoom</span>(<span style=color:#a6e22e>roomData</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>description?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createdBy</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isPrivate</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>members</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  })<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ChatRoom</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roomId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>uuidv4</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>room</span>: <span style=color:#66d9ef>ChatRoom</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>roomData.name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>roomData.description</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdBy</span>: <span style=color:#66d9ef>roomData.createdBy</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>timestamp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isPrivate</span>: <span style=color:#66d9ef>roomData.isPrivate</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>members</span><span style=color:#f92672>:</span> [...<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>([<span style=color:#a6e22e>roomData</span>.<span style=color:#a6e22e>createdBy</span>, ...<span style=color:#a6e22e>roomData</span>.<span style=color:#a6e22e>members</span>])]
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOMS#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomData</span>.<span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;PRIVATE&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PUBLIC&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>timestamp</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entityType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ROOM&#39;</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>room</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>room</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getRoom</span>(<span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ChatRoom</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Item</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Item</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToRoom</span>(<span style=color:#a6e22e>Item</span>) <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>listRooms</span>(<span style=color:#a6e22e>isPrivate</span>: <span style=color:#66d9ef>boolean</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ChatRoom</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Items</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>IndexName</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GSI1&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeyConditionExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;gsi1pk = :roomType&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:roomType&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOMS#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;PRIVATE&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PUBLIC&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Limit</span>: <span style=color:#66d9ef>limit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ScanIndexForward</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Items</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToRoom</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>messageData</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messageType?</span>: <span style=color:#66d9ef>MessageType</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>replyToMessageId?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  })<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ChatMessage</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>messageId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>uuidv4</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>ChatMessage</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>messageData.roomId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>messageData.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>messageData.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>messageData.content</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>messageType</span>: <span style=color:#66d9ef>messageData.messageType</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>MessageType</span>.<span style=color:#a6e22e>TEXT</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>replyToMessageId</span>: <span style=color:#66d9ef>messageData.replyToMessageId</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Item</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageData</span>.<span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`MESSAGE#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>timestamp</span><span style=color:#e6db74>}</span><span style=color:#e6db74>#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`MESSAGE#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>gsi1sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`MESSAGE#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entityType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;MESSAGE&#39;</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>message</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Update room&#39;s last message
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateRoomLastMessage</span>(<span style=color:#a6e22e>messageData</span>.<span style=color:#a6e22e>roomId</span>, <span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>message</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getRoomMessages</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exclusiveStartKey?</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt;
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span><span style=color:#f92672>&lt;</span>{ <span style=color:#a6e22e>messages</span>: <span style=color:#66d9ef>ChatMessage</span>[]; <span style=color:#a6e22e>lastEvaluatedKey?</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>any</span>&gt; }<span style=color:#f92672>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Items</span>, <span style=color:#a6e22e>LastEvaluatedKey</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QueryCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeyConditionExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;pk = :roomPk AND begins_with(sk, :messagePrefix)&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:roomPk&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:messagePrefix&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;MESSAGE#&#39;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Limit</span>: <span style=color:#66d9ef>limit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ScanIndexForward</span>: <span style=color:#66d9ef>false</span>, <span style=color:#75715e>// Latest messages first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>ExclusiveStartKey</span>: <span style=color:#66d9ef>exclusiveStartKey</span>
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>messages</span>: <span style=color:#66d9ef>Items?.map</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToMessage</span>) <span style=color:#f92672>||</span> [],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastEvaluatedKey</span>: <span style=color:#66d9ef>LastEvaluatedKey</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>editMessage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>newContent</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ChatMessage</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#a6e22e>null</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>Attributes</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UpdateCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`MESSAGE#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`MESSAGE#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>messageId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>UpdateExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SET content = :content, editedAt = :editedAt&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ConditionExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;userId = :userId&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;:content&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>newContent</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;:editedAt&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>timestamp</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;:userId&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>userId</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ReturnValues</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ALL_NEW&#39;</span>
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>Attributes</span> <span style=color:#f92672>?</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>mapItemToMessage</span>(<span style=color:#a6e22e>Attributes</span>) <span style=color:#f92672>:</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>name</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;ConditionalCheckFailedException&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Unauthorized to edit this message&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateRoomLastMessage</span>(<span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>ChatMessage</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>preview</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>100</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>?</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>100</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>...`</span> 
</span></span><span style=display:flex><span>      <span style=color:#f92672>:</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>content</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>docClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UpdateCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>TableName</span>: <span style=color:#66d9ef>this.tableName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>pk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>sk</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`ROOM#</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>roomId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>UpdateExpression</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SET lastMessageAt = :timestamp, lastMessagePreview = :preview&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ExpressionAttributeValues</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:timestamp&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>timestamp</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;:preview&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>username</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>preview</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>mapItemToRoom</span>(<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>ChatRoom</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>item.roomId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>item.name</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>item.description</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdBy</span>: <span style=color:#66d9ef>item.createdBy</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>item.createdAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isPrivate</span>: <span style=color:#66d9ef>item.isPrivate</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>members</span>: <span style=color:#66d9ef>item.members</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastMessageAt</span>: <span style=color:#66d9ef>item.lastMessageAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastMessagePreview</span>: <span style=color:#66d9ef>item.lastMessagePreview</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>mapItemToMessage</span>(<span style=color:#a6e22e>item</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>ChatMessage</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>item.messageId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>item.roomId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>item.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>item.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>item.content</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>messageType</span>: <span style=color:#66d9ef>item.messageType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>item.timestamp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>editedAt</span>: <span style=color:#66d9ef>item.editedAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>replyToMessageId</span>: <span style=color:#66d9ef>item.replyToMessageId</span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=websocket-lambda-handlers>WebSocket Lambda Handlers</h2><p>Implement the Lambda functions that handle WebSocket events:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/handlers/websocket/connect.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketEvent</span>, <span style=color:#a6e22e>WebSocketResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../types/websocket&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ConnectionService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/connection-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connectionService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConnectionService</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TABLE_NAME</span><span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>WebSocketEvent</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>WebSocketResponse</span>&gt; <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket connection event:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>event</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>connectionId</span>, <span style=color:#a6e22e>authorizer</span>, <span style=color:#a6e22e>identity</span>, <span style=color:#a6e22e>requestTime</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>requestContext</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authorizer</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>authorizer</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>authorizer</span>.<span style=color:#a6e22e>username</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Missing authorization data&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>401</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connectionData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connectionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>authorizer.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>authorizer.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>connectedAt</span>: <span style=color:#66d9ef>requestTime</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastSeenAt</span>: <span style=color:#66d9ef>requestTime</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>identity.userAgent</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ipAddress</span>: <span style=color:#66d9ef>identity.sourceIp</span>,
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>saveConnection</span>(<span style=color:#a6e22e>connectionData</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Connection </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> saved for user </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>authorizer</span>.<span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>200</span> };
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error handling connection:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>500</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/handlers/websocket/disconnect.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketEvent</span>, <span style=color:#a6e22e>WebSocketResponse</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../types/websocket&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ConnectionService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/connection-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/websocket-service&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connectionService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConnectionService</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TABLE_NAME</span><span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>websocketService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocketService</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>`https://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>API_ID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.execute-api.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>REGION</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.amazonaws.com/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>STAGE</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionService</span>
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>WebSocketEvent</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>WebSocketResponse</span>&gt; <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket disconnect event:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>event</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>connectionId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>requestContext</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get connection data before deleting
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>getConnection</span>(<span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connection</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Notify room members that user left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user_left&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>connection.username</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>leftAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>connection.roomId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>excludeConnectionId</span>: <span style=color:#66d9ef>connectionId</span>,
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove connection from database
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>deleteConnection</span>(<span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Connection </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>connectionId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> removed`</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>200</span> };
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error handling disconnection:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>500</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// src/handlers/websocket/message.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketEvent</span>, <span style=color:#a6e22e>WebSocketResponse</span>, <span style=color:#a6e22e>WebSocketMessage</span>, <span style=color:#a6e22e>WebSocketAction</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../types/websocket&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ConnectionService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/connection-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ChatService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/chat-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>WebSocketService</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../services/websocket-service&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>MessageType</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;../../types/websocket&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connectionService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ConnectionService</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TABLE_NAME</span><span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ChatService</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>TABLE_NAME</span><span style=color:#f92672>!</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>websocketService</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocketService</span>(
</span></span><span style=display:flex><span>  <span style=color:#e6db74>`https://</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>API_ID</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.execute-api.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>REGION</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.amazonaws.com/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>STAGE</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionService</span>
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>WebSocketEvent</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>WebSocketResponse</span>&gt; <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket message event:&#39;</span>, <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>event</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>2</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>connectionId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>requestContext</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>body</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message body is required&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>400</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>action</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Action is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>400</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>connection</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>getConnection</span>(<span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>connection</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Connection not found&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>404</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleAction</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>200</span> };
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error handling message:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>connectionId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>requestContext</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Internal server error&#39;</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>sendError</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;Error sending error message:&#39;</span>, <span style=color:#a6e22e>sendError</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>500</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleAction</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>action</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.JOIN_ROOM</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleJoinRoom</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.LEAVE_ROOM</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleLeaveRoom</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.SEND_MESSAGE</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleSendMessage</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.EDIT_MESSAGE</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleEditMessage</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.DELETE_MESSAGE</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleDeleteMessage</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.LIST_ROOMS</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleListRooms</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.CREATE_ROOM</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleCreateRoom</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.GET_ROOM_HISTORY</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleGetRoomHistory</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.TYPING_START</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>WebSocketAction.TYPING_STOP</span>:
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>handleTypingIndicator</span>(<span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>connection</span>, <span style=color:#a6e22e>connectionId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>`Unknown action: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>action</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleJoinRoom</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>roomId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Room ID is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>room</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>getRoom</span>(<span style=color:#a6e22e>roomId</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>room</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Room not found&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check if user has permission to join room
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>room</span>.<span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>room</span>.<span style=color:#a6e22e>members</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Access denied&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Update connection with room info
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>updateConnectionRoom</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#a6e22e>roomId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Notify room members that user joined
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user_joined&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>connection.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>joinedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludeConnectionId</span>: <span style=color:#66d9ef>connectionId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Send success response with room info
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>room</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Successfully joined room&#39;</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleLeaveRoom</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Not currently in a room&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>roomId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Update connection to remove room
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>connectionService</span>.<span style=color:#a6e22e>updateConnectionRoom</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Notify room members that user left
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;user_left&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>connection.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>leftAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludeConnectionId</span>: <span style=color:#66d9ef>connectionId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Successfully left room&#39;</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleSendMessage</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>content</span>, <span style=color:#a6e22e>messageType</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>MessageType</span>.<span style=color:#a6e22e>TEXT</span>, <span style=color:#a6e22e>replyToMessageId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Must be in a room to send messages&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>content</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>trim</span>().<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message content is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chatMessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>sendMessage</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>connection.roomId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>connection.username</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>content.trim</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messageType</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>replyToMessageId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Broadcast message to all room members
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;message&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>chatMessage</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>connection.roomId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Message sent successfully&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>chatMessage.messageId</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleEditMessage</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>messageId</span>, <span style=color:#a6e22e>content</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>messageId</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>content</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message ID and content are required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>editedMessage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>editMessage</span>(<span style=color:#a6e22e>messageId</span>, <span style=color:#a6e22e>content</span>.<span style=color:#a6e22e>trim</span>(), <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>editedMessage</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message not found or access denied&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Broadcast updated message to room members
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;message&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>editedMessage</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>edited</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>editedMessage.roomId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Message edited successfully&#39;</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleDeleteMessage</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>messageId</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>messageId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message ID is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deleted</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>deleteMessage</span>(<span style=color:#a6e22e>messageId</span>, <span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>deleted</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Message not found or access denied&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Broadcast deletion to room members
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;message&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>messageId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>deleted</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>deletedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>connection.roomId</span>,
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Message deleted successfully&#39;</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleListRooms</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>isPrivate</span>, <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span> <span style=color:#f92672>||</span> {};
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rooms</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>listRooms</span>(<span style=color:#a6e22e>isPrivate</span>, <span style=color:#a6e22e>limit</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>rooms</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleCreateRoom</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>description</span>, <span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>members</span> <span style=color:#f92672>=</span> [] } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>name</span>.<span style=color:#a6e22e>trim</span>().<span style=color:#a6e22e>length</span> <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Room name is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>room</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>createRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>name.trim</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>description?.trim</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>createdBy</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>isPrivate</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>members</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>room</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Room created successfully&#39;</span>,
</span></span><span style=display:flex><span>  }, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleGetRoomHistory</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>roomId</span>, <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>, <span style=color:#a6e22e>exclusiveStartKey</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Room ID is required&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>room</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>getRoom</span>(<span style=color:#a6e22e>roomId</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>room</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Room not found&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Check access permissions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>room</span>.<span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>room</span>.<span style=color:#a6e22e>members</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>userId</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendError</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#e6db74>&#39;Access denied&#39;</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>history</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>chatService</span>.<span style=color:#a6e22e>getRoomHistory</span>(<span style=color:#a6e22e>roomId</span>, <span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>exclusiveStartKey</span>);
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>sendSuccess</span>(<span style=color:#a6e22e>connectionId</span>, <span style=color:#a6e22e>history</span>, <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>handleTypingIndicator</span>(
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>WebSocketMessage</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connection</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connectionId</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>connection</span>.<span style=color:#a6e22e>roomId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>; <span style=color:#75715e>// Silently ignore if not in a room
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isTyping</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>action</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>WebSocketAction</span>.<span style=color:#a6e22e>TYPING_START</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>websocketService</span>.<span style=color:#a6e22e>broadcastToRoom</span>({
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;typing&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>connection.userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>connection.username</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isTyping</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>(),
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>connection.roomId</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>excludeConnectionId</span>: <span style=color:#66d9ef>connectionId</span>,
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=sam-template-for-websocket-api>SAM Template for WebSocket API</h2><p>Create the infrastructure template:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e># template.yaml</span>
</span></span><span style=display:flex><span><span style=color:#f92672>AWSTemplateFormatVersion</span>: <span style=color:#e6db74>&#39;2010-09-09&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>Transform</span>: <span style=color:#ae81ff>AWS::Serverless-2016-10-31</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>Parameters</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Stage</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>String</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Default</span>: <span style=color:#ae81ff>dev</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Description</span>: <span style=color:#ae81ff>API Gateway deployment stage</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>Globals</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Function</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Timeout</span>: <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Runtime</span>: <span style=color:#ae81ff>nodejs18.x</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Environment</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Variables</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>TABLE_NAME</span>: !<span style=color:#ae81ff>Ref ChatTable</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>STAGE</span>: !<span style=color:#ae81ff>Ref Stage</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>Resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#75715e># WebSocket API</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ChatWebSocketApi</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Api</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Name</span>: !<span style=color:#ae81ff>Sub &#34;chat-websocket-${Stage}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ProtocolType</span>: <span style=color:#ae81ff>WEBSOCKET</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>RouteSelectionExpression</span>: <span style=color:#e6db74>&#34;$request.body.action&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># WebSocket API Stage</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ChatWebSocketStage</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Stage</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>StageName</span>: !<span style=color:#ae81ff>Ref Stage</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AutoDeploy</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># DynamoDB Table</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ChatTable</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::DynamoDB::Table</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>TableName</span>: !<span style=color:#ae81ff>Sub &#34;chat-table-${Stage}&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>BillingMode</span>: <span style=color:#ae81ff>PAY_PER_REQUEST</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AttributeDefinitions</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>pk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>sk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi1pk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi1sk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi2pk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi2sk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>AttributeType</span>: <span style=color:#ae81ff>S</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>KeySchema</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>pk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>HASH</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>sk</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>RANGE</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>GlobalSecondaryIndexes</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>IndexName</span>: <span style=color:#ae81ff>GSI1</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KeySchema</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi1pk</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>HASH</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi1sk</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>RANGE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>Projection</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ProjectionType</span>: <span style=color:#ae81ff>ALL</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>IndexName</span>: <span style=color:#ae81ff>GSI2</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>KeySchema</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi2pk</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>HASH</span>
</span></span><span style=display:flex><span>            - <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>gsi2sk</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>KeyType</span>: <span style=color:#ae81ff>RANGE</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>Projection</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>ProjectionType</span>: <span style=color:#ae81ff>ALL</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>TimeToLiveSpecification</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>AttributeName</span>: <span style=color:#ae81ff>ttl</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>Enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Lambda Functions</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ConnectFunction</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Serverless::Function</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>CodeUri</span>: <span style=color:#ae81ff>dist/</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Handler</span>: <span style=color:#ae81ff>handlers/websocket/connect.handler</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Environment</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>Variables</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>API_ID</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>REGION</span>: !<span style=color:#ae81ff>Ref AWS::Region</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Policies</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>DynamoDBCrudPolicy</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>TableName</span>: !<span style=color:#ae81ff>Ref ChatTable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DisconnectFunction</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Serverless::Function</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>CodeUri</span>: <span style=color:#ae81ff>dist/</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Handler</span>: <span style=color:#ae81ff>handlers/websocket/disconnect.handler</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Environment</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>Variables</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>API_ID</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>REGION</span>: !<span style=color:#ae81ff>Ref AWS::Region</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Policies</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>DynamoDBCrudPolicy</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>TableName</span>: !<span style=color:#ae81ff>Ref ChatTable</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>execute-api:ManageConnections</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>Resource</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ChatWebSocketApi}/${Stage}/POST/@connections/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>MessageFunction</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Serverless::Function</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>CodeUri</span>: <span style=color:#ae81ff>dist/</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Handler</span>: <span style=color:#ae81ff>handlers/websocket/message.handler</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Environment</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>Variables</span>:
</span></span><span style=display:flex><span>          <span style=color:#f92672>API_ID</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>          <span style=color:#f92672>REGION</span>: !<span style=color:#ae81ff>Ref AWS::Region</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Policies</span>:
</span></span><span style=display:flex><span>        - <span style=color:#f92672>DynamoDBCrudPolicy</span>:
</span></span><span style=display:flex><span>            <span style=color:#f92672>TableName</span>: !<span style=color:#ae81ff>Ref ChatTable</span>
</span></span><span style=display:flex><span>        - <span style=color:#f92672>Statement</span>:
</span></span><span style=display:flex><span>            - <span style=color:#f92672>Effect</span>: <span style=color:#ae81ff>Allow</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>Action</span>:
</span></span><span style=display:flex><span>                - <span style=color:#ae81ff>execute-api:ManageConnections</span>
</span></span><span style=display:flex><span>              <span style=color:#f92672>Resource</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ChatWebSocketApi}/${Stage}/POST/@connections/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># WebSocket Routes</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ConnectRoute</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Route</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>RouteKey</span>: <span style=color:#ae81ff>$connect</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AuthorizationType</span>: <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Target</span>: !<span style=color:#ae81ff>Join [&#39;/&#39;, [&#39;integrations&#39;, !Ref ConnectIntegration]]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DisconnectRoute</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Route</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>RouteKey</span>: <span style=color:#ae81ff>$disconnect</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AuthorizationType</span>: <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Target</span>: !<span style=color:#ae81ff>Join [&#39;/&#39;, [&#39;integrations&#39;, !Ref DisconnectIntegration]]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DefaultRoute</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Route</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>RouteKey</span>: <span style=color:#ae81ff>$default</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>AuthorizationType</span>: <span style=color:#ae81ff>NONE</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Target</span>: !<span style=color:#ae81ff>Join [&#39;/&#39;, [&#39;integrations&#39;, !Ref MessageIntegration]]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Integrations</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ConnectIntegration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Integration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationType</span>: <span style=color:#ae81ff>AWS_PROXY</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationUri</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${ConnectFunction.Arn}/invocations&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DisconnectIntegration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Integration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationType</span>: <span style=color:#ae81ff>AWS_PROXY</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationUri</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${DisconnectFunction.Arn}/invocations&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>MessageIntegration</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::ApiGatewayV2::Integration</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>ApiId</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationType</span>: <span style=color:#ae81ff>AWS_PROXY</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>IntegrationUri</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${MessageFunction.Arn}/invocations&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e># Lambda Permissions</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ConnectPermission</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Lambda::Permission</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Action</span>: <span style=color:#ae81ff>lambda:InvokeFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>FunctionName</span>: !<span style=color:#ae81ff>Ref ConnectFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Principal</span>: <span style=color:#ae81ff>apigateway.amazonaws.com</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>SourceArn</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ChatWebSocketApi}/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>DisconnectPermission</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Lambda::Permission</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Action</span>: <span style=color:#ae81ff>lambda:InvokeFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>FunctionName</span>: !<span style=color:#ae81ff>Ref DisconnectFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Principal</span>: <span style=color:#ae81ff>apigateway.amazonaws.com</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>SourceArn</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ChatWebSocketApi}/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>MessagePermission</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Type</span>: <span style=color:#ae81ff>AWS::Lambda::Permission</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Properties</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Action</span>: <span style=color:#ae81ff>lambda:InvokeFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>FunctionName</span>: !<span style=color:#ae81ff>Ref MessageFunction</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>Principal</span>: <span style=color:#ae81ff>apigateway.amazonaws.com</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>SourceArn</span>: !<span style=color:#ae81ff>Sub &#34;arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${ChatWebSocketApi}/*&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>Outputs</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>WebSocketUrl</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Description</span>: <span style=color:#e6db74>&#34;WebSocket API URL&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Value</span>: !<span style=color:#ae81ff>Sub &#34;wss://${ChatWebSocketApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}&#34;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#f92672>TableName</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Description</span>: <span style=color:#e6db74>&#34;DynamoDB table name&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Value</span>: !<span style=color:#ae81ff>Ref ChatTable</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ApiId</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Description</span>: <span style=color:#e6db74>&#34;WebSocket API ID&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Value</span>: !<span style=color:#ae81ff>Ref ChatWebSocketApi</span>
</span></span></code></pre></div><h2 id=client-side-typescript-integration>Client-Side TypeScript Integration</h2><p>Create a TypeScript client for WebSocket communication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// client/websocket-client.ts
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ChatWebSocketClient</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ws</span>: <span style=color:#66d9ef>WebSocket</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>reconnectAttempts</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>maxReconnectAttempts</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>reconnectDelay</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>pingInterval</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>messageHandlers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#a6e22e>any</span><span style=color:#960050;background-color:#1e0010>)</span> <span style=color:#960050;background-color:#1e0010>=</span>&gt; <span style=color:#66d9ef>void</span><span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>requestHandlers</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>&lt;<span style=color:#f92672>string</span>, { <span style=color:#a6e22e>resolve</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#960050;background-color:#1e0010>(</span><span style=color:#a6e22e>data</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#a6e22e>any</span><span style=color:#960050;background-color:#1e0010>)</span> <span style=color:#960050;background-color:#1e0010>=</span>&gt; <span style=color:#66d9ef>void</span>; <span style=color:#a6e22e>reject</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span> }<span style=color:#f92672>&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>url</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>url</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>url</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>token?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>wsUrl</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>token</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>url</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?authorization=</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>token</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span> <span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>url</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WebSocket</span>(<span style=color:#a6e22e>wsUrl</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onopen</span> <span style=color:#f92672>=</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket connected&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reconnectAttempts</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>startPing</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>();
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onmessage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleMessage</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>));
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onclose</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>event</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;WebSocket disconnected:&#39;</span>, <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>code</span>, <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stopPing</span>();
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>wasClean</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reconnectAttempts</span> <span style=color:#f92672>&lt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>maxReconnectAttempts</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reconnectAttempts</span><span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>          }, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reconnectDelay</span> <span style=color:#f92672>*</span> Math.<span style=color:#a6e22e>pow</span>(<span style=color:#ae81ff>2</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reconnectAttempts</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>onerror</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>error</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>&#39;WebSocket error:&#39;</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>disconnect</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>stopPing</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>close</span>(<span style=color:#ae81ff>1000</span>, <span style=color:#e6db74>&#39;Client disconnect&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sendMessage</span>(<span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>WebSocket</span>.<span style=color:#a6e22e>OPEN</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;WebSocket not connected&#39;</span>));
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>generateId</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>message</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>,
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>requestId</span>, { <span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span> });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>message</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Timeout after 30 seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>requestId</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Request timeout&#39;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }, <span style=color:#ae81ff>30000</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>onMessage</span>(<span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>handler</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>data</span>: <span style=color:#66d9ef>any</span>) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>void</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>messageHandlers</span>.<span style=color:#66d9ef>set</span>(<span style=color:#66d9ef>type</span>, <span style=color:#a6e22e>handler</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>offMessage</span>(<span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>messageHandlers</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#66d9ef>type</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Convenience methods
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>joinRoom</span>(<span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;joinRoom&#39;</span>, { <span style=color:#a6e22e>roomId</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>leaveRoom</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;leaveRoom&#39;</span>, {});
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendChatMessage</span>(<span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>replyToMessageId?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;sendMessage&#39;</span>, { <span style=color:#a6e22e>content</span>, <span style=color:#a6e22e>replyToMessageId</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>editMessage</span>(<span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>content</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;editMessage&#39;</span>, { <span style=color:#a6e22e>messageId</span>, <span style=color:#a6e22e>content</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>deleteMessage</span>(<span style=color:#a6e22e>messageId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;deleteMessage&#39;</span>, { <span style=color:#a6e22e>messageId</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createRoom</span>(<span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>description?</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>isPrivate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>members</span>: <span style=color:#66d9ef>string</span>[] <span style=color:#f92672>=</span> [])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;createRoom&#39;</span>, { <span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>description</span>, <span style=color:#a6e22e>isPrivate</span>, <span style=color:#a6e22e>members</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>listRooms</span>(<span style=color:#a6e22e>isPrivate?</span>: <span style=color:#66d9ef>boolean</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;listRooms&#39;</span>, { <span style=color:#a6e22e>isPrivate</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getRoomHistory</span>(<span style=color:#a6e22e>roomId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>50</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMessage</span>(<span style=color:#e6db74>&#39;getRoomHistory&#39;</span>, { <span style=color:#a6e22e>roomId</span>, <span style=color:#a6e22e>limit</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>startTyping</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>WebSocket</span>.<span style=color:#a6e22e>OPEN</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;typingStart&#39;</span>, <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {} }));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>stopTyping</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>WebSocket</span>.<span style=color:#a6e22e>OPEN</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;typingStop&#39;</span>, <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {} }));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>handleMessage</span>(<span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>)<span style=color:#f92672>!</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestHandlers</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>message</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;error&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>error</span>));
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>handler</span>.<span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Handle broadcast messages
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>messageHandlers</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>message</span>.<span style=color:#66d9ef>type</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>handler</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>handler</span>(<span style=color:#a6e22e>message</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>startPing</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pingInterval</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>readyState</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>WebSocket</span>.<span style=color:#a6e22e>OPEN</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ws</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>({ <span style=color:#a6e22e>action</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ping&#39;</span>, <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {} }));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>30000</span>) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>stopPing</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pingInterval</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>clearInterval</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pingInterval</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>pingInterval</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>generateId</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>2</span>) <span style=color:#f92672>+</span> Date.<span style=color:#a6e22e>now</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Building real-time applications with AWS WebSockets and TypeScript creates powerful, scalable communication systems that can handle thousands of concurrent users. The serverless approach eliminates infrastructure management while providing automatic scaling and cost optimization through pay-per-use pricing.</p><p>The patterns demonstrated in this post—from connection management and message routing to room-based broadcasting and typing indicators—provide a solid foundation for building sophisticated real-time applications. The type-safe approach ensures reliability and maintainability as your application scales and evolves.</p><p>This concludes our comprehensive journey through AWS and TypeScript, covering Lambda functions, Step Functions, SNS/SQS messaging, API Gateway, DynamoDB, CDK infrastructure as code, and WebSocket real-time communication. Together, these technologies provide a complete toolkit for building modern, scalable serverless applications that are both powerful and maintainable.</p></div><div class=social-share><h3 class=social-share-title>Share this post</h3><div class=social-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript+-+%3Cp%3EModern+applications+increasingly+demand+real-time+capabilities%E2%80%94from+live+chat+systems+and+collaborative+editing+to+real-time+dashboards+and+gaming.+In+this+%E2%80%A6%3C%2Fp%3E" target=_blank rel="noopener noreferrer" class="social-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
<span>Twitter</span>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="social-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="social-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
<span>Facebook</span>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&title=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="social-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
<span>Reddit</span>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&t=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="social-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
<span>Hacker News</span>
</a><a href="https://wa.me/?text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="social-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
<span>WhatsApp</span>
</a><a href="mailto:?subject=Real-time+Applications+with+AWS+WebSockets+and+TypeScript&body=Check+out+this+article%3A+Real-time+Applications+with+AWS+WebSockets+and+TypeScript+-+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" class="social-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
<span>Email</span>
</a><button type=button class="social-share-button copy-link" data-url=https://scottobert.com/posts/aws-websockets-typescript/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
<span>Copy Link</span></button></div></div><script>(function(){const n=document.querySelectorAll(".copy-link");n.forEach(n=>{n.addEventListener("click",function(){const n=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{t(this)}).catch(()=>{e(n,this)}):e(n,this)})});function e(e,n){const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),t(n)}catch(e){console.error("Fallback: Unable to copy",e),s(n)}document.body.removeChild(o)}function t(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Copied!",e.classList.add("copied"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("copied")},2e3)}function s(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Error",e.classList.add("error"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("error")},2e3)}})()</script><div id=comments-section style="margin-top:2rem;padding-top:2rem;border-top:1px solid #e1e5e9"><h3 style=margin-bottom:1rem;color:#586069>Comments</h3><script src=https://giscus.app/client.js data-repo=scottobert/scottobert.github.io data-repo-id=R_kgDOHRSG6A data-category=General data-category-id=DIC_kwDOHRSG6M4CrQaA data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article><div class=floating-social-share id=floating-share><div class=floating-share-toggle id=share-toggle title="Share this post"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></div><div class=floating-share-buttons id=share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="floating-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="floating-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="floating-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&title=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="floating-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F&t=Real-time+Applications+with+AWS+WebSockets+and+TypeScript" target=_blank rel="noopener noreferrer" class="floating-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=Real-time+Applications+with+AWS+WebSockets+and+TypeScript+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" target=_blank rel="noopener noreferrer" class="floating-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=Real-time+Applications+with+AWS+WebSockets+and+TypeScript&body=Check+out+this+article%3A+Real-time+Applications+with+AWS+WebSockets+and+TypeScript+-+https%3A%2F%2Fscottobert.com%2Fposts%2Faws-websockets-typescript%2F" class="floating-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="floating-share-button copy-link" data-url=https://scottobert.com/posts/aws-websockets-typescript/ title="Copy link">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const s=document.getElementById("floating-share"),t=document.getElementById("share-toggle"),n=document.getElementById("share-buttons");if(!s||!t||!n)return;let e=!1,o;t.addEventListener("click",function(){e=!e,e?(n.classList.add("visible"),t.classList.add("active"),clearTimeout(o)):(n.classList.remove("visible"),t.classList.remove("active"))});function i(){clearTimeout(o),o=setTimeout(()=>{e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)},5e3)}s.addEventListener("mouseenter",()=>{clearTimeout(o)}),s.addEventListener("mouseleave",()=>{e&&i()}),t.addEventListener("click",()=>{e&&i()});let l=0;const d=300;window.addEventListener("scroll",function(){const o=window.pageYOffset||document.documentElement.scrollTop;o>d?s.classList.add("visible"):(s.classList.remove("visible"),e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)),l=o});const a=n.querySelector(".copy-link");a&&a.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{c(this)}).catch(()=>{r(e,this)}):r(e,this)});function r(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),c(t)}catch(e){console.error("Fallback: Unable to copy",e)}document.body.removeChild(n)}function c(e){e.classList.add("copied"),setTimeout(()=>{e.classList.remove("copied")},2e3)}})()</script></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/cross-account-lambda-s3-access/>Cross-Account Lambda Access to S3: A Complete Implementation Guide</a>
<span class=post-date>Jun 19, 2025</span></li><li><a href=/posts/lambda-to-lambda-vs-sns-chaining/>Lambda-to-Lambda Calls vs. SNS Chaining in AWS: When and How to Use Each</a>
<span class=post-date>Jun 19, 2025</span></li><li><a href=/posts/advanced-cloudformation-patterns/>Infrastructure as Code: Advanced CloudFormation Patterns</a>
<span class=post-date>Jun 13, 2025</span></li><li><a href=/posts/reverting-git-commits-safely/>Reverting Git Commits Safely: Undoing Changes Without Losing History</a>
<span class=post-date>Jun 11, 2025</span></li><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/cross-account-lambda-s3-access/>AWS Cross-Account Patterns: Cross-Account Lambda Access to S3: A Complete Implementation Guide</a>
<span class=post-date>Jun 19, 2025</span><div class=series-meta><a href=/series/aws-cross-account-patterns/ class=series-link>View all 1 posts in series →</a></div></li><li><a href=/posts/lambda-to-lambda-vs-sns-chaining/>AWS and Typescript: Lambda-to-Lambda Calls vs. SNS Chaining in AWS: When and How to Use Each</a>
<span class=post-date>Jun 19, 2025</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 8 posts in series →</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series →</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (2)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (10)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/aws>aws (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (23)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/database-design>database design (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/developer-experience>developer experience (1)</a></li><li><a href=/categories/development-tools>development tools (3)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/infrastructure-as-code>infrastructure as code (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/real-time-applications>real-time applications (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (2)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-gateway class=tag-cloud-item style=font-size:1rem>api gateway
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:4rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:2rem>best practices
</a><a href=/tags/cdk class=tag-cloud-item style=font-size:1rem>cdk
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudformation class=tag-cloud-item style=font-size:1rem>cloudformation
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/cross-account class=tag-cloud-item style=font-size:1rem>cross-account
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database class=tag-cloud-item style=font-size:1rem>database
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/debugging-and-troubleshooting class=tag-cloud-item style=font-size:1rem>debugging and troubleshooting
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/git class=tag-cloud-item style=font-size:1rem>git
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/infrastructure class=tag-cloud-item style=font-size:1rem>infrastructure
</a><a href=/tags/infrastructure-as-code class=tag-cloud-item style=font-size:1rem>infrastructure as code
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/rest-api class=tag-cloud-item style=font-size:1rem>rest api
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:3rem>typescript
</a><a href=/tags/version-control class=tag-cloud-item style=font-size:1rem>version control
</a><a href=/tags/websockets class=tag-cloud-item style=font-size:1rem>websockets
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>