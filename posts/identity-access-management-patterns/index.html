<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="Modern cloud-native applications face unprecedented challenges in managing user identities and controlling access to resources. The traditional perimeter-based …"><link rel=canonical href=https://scottobert.com/posts/identity-access-management-patterns/><meta property="og:title" content="Identity and Access Management Patterns in Cloud-Native Applications"><meta property="og:description" content="Modern cloud-native applications face unprecedented challenges in managing user identities and controlling access to resources. The traditional perimeter-based …"><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.com/posts/identity-access-management-patterns/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="Identity and Access Management Patterns in Cloud-Native Applications"><meta name=twitter:description content="Modern cloud-native applications face unprecedented challenges in managing user identities and controlling access to resources. The traditional perimeter-based …"><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><div class=content-layout><main class=main-content><article class=post><h1>Identity and Access Management Patterns in Cloud-Native Applications</h1><div class=post-meta><div class=post-meta-left><span>Jul 6, 2019</span>
<span>| Tags: Security, Identity Management, AWS, TypeScript, Authentication, Authorization</span></div><div class=post-meta-right><div class=quick-social-share><button type=button class=quick-share-toggle id=quick-share-toggle title="Share this post">
<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
<span>Share</span></button><div class=quick-share-buttons id=quick-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="quick-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="quick-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&title=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&t=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="quick-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications&body=Check+out+this+article%3A+Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" class="quick-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="quick-share-button copy-link" data-url=https://scottobert.com/posts/identity-access-management-patterns/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const i=document.querySelector(".quick-social-share"),e=document.getElementById("quick-share-toggle"),t=document.getElementById("quick-share-buttons");if(!i||!e||!t)return;let n=!1;e.addEventListener("click",function(){n=!n,n?(t.classList.add("visible"),e.classList.add("active")):(t.classList.remove("visible"),e.classList.remove("active"))});const a=document.querySelectorAll(".quick-share-button.copy-link");a.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{o(this)}).catch(()=>{s(e,this)}):s(e,this)})});function s(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),o(t)}catch(e){console.error("Fallback: Unable to copy",e),r(t)}document.body.removeChild(n)}function o(e){const n=e.getAttribute("title");e.setAttribute("title","Copied!"),e.classList.add("copied");const t=document.createElement("div");t.textContent="Copied!",t.style.position="absolute",t.style.bottom="100%",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#28a745",t.style.color="white",t.style.padding="4px 8px",t.style.borderRadius="4px",t.style.fontSize="0.75rem",t.style.whiteSpace="nowrap",t.style.zIndex="1000",t.style.marginBottom="5px",e.style.position="relative",e.appendChild(t),setTimeout(()=>{e.setAttribute("title",n),e.classList.remove("copied"),t.parentNode&&e.removeChild(t)},2e3)}function r(e){const t=e.getAttribute("title");e.setAttribute("title","Copy failed"),e.classList.add("error"),setTimeout(()=>{e.setAttribute("title",t),e.classList.remove("error")},2e3)}})()</script></div></div><div class=post-content><p>Modern cloud-native applications face unprecedented challenges in managing user identities and controlling access to resources. The traditional perimeter-based security model has given way to sophisticated identity and access management (IAM) patterns that embrace the distributed nature of cloud architectures. Understanding these patterns is crucial for building secure, scalable applications that can adapt to evolving security requirements while maintaining excellent user experiences.</p><h2 id=the-evolution-of-identity-management>The Evolution of Identity Management</h2><p>Cloud-native applications operate in environments where traditional network boundaries have dissolved. Users access applications from various devices and locations, while applications themselves consist of numerous microservices communicating across network boundaries. This distributed architecture demands identity management solutions that can provide consistent security policies across all components while maintaining the flexibility needed for modern development practices.</p><p>The shift toward cloud-native architectures has fundamentally changed how we approach identity and access management. Instead of relying on network-level controls, modern applications embed identity verification and authorization logic directly into their architecture. This approach ensures that every request is properly authenticated and authorized, regardless of its source or destination within the system.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Modern identity provider integration using AWS Cognito
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>CognitoIdentityProviderClient</span>, <span style=color:#a6e22e>InitiateAuthCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-cognito-identity-provider&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>verify</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;jsonwebtoken&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>jwksClient</span> <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;jwks-rsa&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserIdentity</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>groups</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>permissions</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenExpiry</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CloudNativeIdentityProvider</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>cognitoClient</span>: <span style=color:#66d9ef>CognitoIdentityProviderClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>jwksClient</span>: <span style=color:#66d9ef>jwksClient.JwksClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>userPoolId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>userPoolId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cognitoClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CognitoIdentityProviderClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>userPoolId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userPoolId</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>clientId</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>clientId</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>jwksClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>jwksClient</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jwksUri</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`https://cognito-idp.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>region</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.amazonaws.com/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userPoolId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/.well-known/jwks.json`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cache</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cacheMaxAge</span>: <span style=color:#66d9ef>600000</span>, <span style=color:#75715e>// 10 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>rateLimit</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jwksRequestsPerMinute</span>: <span style=color:#66d9ef>10</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authenticateUser</span>(<span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>password</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>UserIdentity</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>InitiateAuthCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AuthFlow</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;USER_PASSWORD_AUTH&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ClientId</span>: <span style=color:#66d9ef>this.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>AuthParameters</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>USERNAME</span>: <span style=color:#66d9ef>username</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>PASSWORD</span>: <span style=color:#66d9ef>password</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cognitoClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>AuthenticationResult</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>AccessToken</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Authentication failed - no access token received&#34;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateAndParseToken</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>AuthenticationResult</span>.<span style=color:#a6e22e>AccessToken</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Authentication failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateAndParseToken</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>UserIdentity</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSigningKey</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>), {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;RS256&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>issuer</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`https://cognito-idp.us-east-1.amazonaws.com/</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>userPoolId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>audience</span>: <span style=color:#66d9ef>this.clientId</span>
</span></span><span style=display:flex><span>      }, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>payload</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>message</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>));
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;object&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>payload</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>payload.sub</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>payload.email</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>groups</span>: <span style=color:#66d9ef>payload</span>[<span style=color:#e6db74>&#39;cognito:groups&#39;</span>] <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>[] <span style=color:#f92672>||</span> [],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>permissions</span>: <span style=color:#66d9ef>this.extractPermissions</span>(<span style=color:#a6e22e>payload</span>),
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>tokenExpiry</span>: <span style=color:#66d9ef>new</span> Date((<span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>exp</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>number</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reject</span>(<span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#34;Invalid token payload&#34;</span>));
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getSigningKey</span>(<span style=color:#a6e22e>header</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>callback</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>jwksClient</span>.<span style=color:#a6e22e>getSigningKey</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>kid</span>, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>key</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signingKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>getPublicKey</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>signingKey</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>extractPermissions</span>(<span style=color:#a6e22e>payload</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>groups</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>payload</span>[<span style=color:#e6db74>&#39;cognito:groups&#39;</span>] <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>[] <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>scopes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>payload</span>.<span style=color:#a6e22e>scope</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>) <span style=color:#f92672>||</span> [];
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [...<span style=color:#a6e22e>groups</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>group</span> <span style=color:#f92672>=&gt;</span> <span style=color:#e6db74>`group:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>group</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>), ...<span style=color:#a6e22e>scopes</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=attribute-based-access-control-abac>Attribute-Based Access Control (ABAC)</h2><p>Traditional role-based access control (RBAC) systems often prove too rigid for cloud-native applications. Attribute-based access control represents a more flexible approach that considers multiple factors when making authorization decisions. ABAC evaluates user attributes, resource attributes, environmental conditions, and contextual information to determine whether access should be granted.</p><p>The power of ABAC lies in its ability to make nuanced decisions based on dynamic conditions. A user might have different levels of access depending on their location, the time of day, the sensitivity of the data they&rsquo;re requesting, or the security posture of their device. This granular control is essential for applications that handle sensitive data or operate in regulated environments.</p><div class=plantuml-container><img id=plantuml- class=plantuml-diagram>
<a id=plantuml-link- href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>🔍</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml
!define RECTANGLE class

RECTANGLE "Policy Decision Point" as PDP {
  +evaluateRequest(subject, resource, action, environment)
  +combinePermissions(policies[])
}

RECTANGLE "Policy Enforcement Point" as PEP {
  +interceptRequest()
  +enforceDecision()
}

RECTANGLE "Policy Information Point" as PIP {
  +getUserAttributes()
  +getResourceAttributes()
  +getEnvironmentalData()
}

RECTANGLE "Policy Administration Point" as PAP {
  +managePolicies()
  +validateRules()
}

RECTANGLE "Subject" as Subject {
  +userId
  +roles[]
  +department
  +clearanceLevel
  +location
}

RECTANGLE "Resource" as Resource {
  +resourceId
  +classification
  +owner
  +dataType
  +sensitivity
}

RECTANGLE "Environment" as Environment {
  +timestamp
  +location
  +networkSecurity
  +deviceTrust
}

PEP --> PDP : request decision
PDP --> PIP : gather attributes
PIP --> Subject : user attributes
PIP --> Resource : resource attributes
PIP --> Environment : context data
PDP --> PAP : evaluate policies
PDP --> PEP : permit/deny
@enduml
`)</script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Advanced ABAC implementation for cloud-native applications
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccessRequest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>SubjectAttributes</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resource</span>: <span style=color:#66d9ef>ResourceAttributes</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>environment</span>: <span style=color:#66d9ef>EnvironmentAttributes</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SubjectAttributes</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roles</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>department</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clearanceLevel</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>location</span>: <span style=color:#66d9ef>GeographicLocation</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceTrustScore</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ResourceAttributes</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resourceId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>classification</span>: <span style=color:#66d9ef>DataClassification</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>owner</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>dataTypes</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sensitivity</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>EnvironmentAttributes</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sourceIP</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>networkZone</span>: <span style=color:#66d9ef>SecurityZone</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timeOfDay</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>isBusinessHours</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>DataClassification</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>PUBLIC</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PUBLIC&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>INTERNAL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;INTERNAL&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CONFIDENTIAL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CONFIDENTIAL&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>RESTRICTED</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;RESTRICTED&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SecurityZone</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TRUSTED</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TRUSTED&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CORPORATE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CORPORATE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DMZ</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;DMZ&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UNTRUSTED</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UNTRUSTED&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>GeographicLocation</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>country</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>city</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>coordinates</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>latitude</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>longitude</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ABACEngine</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>policies</span>: <span style=color:#66d9ef>AccessPolicy</span>[];
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>attributeProvider</span>: <span style=color:#66d9ef>AttributeProvider</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>attributeProvider</span>: <span style=color:#66d9ef>AttributeProvider</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attributeProvider</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>attributeProvider</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>policies</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>loadPolicies</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authorize</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>AuthorizationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enrich request with additional attributes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enrichedRequest</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>enrichRequest</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Evaluate all applicable policies
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>policyResults</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>all</span>(
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>policies</span>
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>policy</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isPolicyApplicable</span>(<span style=color:#a6e22e>policy</span>, <span style=color:#a6e22e>enrichedRequest</span>))
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>policy</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluatePolicy</span>(<span style=color:#a6e22e>policy</span>, <span style=color:#a6e22e>enrichedRequest</span>))
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Combine results using policy combining algorithm
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>combineResults</span>(<span style=color:#a6e22e>policyResults</span>, <span style=color:#a6e22e>enrichedRequest</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>enrichRequest</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>AccessRequest</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Enhance subject attributes with real-time data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enhancedSubject</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attributeProvider</span>.<span style=color:#a6e22e>enrichSubjectAttributes</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add resource metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enhancedResource</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attributeProvider</span>.<span style=color:#a6e22e>enrichResourceAttributes</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resource</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Calculate environmental context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>enhancedEnvironment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attributeProvider</span>.<span style=color:#a6e22e>enrichEnvironmentAttributes</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>environment</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>request</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>subject</span>: <span style=color:#66d9ef>enhancedSubject</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resource</span>: <span style=color:#66d9ef>enhancedResource</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span>: <span style=color:#66d9ef>enhancedEnvironment</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>evaluatePolicy</span>(<span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>AccessPolicy</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>PolicyResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check if user meets minimum requirements
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkMinimumRequirements</span>(<span style=color:#a6e22e>policy</span>, <span style=color:#a6e22e>request</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Minimum requirements not met&#39;</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Evaluate business rules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>businessRuleResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluateBusinessRules</span>(<span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>rules</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>businessRuleResult</span>.<span style=color:#a6e22e>passed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>, <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>businessRuleResult.reason</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check temporal constraints
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkTemporalConstraints</span>(<span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>temporalConstraints</span>, <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>environment</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Temporal constraints violated&#39;</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Evaluate risk factors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateRiskScore</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>maxRiskThreshold</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Risk score </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>riskScore</span><span style=color:#e6db74>}</span><span style=color:#e6db74> exceeds threshold`</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PERMIT&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Policy evaluation successful&#39;</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;INDETERMINATE&#39;</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Policy evaluation error: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>policy.id</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>calculateRiskScore</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>number</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Location-based risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>networkZone</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>SecurityZone</span>.<span style=color:#a6e22e>UNTRUSTED</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>30</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Time-based risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>isBusinessHours</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>15</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Device trust risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>deviceTrustScore</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0.7</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>25</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Data sensitivity risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>sensitivity</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>7</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cross-border access risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userLocation</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>location</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resourceLocation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>attributeProvider</span>.<span style=color:#a6e22e>getResourceLocation</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>resourceId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>userLocation</span>.<span style=color:#a6e22e>country</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>resourceLocation</span>.<span style=color:#a6e22e>country</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>riskScore</span>, <span style=color:#ae81ff>100</span>); <span style=color:#75715e>// Cap at 100
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>checkMinimumRequirements</span>(<span style=color:#a6e22e>policy</span>: <span style=color:#66d9ef>AccessPolicy</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check clearance level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>clearanceLevel</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>minimumClearance</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check required roles
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasRequiredRole</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>policy</span>.<span style=color:#a6e22e>requiredRoles</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>role</span> <span style=color:#f92672>=&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>.<span style=color:#a6e22e>roles</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>role</span>)
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasRequiredRole</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check data classification compatibility
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>subjectMaxClassification</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getMaxClassificationForUser</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>subject</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>compareClassifications</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>classification</span>, <span style=color:#a6e22e>subjectMaxClassification</span>) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>checkTemporalConstraints</span>(<span style=color:#a6e22e>constraints</span>: <span style=color:#66d9ef>TemporalConstraint</span>[], <span style=color:#a6e22e>environment</span>: <span style=color:#66d9ef>EnvironmentAttributes</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>constraints</span>.<span style=color:#a6e22e>every</span>(<span style=color:#a6e22e>constraint</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>constraint</span>.<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;TIME_OF_DAY&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>timeOfDay</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>constraint</span>.<span style=color:#a6e22e>startHour</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>timeOfDay</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>constraint</span>.<span style=color:#a6e22e>endHour</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;BUSINESS_HOURS&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>isBusinessHours</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>constraint</span>.<span style=color:#a6e22e>required</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;EXPIRY&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>timestamp</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>constraint</span>.<span style=color:#a6e22e>expiryDate</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>combineResults</span>(<span style=color:#a6e22e>results</span>: <span style=color:#66d9ef>PolicyResult</span>[], <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>AuthorizationResult</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implement deny-overrides combining algorithm
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>denyResults</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>decision</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;DENY&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>denyResults</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>denyResults</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>reason</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>riskScore</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>additionalMeasures</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>permitResults</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>decision</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;PERMIT&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>permitResults</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PERMIT&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Access granted by applicable policies&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>riskScore</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>additionalMeasures</span>: <span style=color:#66d9ef>this.determineAdditionalMeasures</span>(<span style=color:#a6e22e>request</span>)
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>decision</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;No applicable policies found&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>additionalMeasures</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>determineAdditionalMeasures</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>SecurityMeasure</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>measures</span>: <span style=color:#66d9ef>SecurityMeasure</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Require MFA for sensitive operations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resource</span>.<span style=color:#a6e22e>sensitivity</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>8</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>measures</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;MFA_REQUIRED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Multi-factor authentication required for highly sensitive resource&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add monitoring for unusual access patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>environment</span>.<span style=color:#a6e22e>networkZone</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>SecurityZone</span>.<span style=color:#a6e22e>TRUSTED</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>measures</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ENHANCED_MONITORING&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Enhanced monitoring enabled for non-trusted network access&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>measures</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=just-in-time-access-patterns>Just-In-Time Access Patterns</h2><p>Just-in-time (JIT) access represents a paradigm shift from permanent privilege assignment to temporary, context-aware access grants. This approach significantly reduces the attack surface by ensuring that users only have access to resources when they specifically need them and only for the duration required to complete their tasks.</p><p>Implementing JIT access requires sophisticated orchestration of identity providers, approval workflows, and automated provisioning systems. The architecture must be capable of rapidly granting access based on predefined criteria while maintaining comprehensive audit trails and automatic revocation mechanisms.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Just-in-time access orchestration system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccessRequest</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resourceId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>justification</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requestedDuration</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// in minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>urgency</span>: <span style=color:#66d9ef>UrgencyLevel</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>businessJustification</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>UrgencyLevel</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LOW</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;LOW&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MEDIUM</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;MEDIUM&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>HIGH</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;HIGH&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CRITICAL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CRITICAL&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ApprovalWorkflow</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>workflowId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>requiredApprovers</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>autoApprovalCriteria?</span>: <span style=color:#66d9ef>AutoApprovalCriteria</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>escalationRules</span>: <span style=color:#66d9ef>EscalationRule</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AutoApprovalCriteria</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxDuration</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedResources</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedUsers</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>timeWindows</span>: <span style=color:#66d9ef>TimeWindow</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>JITAccessOrchestrator</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>accessRequests</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>AccessRequest</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>activeGrants</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>ActiveGrant</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>approvalEngine</span>: <span style=color:#66d9ef>ApprovalEngine</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>provisioningService</span>: <span style=color:#66d9ef>ProvisioningService</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>AuditLogger</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>approvalEngine</span>: <span style=color:#66d9ef>ApprovalEngine</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>provisioningService</span>: <span style=color:#66d9ef>ProvisioningService</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>AuditLogger</span>
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>approvalEngine</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>approvalEngine</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>provisioningService</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>provisioningService</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>auditLogger</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start background cleanup process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>startCleanupProcess</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>requestAccess</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>JITResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateRequest</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>validation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;REJECTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>validation.reason</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>request.requestId</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>accessRequests</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>requestId</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logAccessRequest</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Determine approval workflow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>workflow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>determineWorkflow</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for auto-approval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkAutoApproval</span>(<span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>workflow</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>autoApproveAccess</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initiate approval process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approvalResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>approvalEngine</span>.<span style=color:#a6e22e>initiateApproval</span>(<span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>workflow</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PENDING_APPROVAL&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Request submitted for approval&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>request.requestId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expectedApprovalTime</span>: <span style=color:#66d9ef>approvalResult.estimatedTime</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>approvers</span>: <span style=color:#66d9ef>approvalResult.requiredApprovers</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>approveAccess</span>(<span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>approverId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>comments?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>JITResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>request</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>accessRequests</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>request</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;REJECTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Request not found&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Process approval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approvalResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>approvalEngine</span>.<span style=color:#a6e22e>processApproval</span>(<span style=color:#a6e22e>requestId</span>, <span style=color:#a6e22e>approverId</span>, <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>comments</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>approvalResult</span>.<span style=color:#a6e22e>isComplete</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>approvalResult</span>.<span style=color:#a6e22e>isApproved</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>grantAccess</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PENDING_APPROVAL&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Additional approvals required&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>pendingApprovers</span>: <span style=color:#66d9ef>approvalResult.pendingApprovers</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>autoApproveAccess</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>JITResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grant</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>grantAccess</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logAutoApproval</span>(<span style=color:#a6e22e>request</span>, <span style=color:#e6db74>&#39;Auto-approval criteria met&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>grant</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>requestId</span>, <span style=color:#e6db74>`Auto-approval failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>grantAccess</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>JITResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Calculate actual grant duration (may be less than requested)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grantDuration</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateGrantDuration</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expiryTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>grantDuration</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Provision access
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>provisioningResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>provisioningService</span>.<span style=color:#a6e22e>grantAccess</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>request.userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resourceId</span>: <span style=color:#66d9ef>request.resourceId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>permissions</span>: <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>determinePermissions</span>(<span style=color:#a6e22e>request</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiryTime</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create active grant record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>activeGrant</span>: <span style=color:#66d9ef>ActiveGrant</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>grantId</span>: <span style=color:#66d9ef>provisioningResult.grantId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>request.requestId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>request.userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resourceId</span>: <span style=color:#66d9ef>request.resourceId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>grantedAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>expiryTime</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>permissions</span>: <span style=color:#66d9ef>provisioningResult.permissions</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>autoRevoke</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>activeGrant</span>.<span style=color:#a6e22e>grantId</span>, <span style=color:#a6e22e>activeGrant</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Schedule automatic revocation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleRevocation</span>(<span style=color:#a6e22e>activeGrant</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log successful grant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logAccessGrant</span>(<span style=color:#a6e22e>activeGrant</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GRANTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Access successfully granted&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>request.requestId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>grantId</span>: <span style=color:#66d9ef>activeGrant.grantId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>expiryTime</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>permissions</span>: <span style=color:#66d9ef>provisioningResult.permissions</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>requestId</span>, <span style=color:#e6db74>`Access grant failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;REJECTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Failed to grant access: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>request.requestId</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>calculateGrantDuration</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>AccessRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>number</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get policy-defined maximum duration for this resource
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>maxDuration</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getMaxDurationForResource</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>resourceId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Consider urgency level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>urgencyMultiplier</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getUrgencyMultiplier</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>urgency</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>adjustedMaxDuration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>maxDuration</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>urgencyMultiplier</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return the minimum of requested duration and policy maximum
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>requestedDuration</span>, <span style=color:#a6e22e>adjustedMaxDuration</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>getUrgencyMultiplier</span>(<span style=color:#a6e22e>urgency</span>: <span style=color:#66d9ef>UrgencyLevel</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>urgency</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>UrgencyLevel.LOW</span>: <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.5</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>UrgencyLevel.MEDIUM</span>: <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.75</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>UrgencyLevel.HIGH</span>: <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>UrgencyLevel.CRITICAL</span>: <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1.5</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0.75</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>scheduleRevocation</span>(<span style=color:#a6e22e>grant</span>: <span style=color:#66d9ef>ActiveGrant</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeUntilExpiry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>expiresAt</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setTimeout</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>revokeAccess</span>(<span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>grantId</span>, <span style=color:#e6db74>&#39;Automatic expiration&#39;</span>);
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>timeUntilExpiry</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeAccess</span>(<span style=color:#a6e22e>grantId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grant</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>grantId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>grant</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Grant </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>grantId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> not found`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Revoke access in the target system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>provisioningService</span>.<span style=color:#a6e22e>revokeAccess</span>(<span style=color:#a6e22e>grantId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Remove from active grants
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>grantId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log revocation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logAccessRevocation</span>(<span style=color:#a6e22e>grant</span>, <span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>grantId</span>, <span style=color:#e6db74>`Revocation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>startCleanupProcess</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Run cleanup every 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expiredGrants</span> <span style=color:#f92672>=</span> Array.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#a6e22e>values</span>())
</span></span><span style=display:flex><span>        .<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>grant</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>now</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grant</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>expiredGrants</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>revokeAccess</span>(<span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>grantId</span>, <span style=color:#e6db74>&#39;Cleanup process - expired grant&#39;</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to cleanup expired grant </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>grantId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>); <span style=color:#75715e>// 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getActiveGrants</span>(<span style=color:#a6e22e>userId?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ActiveGrant</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grants</span> <span style=color:#f92672>=</span> Array.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#a6e22e>values</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>grants</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>grant</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>userId</span>) <span style=color:#f92672>:</span> <span style=color:#a6e22e>grants</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>extendAccess</span>(<span style=color:#a6e22e>grantId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>additionalMinutes</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>justification</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>JITResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>grant</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>activeGrants</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>grantId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>grant</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;REJECTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Grant not found&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>grantId</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if extension is allowed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>maxExtension</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getMaxExtensionForResource</span>(<span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>resourceId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>additionalMinutes</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>maxExtension</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;REJECTED&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Extension exceeds maximum allowed duration of </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>maxExtension</span><span style=color:#e6db74>}</span><span style=color:#e6db74> minutes`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>grantId</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Extend the grant
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newExpiryTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>expiresAt</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>additionalMinutes</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60000</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>grant</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>newExpiryTime</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Update the provisioning system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>provisioningService</span>.<span style=color:#a6e22e>extendAccess</span>(<span style=color:#a6e22e>grantId</span>, <span style=color:#a6e22e>newExpiryTime</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log the extension
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logAccessExtension</span>(<span style=color:#a6e22e>grant</span>, <span style=color:#a6e22e>additionalMinutes</span>, <span style=color:#a6e22e>justification</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GRANTED&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Access successfully extended&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>grantId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>newExpiryTime</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=token-based-authentication-strategies>Token-Based Authentication Strategies</h2><p>Modern cloud-native applications rely heavily on token-based authentication mechanisms that provide stateless, scalable identity verification. JSON Web Tokens (JWT) have become the de facto standard for representing claims securely between parties, but their implementation requires careful consideration of security best practices and architectural patterns.</p><p>The evolution of token strategies has moved beyond simple bearer tokens to sophisticated patterns that include refresh token rotation, proof-of-possession tokens, and context-aware token validation. These advanced patterns provide enhanced security while maintaining the performance and scalability benefits that make tokens attractive for distributed systems.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Advanced token management system with security best practices
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TokenClaims</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sub</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Subject (user ID)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>iss</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Issuer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>aud</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Audience
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// Expiration time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>iat</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// Issued at
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>jti</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// JWT ID (unique identifier)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Permissions scope
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>device_id?</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Device identifier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>session_id?</span>: <span style=color:#66d9ef>string</span>; <span style=color:#75715e>// Session identifier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>risk_score?</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// Risk assessment score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TokenPair</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>accessToken</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>refreshToken</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenType</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expiresIn</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DeviceInfo</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceType</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>platform</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>appVersion</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceFingerprint</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecureTokenManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>accessTokenTTL</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>; <span style=color:#75715e>// 15 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>refreshTokenTTL</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>; <span style=color:#75715e>// 7 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>readonly</span> <span style=color:#a6e22e>maxRefreshTokens</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>; <span style=color:#75715e>// Per user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>tokenBlacklist</span>: <span style=color:#66d9ef>Set</span>&lt;<span style=color:#f92672>string</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Set</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>refreshTokenStore</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>RefreshTokenInfo</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>jwtSecret</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>issuer</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>audience</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>encryptionKey</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start cleanup process for expired tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>startTokenCleanup</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateTokenPair</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>string</span>, 
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>deviceInfo</span>: <span style=color:#66d9ef>DeviceInfo</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>riskScore</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenPair</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate unique identifiers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jti</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecureId</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sessionId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecureId</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshTokenId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecureId</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create access token claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>accessTokenClaims</span>: <span style=color:#66d9ef>TokenClaims</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sub</span>: <span style=color:#66d9ef>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iss</span>: <span style=color:#66d9ef>this.issuer</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>aud</span>: <span style=color:#66d9ef>this.audience</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>Math.floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>accessTokenTTL</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>iat</span>: <span style=color:#66d9ef>Math.floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jti</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scope</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>device_id</span>: <span style=color:#66d9ef>deviceInfo.deviceId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>session_id</span>: <span style=color:#66d9ef>sessionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>risk_score</span>: <span style=color:#66d9ef>riskScore</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate access token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>accessToken</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createSignedToken</span>(<span style=color:#a6e22e>accessTokenClaims</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create refresh token with encrypted payload
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshTokenPayload</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>user_id</span>: <span style=color:#66d9ef>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>session_id</span>: <span style=color:#66d9ef>sessionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>device_id</span>: <span style=color:#66d9ef>deviceInfo.deviceId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scope</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>Math.floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenTTL</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jti</span>: <span style=color:#66d9ef>refreshTokenId</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshToken</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createEncryptedRefreshToken</span>(<span style=color:#a6e22e>refreshTokenPayload</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store refresh token metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>storeRefreshToken</span>(<span style=color:#a6e22e>refreshTokenId</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deviceInfo</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sessionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenTTL</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastUsed</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cleanup old refresh tokens for this user/device
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupOldRefreshTokens</span>(<span style=color:#a6e22e>userId</span>, <span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>accessToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refreshToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tokenType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Bearer&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expiresIn</span>: <span style=color:#66d9ef>this.accessTokenTTL</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scope</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateAccessToken</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>requiredScope?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenValidationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check if token is blacklisted
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenBlacklist</span>.<span style=color:#a6e22e>has</span>(<span style=color:#a6e22e>token</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Token has been revoked&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Verify and decode token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>claims</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>verifySignedToken</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Additional security checks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityChecks</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performSecurityChecks</span>(<span style=color:#a6e22e>claims</span>, <span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>securityChecks</span>.<span style=color:#a6e22e>passed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>securityChecks.reason</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check scope if required
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>requiredScope</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>hasRequiredScope</span>(<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scope</span>, <span style=color:#a6e22e>requiredScope</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Insufficient scope&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Token is valid&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>claims</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Token validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>null</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>refreshTokenPair</span>(<span style=color:#a6e22e>refreshToken</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>deviceInfo</span>: <span style=color:#66d9ef>DeviceInfo</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenPair</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Decrypt and validate refresh token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshPayload</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>decryptRefreshToken</span>(<span style=color:#a6e22e>refreshToken</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Get refresh token info from store
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>refreshPayload</span>.<span style=color:#a6e22e>jti</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>tokenInfo</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>isActive</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Refresh token not found or inactive&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate device consistency
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceId</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceId</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Device mismatch - possible token theft
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>revokeAllUserTokens</span>(<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>userId</span>, <span style=color:#e6db74>&#39;Device mismatch detected&#39;</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Device validation failed&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check if refresh token is expired
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#66d9ef>new</span> Date()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Refresh token expired&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Update last used timestamp
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>lastUsed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Calculate new risk score based on usage patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateRefreshRiskScore</span>(<span style=color:#a6e22e>tokenInfo</span>, <span style=color:#a6e22e>deviceInfo</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate new token pair
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newTokenPair</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateTokenPair</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>refreshPayload</span>.<span style=color:#a6e22e>scope</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>deviceInfo</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>riskScore</span>
</span></span><span style=display:flex><span>      );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Optionally rotate refresh token for high-risk scenarios
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>70</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>revokeRefreshToken</span>(<span style=color:#a6e22e>refreshPayload</span>.<span style=color:#a6e22e>jti</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>newTokenPair</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token refresh failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performSecurityChecks</span>(<span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>TokenClaims</span>, <span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityCheckResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check token age
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenAge</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>iat</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenAge</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>accessTokenTTL</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>passed</span>: <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Token expired&#39;</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Risk score validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>risk_score</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>risk_score</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>90</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>passed</span>: <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Risk score too high&#39;</span> };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for session validity if session management is enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>session_id</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sessionValid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateSession</span>(<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>session_id</span>, <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>sub</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>sessionValid</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>passed</span>: <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Session invalid&#39;</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Device binding validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>device_id</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deviceValid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateDeviceBinding</span>(<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>device_id</span>, <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>sub</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>deviceValid</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>passed</span>: <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Device binding invalid&#39;</span> };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>passed</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;All security checks passed&#39;</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>calculateRefreshRiskScore</span>(<span style=color:#a6e22e>tokenInfo</span>: <span style=color:#66d9ef>RefreshTokenInfo</span>, <span style=color:#a6e22e>deviceInfo</span>: <span style=color:#66d9ef>DeviceInfo</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>number</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Time-based risk factors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeSinceLastUse</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>lastUsed</span>.<span style=color:#a6e22e>getTime</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>timeSinceLastUse</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>) { <span style=color:#75715e>// More than 24 hours
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>20</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Device fingerprint changes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceFingerprint</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceFingerprint</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>30</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Platform/app version changes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>platform</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>platform</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>40</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>appVersion</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>appVersion</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>10</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Frequency analysis
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshFrequency</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>analyzeRefreshFrequency</span>(<span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>refreshFrequency</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10</span>) { <span style=color:#75715e>// More than 10 refreshes per hour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>+=</span> <span style=color:#ae81ff>25</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>riskScore</span>, <span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeToken</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add to blacklist
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenBlacklist</span>.<span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// If it&#39;s a refresh token, mark as inactive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshPayload</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>decryptRefreshToken</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>refreshPayload</span>.<span style=color:#a6e22e>jti</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenInfo</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokenInfo</span>.<span style=color:#a6e22e>isActive</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Not a refresh token, blacklisting is sufficient
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeAllUserTokens</span>(<span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Find all refresh tokens for the user
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userTokens</span> <span style=color:#f92672>=</span> Array.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#a6e22e>entries</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>filter</span>(([<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>info</span>]) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>userId</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Mark all as inactive
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>tokenId</span>, <span style=color:#a6e22e>info</span>] <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>userTokens</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>isActive</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log security event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>warn</span>(<span style=color:#e6db74>`Revoked all tokens for user </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>userId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>reason</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>startTokenCleanup</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Run cleanup every hour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupExpiredTokens</span>();
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>cleanupExpiredTokens</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clean up expired refresh tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>tokenId</span>, <span style=color:#a6e22e>info</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>now</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>tokenId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clean up old blacklisted access tokens (they expire anyway)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This would require more sophisticated tracking in a real implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>cleanupOldRefreshTokens</span>(<span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>deviceId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userDeviceTokens</span> <span style=color:#f92672>=</span> Array.<span style=color:#66d9ef>from</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#a6e22e>entries</span>())
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>filter</span>(([<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>info</span>]) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>userId</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>userId</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>info</span>.<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceId</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>deviceId</span>)
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>sort</span>(([<span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>a</span>], [<span style=color:#a6e22e>__</span>, <span style=color:#a6e22e>b</span>]) <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>createdAt</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>createdAt</span>.<span style=color:#a6e22e>getTime</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Keep only the most recent tokens up to the limit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokensToRemove</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>userDeviceTokens</span>.<span style=color:#a6e22e>slice</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>maxRefreshTokens</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>tokenId</span>] <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>tokensToRemove</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshTokenStore</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>tokenId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Identity and access management in cloud-native applications represents a fundamental shift from traditional security models to dynamic, context-aware systems that can adapt to changing threats and business requirements. The patterns explored in this post demonstrate how modern applications can implement sophisticated security controls while maintaining the flexibility and scalability that cloud-native architectures demand.</p><p>The implementation of these IAM patterns requires careful consideration of the trade-offs between security, usability, and performance. Attribute-based access control provides the granular control needed for complex authorization decisions but introduces complexity in policy management and evaluation. Just-in-time access patterns significantly reduce security risks by minimizing standing privileges but require robust orchestration and approval systems. Advanced token strategies enhance security through multiple layers of validation and risk assessment while maintaining the stateless nature essential for distributed systems.</p><p>As cloud-native applications continue to evolve, IAM systems must adapt to support new architectural patterns, emerging threats, and changing regulatory requirements. Organizations implementing these patterns should focus on creating flexible, extensible systems that can grow with their security needs while providing comprehensive audit capabilities and seamless user experiences. The foundation laid by these identity and access management patterns will prove essential as we explore additional security layers in subsequent posts in this series.</p></div><div class=social-share><h3 class=social-share-title>Share this post</h3><div class=social-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+-+%3Cp%3EModern+cloud-native+applications+face+unprecedented+challenges+in+managing+user+identities+and+controlling+access+to+resources.+The+traditional+perimeter-based+%E2%80%A6%3C%2Fp%3E" target=_blank rel="noopener noreferrer" class="social-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
<span>Twitter</span>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="social-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="social-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
<span>Facebook</span>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&title=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="social-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
<span>Reddit</span>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&t=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="social-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
<span>Hacker News</span>
</a><a href="https://wa.me/?text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="social-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
<span>WhatsApp</span>
</a><a href="mailto:?subject=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications&body=Check+out+this+article%3A+Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" class="social-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
<span>Email</span>
</a><button type=button class="social-share-button copy-link" data-url=https://scottobert.com/posts/identity-access-management-patterns/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
<span>Copy Link</span></button></div></div><script>(function(){const n=document.querySelectorAll(".copy-link");n.forEach(n=>{n.addEventListener("click",function(){const n=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{t(this)}).catch(()=>{e(n,this)}):e(n,this)})});function e(e,n){const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),t(n)}catch(e){console.error("Fallback: Unable to copy",e),s(n)}document.body.removeChild(o)}function t(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Copied!",e.classList.add("copied"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("copied")},2e3)}function s(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Error",e.classList.add("error"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("error")},2e3)}})()</script><div id=comments-section style="margin-top:2rem;padding-top:2rem;border-top:1px solid #e1e5e9"><h3 style=margin-bottom:1rem;color:#586069>Comments</h3><script src=https://giscus.app/client.js data-repo=scottobert/scottobert.github.io data-repo-id=R_kgDOHRSG6A data-category=General data-category-id=DIC_kwDOHRSG6M4CrQaA data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article><div class=floating-social-share id=floating-share><div class=floating-share-toggle id=share-toggle title="Share this post"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></div><div class=floating-share-buttons id=share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="floating-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="floating-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&title=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F&t=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" target=_blank rel="noopener noreferrer" class="floating-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications&body=Check+out+this+article%3A+Identity+and+Access+Management+Patterns+in+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fidentity-access-management-patterns%2F" class="floating-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="floating-share-button copy-link" data-url=https://scottobert.com/posts/identity-access-management-patterns/ title="Copy link">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const s=document.getElementById("floating-share"),t=document.getElementById("share-toggle"),n=document.getElementById("share-buttons");if(!s||!t||!n)return;let e=!1,o;t.addEventListener("click",function(){e=!e,e?(n.classList.add("visible"),t.classList.add("active"),clearTimeout(o)):(n.classList.remove("visible"),t.classList.remove("active"))});function i(){clearTimeout(o),o=setTimeout(()=>{e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)},5e3)}s.addEventListener("mouseenter",()=>{clearTimeout(o)}),s.addEventListener("mouseleave",()=>{e&&i()}),t.addEventListener("click",()=>{e&&i()});let l=0;const d=300;window.addEventListener("scroll",function(){const o=window.pageYOffset||document.documentElement.scrollTop;o>d?s.classList.add("visible"):(s.classList.remove("visible"),e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)),l=o});const a=n.querySelector(".copy-link");a&&a.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{c(this)}).catch(()=>{r(e,this)}):r(e,this)});function r(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),c(t)}catch(e){console.error("Fallback: Unable to copy",e)}document.body.removeChild(n)}function c(e){e.classList.add("copied"),setTimeout(()=>{e.classList.remove("copied")},2e3)}})()</script></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li><li><a href=/posts/using-ai-in-software-engineering/>Harnessing AI in Software Engineering: Opportunities and Challenges</a>
<span class=post-date>May 29, 2025</span></li><li><a href=/posts/aws-serverless-cost-optimization/>Cost Optimization Strategies for AWS Serverless Applications</a>
<span class=post-date>Jun 17, 2023</span></li><li><a href=/posts/aws-sns-sqs-typescript/>Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span></li><li><a href=/posts/securing-aws-lambda/>Securing AWS Lambda Functions: Best Practices and Implementation Guide</a>
<span class=post-date>Apr 7, 2023</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/aws-sns-sqs-typescript/>AWS and Typescript: Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 3 posts in series →</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series →</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (1)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (8)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (16)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/development-tools>development tools (2)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (1)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:3rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:1rem>best practices
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:2rem>typescript
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>