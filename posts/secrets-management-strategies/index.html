<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="The proliferation of microservices and distributed architectures has dramatically increased the complexity of managing sensitive information in cloud-native ‚Ä¶"><link rel=canonical href=https://scottobert.com/posts/secrets-management-strategies/><meta property="og:title" content="Secrets Management Strategies for Cloud-Native Applications"><meta property="og:description" content="The proliferation of microservices and distributed architectures has dramatically increased the complexity of managing sensitive information in cloud-native ‚Ä¶"><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.com/posts/secrets-management-strategies/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="Secrets Management Strategies for Cloud-Native Applications"><meta name=twitter:description content="The proliferation of microservices and distributed architectures has dramatically increased the complexity of managing sensitive information in cloud-native ‚Ä¶"><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><div class=content-layout><main class=main-content><article class=post><h1>Secrets Management Strategies for Cloud-Native Applications</h1><div class=post-meta><span>Jul 27, 2019</span>
<span>| Tags: Security, Secrets Management, AWS, TypeScript, DevOps, Encryption</span></div><div class=post-content><p>The proliferation of microservices and distributed architectures has dramatically increased the complexity of managing sensitive information in cloud-native applications. Database credentials, API keys, encryption keys, and other secrets must be securely stored, distributed, and rotated across potentially hundreds of services and environments. Traditional approaches of hardcoding secrets or storing them in configuration files are not only insecure but fundamentally incompatible with the dynamic nature of cloud-native deployments.</p><p>Modern secrets management requires a comprehensive strategy that addresses the entire lifecycle of sensitive information, from generation and distribution to rotation and revocation. This strategy must account for the ephemeral nature of cloud-native workloads, the need for automated operations, and the security requirements of handling sensitive data across network boundaries.</p><h2 id=the-secrets-management-lifecycle>The Secrets Management Lifecycle</h2><p>Effective secrets management encompasses the complete lifecycle of sensitive information within an organization. This lifecycle begins with the secure generation of secrets using cryptographically secure random number generators and appropriate entropy sources. The generation process must ensure that secrets meet the strength requirements for their intended use and cannot be predicted or reproduced by attackers.</p><p>Once generated, secrets must be securely distributed to the applications and services that require them. This distribution mechanism should minimize exposure during transit and at rest while providing the accessibility needed for automated deployment and scaling operations. The distribution system must also handle the challenge of bootstrapping trust, ensuring that services can authenticate themselves to the secrets management system without creating circular dependencies.</p><div class=plantuml-container><img id=plantuml- class=plantuml-diagram>
<a id=plantuml-link- href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>üîç</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml
!define RECTANGLE class

RECTANGLE "Secrets Vault" as Vault {
  +generateSecret()
  +storeSecret()
  +retrieveSecret()
  +rotateSecret()
  +revokeSecret()
}

RECTANGLE "Secret Generation" as Generation {
  +cryptographicRNG()
  +entropyPool()
  +templateEngine()
  +strengthValidation()
}

RECTANGLE "Distribution Engine" as Distribution {
  +authenticateClient()
  +authorizeAccess()
  +encryptTransport()
  +auditAccess()
}

RECTANGLE "Rotation Scheduler" as Rotation {
  +scheduleRotation()
  +executeRotation()
  +validateNewSecret()
  +rollbackOnFailure()
}

RECTANGLE "Application Service" as App {
  +authenticateToVault()
  +requestSecret()
  +cacheSecret()
  +handleRotation()
}

RECTANGLE "Audit System" as Audit {
  +logAccess()
  +trackUsage()
  +detectAnomalies()
  +generateReports()
}

Generation --> Vault : new secrets
Vault --> Distribution : secure delivery
Distribution --> App : authenticated access
Rotation --> Vault : automated updates
App --> Vault : periodic refresh
Vault --> Audit : activity logs
Distribution --> Audit : access logs
Rotation --> Audit : rotation events
@enduml
`)</script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Comprehensive secrets management system with lifecycle support
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SecretsManagerClient</span>, <span style=color:#a6e22e>GetSecretValueCommand</span>, <span style=color:#a6e22e>CreateSecretCommand</span>, <span style=color:#a6e22e>UpdateSecretCommand</span>, <span style=color:#a6e22e>RotateSecretCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-secrets-manager&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>KMSClient</span>, <span style=color:#a6e22e>EncryptCommand</span>, <span style=color:#a6e22e>DecryptCommand</span>, <span style=color:#a6e22e>GenerateDataKeyCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-kms&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>CloudWatchLogsClient</span>, <span style=color:#a6e22e>PutLogEventsCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-cloudwatch-logs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>randomBytes</span>, <span style=color:#a6e22e>createHash</span>, <span style=color:#a6e22e>createCipher</span>, <span style=color:#a6e22e>createDecipher</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;crypto&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SecretMetadata</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secretName</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>description</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secretType</span>: <span style=color:#66d9ef>SecretType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rotationSchedule?</span>: <span style=color:#66d9ef>RotationSchedule</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>accessPolicy</span>: <span style=color:#66d9ef>AccessPolicy</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>encryptionKeyId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>createdDate</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>lastRotated?</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>nextRotation?</span>: <span style=color:#66d9ef>Date</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tags</span>: <span style=color:#66d9ef>Record</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>string</span>&gt;;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RotationSchedule</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>intervalDays</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>automaticRotation</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rotationWindow</span>: <span style=color:#66d9ef>TimeWindow</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>failureNotification</span>: <span style=color:#66d9ef>NotificationConfig</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccessPolicy</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedServices</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedEnvironments</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedRoles</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>accessPatterns</span>: <span style=color:#66d9ef>AccessPattern</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ipWhitelist?</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AccessPattern</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pattern</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxRequestsPerHour</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>allowedOperations</span>: <span style=color:#66d9ef>SecretOperation</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SecretType</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DATABASE_CREDENTIALS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;DATABASE_CREDENTIALS&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;API_KEY&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ENCRYPTION_KEY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ENCRYPTION_KEY&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CERTIFICATE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CERTIFICATE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>OAUTH_TOKEN</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;OAUTH_TOKEN&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SYMMETRIC_KEY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SYMMETRIC_KEY&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>SecretOperation</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>READ</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;READ&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CREATE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CREATE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>UPDATE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;UPDATE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DELETE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;DELETE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ROTATE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ROTATE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>CloudNativeSecretsManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>secretsClient</span>: <span style=color:#66d9ef>SecretsManagerClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>kmsClient</span>: <span style=color:#66d9ef>KMSClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>CloudWatchLogsClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>secretCache</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>CachedSecret</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>rotationTasks</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>NodeJS.Timeout</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>string</span>, <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>defaultKmsKeyId</span>: <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SecretsManagerClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kmsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>KMSClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CloudWatchLogsClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Initialize automatic cleanup and rotation monitoring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initializeBackgroundTasks</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createSecret</span>(<span style=color:#a6e22e>metadata</span>: <span style=color:#66d9ef>Omit</span>&lt;<span style=color:#f92672>SecretMetadata</span>, <span style=color:#e6db74>&#39;secretId&#39;</span> <span style=color:#960050;background-color:#1e0010>|</span> <span style=color:#e6db74>&#39;createdDate&#39;</span>&gt;)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate unique secret ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecretId</span>(<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>secretName</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate the actual secret value based on type
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecretValue</span>(<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>secretType</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Encrypt the secret value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptSecretValue</span>(<span style=color:#a6e22e>secretValue</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>encryptionKeyId</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>defaultKmsKeyId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create secret in AWS Secrets Manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>createCommand</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>CreateSecretCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>: <span style=color:#66d9ef>secretId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Description</span>: <span style=color:#66d9ef>metadata.description</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SecretString</span>: <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>encryptedValue</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>KmsKeyId</span>: <span style=color:#66d9ef>metadata.encryptionKeyId</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>defaultKmsKeyId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ReplicationRegions</span>: <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getReplicationRegions</span>(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tags</span>: <span style=color:#66d9ef>this.formatTags</span>(<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>tags</span>)
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>createCommand</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Store metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fullMetadata</span>: <span style=color:#66d9ef>SecretMetadata</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>metadata</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>secretId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>createdDate</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>storeSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>fullMetadata</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Schedule rotation if enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>rotationSchedule</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleRotation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>rotationSchedule</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log creation event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>CREATE</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;system&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;create_secret&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>secretType</span>: <span style=color:#66d9ef>metadata.secretType</span>, <span style=color:#a6e22e>hasRotation</span><span style=color:#f92672>:</span> <span style=color:#f92672>!!</span><span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>rotationSchedule</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>enabled</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>secretId</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to create secret: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getSecret</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>requestContext</span>: <span style=color:#66d9ef>SecretRequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecretValue</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate access
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateAccess</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>requestContext</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>READ</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check cache first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cached</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getCachedSecret</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cached</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isCacheExpired</span>(<span style=color:#a6e22e>cached</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>READ</span>, {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>requestContext.userId</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get_secret_cached&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>cacheHit</span>: <span style=color:#66d9ef>true</span> }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Retrieve from AWS Secrets Manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getCommand</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetSecretValueCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SecretId</span>: <span style=color:#66d9ef>secretId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>VersionStage</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AWSCURRENT&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>getCommand</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>SecretString</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Secret value not found&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Decrypt the secret value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedValue</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>SecretString</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decryptedValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>decryptSecretValue</span>(<span style=color:#a6e22e>encryptedValue</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Cache the secret for performance
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheSecret</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>decryptedValue</span>, <span style=color:#a6e22e>requestContext</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log access event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>READ</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>requestContext.userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get_secret&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { 
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>sourceIP</span>: <span style=color:#66d9ef>requestContext.sourceIP</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>requestContext.userAgent</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>cacheHit</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>decryptedValue</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>READ</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>requestContext.userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;get_secret_failed&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to retrieve secret: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>rotateSecret</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>options</span>: <span style=color:#66d9ef>RotationOptions</span> <span style=color:#f92672>=</span> {})<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RotationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metadata</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>metadata</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Secret metadata not found&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Pre-rotation validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateRotationEligibility</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>metadata</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Generate new secret value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newSecretValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSecretValue</span>(<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>secretType</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// For database credentials, test connectivity before rotation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>secretType</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>SecretType</span>.<span style=color:#a6e22e>DATABASE_CREDENTIALS</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateDatabaseConnectivity</span>(<span style=color:#a6e22e>newSecretValue</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Encrypt new value
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedNewValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptSecretValue</span>(<span style=color:#a6e22e>newSecretValue</span>, <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>encryptionKeyId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Initiate rotation in AWS Secrets Manager
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rotateCommand</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RotateSecretCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>SecretId</span>: <span style=color:#66d9ef>secretId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ForceRotateSecretOnUpdate</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>RotationRules</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>AutomaticallyAfterDays</span>: <span style=color:#66d9ef>metadata.rotationSchedule?.intervalDays</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rotationResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>rotateCommand</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Update metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>lastRotated</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>nextRotation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> (<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>rotationSchedule</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>intervalDays</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>30</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>storeSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>metadata</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Invalidate cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>invalidateSecretCache</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Notify dependent services if configured
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>notifyDependentServices</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>false</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>notifyDependentServices</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>metadata</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log rotation event
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>ROTATE</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>options.initiatedBy</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;system&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rotate_secret&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { 
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>automatic</span>: <span style=color:#66d9ef>options.automatic</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>versionId</span>: <span style=color:#66d9ef>rotationResult.VersionId</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>newVersionId</span>: <span style=color:#66d9ef>rotationResult.VersionId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rotatedAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>nextRotation</span>: <span style=color:#66d9ef>metadata.nextRotation</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>ROTATE</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span>: <span style=color:#66d9ef>options.initiatedBy</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;system&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rotate_secret_failed&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rotatedAt</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateSecretValue</span>(<span style=color:#a6e22e>secretType</span>: <span style=color:#66d9ef>SecretType</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecretValue</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>secretType</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecretType.DATABASE_CREDENTIALS</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateDatabaseCredentials</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecretType.API_KEY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateApiKey</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecretType.ENCRYPTION_KEY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateEncryptionKey</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecretType.SYMMETRIC_KEY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateSymmetricKey</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecretType.CERTIFICATE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateCertificate</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateGenericSecret</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateDatabaseCredentials</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretValue</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateStrongPassword</span>(<span style=color:#ae81ff>32</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretType</span>.<span style=color:#a6e22e>DATABASE_CREDENTIALS</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`app_user_</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateRandomString</span>(<span style=color:#ae81ff>8</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>password</span>: <span style=color:#66d9ef>password</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>engine</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;postgres&#39;</span>, <span style=color:#75715e>// This would be configurable
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>host</span>: <span style=color:#66d9ef>process.env.DB_HOST</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>5432</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dbname</span>: <span style=color:#66d9ef>process.env.DB_NAME</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>passwordComplexity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;high&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>generatedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateApiKey</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretValue</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyPrefix</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ak_&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyBody</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateRandomString</span>(<span style=color:#ae81ff>32</span>, <span style=color:#e6db74>&#39;base62&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checksum</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>createHash</span>(<span style=color:#e6db74>&#39;sha256&#39;</span>).<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>keyBody</span>).<span style=color:#a6e22e>digest</span>(<span style=color:#e6db74>&#39;hex&#39;</span>).<span style=color:#a6e22e>substring</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>8</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretType</span>.<span style=color:#a6e22e>API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>keyPrefix</span><span style=color:#e6db74>}${</span><span style=color:#a6e22e>keyBody</span><span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>checksum</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keyFormat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;prefixed_with_checksum&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>generatedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateEncryptionKey</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecretValue</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate a 256-bit encryption key using AWS KMS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>command</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GenerateDataKeyCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeyId</span>: <span style=color:#66d9ef>this.defaultKmsKeyId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>KeySpec</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AES_256&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>kmsClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>command</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretType</span>.<span style=color:#a6e22e>ENCRYPTION_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keyMaterial</span>: <span style=color:#66d9ef>result.Plaintext</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#66d9ef>from</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>Plaintext</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>) <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>encryptedKey</span>: <span style=color:#66d9ef>result.CiphertextBlob</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>Buffer</span>.<span style=color:#66d9ef>from</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>CiphertextBlob</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>) <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keyId</span>: <span style=color:#66d9ef>this.defaultKmsKeyId</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keyLength</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;256&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;AES&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>generatedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateSymmetricKey</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretValue</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyBytes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>randomBytes</span>(<span style=color:#ae81ff>32</span>); <span style=color:#75715e>// 256-bit key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>SecretType</span>.<span style=color:#a6e22e>SYMMETRIC_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>keyBytes.toString</span>(<span style=color:#e6db74>&#39;base64&#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>keyLength</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;256&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>encoding</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;base64&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>generatedAt</span>: <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateStrongPassword</span>(<span style=color:#a6e22e>length</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>charset</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()_+-=[]{}|;:,.&lt;&gt;?&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>password</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Ensure at least one character from each required category
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>categories</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;abcdefghijklmnopqrstuvwxyz&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;0123456789&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;!@#$%^&amp;*()_+-=[]{}|;:,.&lt;&gt;?&#39;</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add one character from each category
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>category</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>categories</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>password</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>category</span>[Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>category</span>.<span style=color:#a6e22e>length</span>)];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Fill remaining length with random characters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>password</span>.<span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>password</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>charset</span>[Math.<span style=color:#a6e22e>floor</span>(Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>*</span> <span style=color:#a6e22e>charset</span>.<span style=color:#a6e22e>length</span>)];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Shuffle the password to avoid predictable patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>password</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;&#39;</span>).<span style=color:#a6e22e>sort</span>(() <span style=color:#f92672>=&gt;</span> Math.<span style=color:#a6e22e>random</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>0.5</span>).<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateRandomString</span>(<span style=color:#a6e22e>length</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>charset</span>: <span style=color:#66d9ef>string</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;base64&#39;</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>charsets</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>base64</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>base62</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hex</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;0123456789abcdef&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>chars</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>charsets</span>[<span style=color:#a6e22e>charset</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>keyof</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>charsets</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>charsets</span>.<span style=color:#a6e22e>base64</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bytes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>randomBytes</span>(<span style=color:#a6e22e>length</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>length</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span> <span style=color:#f92672>+=</span> <span style=color:#a6e22e>chars</span>[<span style=color:#a6e22e>bytes</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>%</span> <span style=color:#a6e22e>chars</span>.<span style=color:#a6e22e>length</span>];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateAccess</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>SecretRequestContext</span>, <span style=color:#a6e22e>operation</span>: <span style=color:#66d9ef>SecretOperation</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metadata</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>metadata</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Secret not found&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check service authorization
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>allowedServices</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>serviceId</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Service not authorized to access this secret&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check environment authorization
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>allowedEnvironments</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>environment</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Environment not authorized for this secret&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check operation authorization
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>allowedOps</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>accessPatterns</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>new</span> RegExp(<span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>pattern</span>).<span style=color:#a6e22e>test</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>requestPath</span>))
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>flatMap</span>(<span style=color:#a6e22e>pattern</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>allowedOperations</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>allowedOps</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>operation</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Operation not allowed by access policy&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check rate limits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkRateLimit</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check IP whitelist if configured
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>ipWhitelist</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>ipWhitelist</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>accessPolicy</span>.<span style=color:#a6e22e>ipWhitelist</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>sourceIP</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;IP address not in whitelist&#39;</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>scheduleRotation</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>schedule</span>: <span style=color:#66d9ef>RotationSchedule</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>schedule</span>.<span style=color:#a6e22e>enabled</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>schedule</span>.<span style=color:#a6e22e>automaticRotation</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>intervalMs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>schedule</span>.<span style=color:#a6e22e>intervalDays</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setTimeout</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rotateSecret</span>(<span style=color:#a6e22e>secretId</span>, { <span style=color:#a6e22e>automatic</span>: <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>initiatedBy</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;system&#39;</span> });
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Reschedule for next interval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleRotation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>schedule</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Automatic rotation failed for secret </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secretId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Implement notification logic here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>intervalMs</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rotationTasks</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>initializeBackgroundTasks</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clean up expired cache entries every 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupExpiredCache</span>();
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for missed rotations every hour
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkMissedRotations</span>();
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>cleanupExpiredCache</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>cached</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretCache</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>now</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>expiresAt</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkMissedRotations</span>()<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This would query the metadata store for secrets with missed rotation schedules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// Implementation would depend on your metadata storage solution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getSecretUsageMetrics</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>timeRange</span>: <span style=color:#66d9ef>TimeRange</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>UsageMetrics</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implementation would query audit logs to generate usage metrics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>totalAccesses</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>uniqueServices</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>averageRequestsPerHour</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>peakUsageTime</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>accessPatterns</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeSecret</span>(<span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Mark secret as revoked in metadata
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metadata</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metadata</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>tags</span>[<span style=color:#e6db74>&#39;status&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;revoked&#39;</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>tags</span>[<span style=color:#e6db74>&#39;revokedAt&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date().<span style=color:#a6e22e>toISOString</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span>.<span style=color:#a6e22e>tags</span>[<span style=color:#e6db74>&#39;revokeReason&#39;</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>reason</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>storeSecretMetadata</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>metadata</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Cancel any scheduled rotations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rotationTask</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rotationTasks</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>rotationTask</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>rotationTask</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rotationTasks</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Invalidate cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>invalidateSecretCache</span>(<span style=color:#a6e22e>secretId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log revocation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditSecretOperation</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>SecretOperation</span>.<span style=color:#a6e22e>DELETE</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;system&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>operation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;revoke_secret&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>reason</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to revoke secret: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=dynamic-secret-injection-patterns>Dynamic Secret Injection Patterns</h2><p>Modern cloud-native applications require sophisticated mechanisms for injecting secrets into containers and serverless functions without exposing them in configuration files or environment variables. Dynamic injection patterns ensure that secrets are provided to applications at runtime through secure channels and are automatically refreshed when rotations occur.</p><p>These patterns must address the challenges of container orchestration platforms like Kubernetes, where pods may be created and destroyed frequently, and serverless environments where function instances have limited lifecycle control. The injection mechanism must be efficient enough to avoid impacting application startup times while providing the security guarantees needed for production environments.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Dynamic secret injection system for cloud-native workloads
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>ECSClient</span>, <span style=color:#a6e22e>DescribeTasksCommand</span>, <span style=color:#a6e22e>DescribeTaskDefinitionCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-ecs&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>LambdaClient</span>, <span style=color:#a6e22e>GetFunctionCommand</span>, <span style=color:#a6e22e>UpdateFunctionConfigurationCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-lambda&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>SSMClient</span>, <span style=color:#a6e22e>GetParametersCommand</span>, <span style=color:#a6e22e>PutParameterCommand</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#34;@aws-sdk/client-ssm&#34;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SecretInjectionConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>injectionMethod</span>: <span style=color:#66d9ef>InjectionMethod</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>WorkloadTarget</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secretMappings</span>: <span style=color:#66d9ef>SecretMapping</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>refreshPolicy</span>: <span style=color:#66d9ef>RefreshPolicy</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>failureHandling</span>: <span style=color:#66d9ef>FailureHandlingPolicy</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SecretMapping</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>targetKey</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>transformationRule?</span>: <span style=color:#66d9ef>TransformationRule</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>validationRule?</span>: <span style=color:#66d9ef>ValidationRule</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RefreshPolicy</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>automaticRefresh</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>refreshInterval</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>refreshTriggers</span>: <span style=color:#66d9ef>RefreshTrigger</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>gracefulFailover</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>InjectionMethod</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ENVIRONMENT_VARIABLE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ENVIRONMENT_VARIABLE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MOUNTED_FILE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;MOUNTED_FILE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IN_MEMORY_CACHE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;IN_MEMORY_CACHE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>INIT_CONTAINER</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;INIT_CONTAINER&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SIDECAR_PROXY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SIDECAR_PROXY&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>RefreshTrigger</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SECRET_ROTATION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SECRET_ROTATION&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SCHEDULE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SCHEDULE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MANUAL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;MANUAL&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>HEALTH_CHECK_FAILURE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;HEALTH_CHECK_FAILURE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>DynamicSecretInjector</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ecsClient</span>: <span style=color:#66d9ef>ECSClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>lambdaClient</span>: <span style=color:#66d9ef>LambdaClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>ssmClient</span>: <span style=color:#66d9ef>SSMClient</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>secretsManager</span>: <span style=color:#66d9ef>CloudNativeSecretsManager</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>injectionJobs</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>InjectionJob</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secretsManager</span>: <span style=color:#66d9ef>CloudNativeSecretsManager</span>
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ecsClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ECSClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lambdaClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LambdaClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ssmClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SSMClient</span>({ <span style=color:#a6e22e>region</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secretsManager</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>secretsManager</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initializeRefreshScheduler</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectSecrets</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateInjectionConfig</span>(<span style=color:#a6e22e>config</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Retrieve all required secrets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretValues</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retrieveSecretsForInjection</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secretMappings</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Apply transformations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>transformedSecrets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyTransformations</span>(<span style=color:#a6e22e>secretValues</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secretMappings</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Inject based on method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performInjection</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>transformedSecrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Set up refresh monitoring if enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>refreshPolicy</span>.<span style=color:#a6e22e>automaticRefresh</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setupRefreshMonitoring</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>injectionResult</span>.<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>injectionResult</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Secret injection failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performInjection</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>injectionMethod</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.ENVIRONMENT_VARIABLE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectAsEnvironmentVariables</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.MOUNTED_FILE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectAsMountedFiles</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.IN_MEMORY_CACHE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectToMemoryCache</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.INIT_CONTAINER</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectViaInitContainer</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.SIDECAR_PROXY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectViaSidecarProxy</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Unsupported injection method: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>injectionMethod</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectAsEnvironmentVariables</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jobId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateJobId</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;ECS_TASK&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectToECSTask</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>, <span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;LAMBDA_FUNCTION&#39;</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectToLambdaFunction</span>(<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>, <span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Unsupported workload type for environment variable injection: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#66d9ef>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Environment variable injection failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectToECSTask</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[], <span style=color:#a6e22e>jobId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// For ECS, we update the task definition with secrets from AWS Systems Manager Parameter Store
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parameterPromises</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>secrets</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>secret</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parameterName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/secrets/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#a6e22e>identifier</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>targetKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ssmClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutParameterCommand</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>: <span style=color:#66d9ef>parameterName</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Value</span>: <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;string&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>secret.value</span> : <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SecureString&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Overwrite</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Description</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Secret for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#a6e22e>identifier</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Tags</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;InjectionJob&#39;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#66d9ef>jobId</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TargetWorkload&#39;</span>, <span style=color:#a6e22e>Value</span>: <span style=color:#66d9ef>config.targetWorkload.identifier</span> },
</span></span><span style=display:flex><span>          { <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ManagedBy&#39;</span>, <span style=color:#a6e22e>Value</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DynamicSecretInjector&#39;</span> }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>      }));
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>secret.targetKey</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>valueFrom</span>: <span style=color:#66d9ef>parameterName</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parameterReferences</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>parameterPromises</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create injection job record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionJob</span>: <span style=color:#66d9ef>InjectionJob</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ACTIVE&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>parameterReferences</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefresh</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>jobId</span>, <span style=color:#a6e22e>injectionJob</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>injectionMethod</span>: <span style=color:#66d9ef>config.injectionMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretCount</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>config.targetWorkload.identifier</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>parameterReferences</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectToLambdaFunction</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[], <span style=color:#a6e22e>jobId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>functionName</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#a6e22e>identifier</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get current function configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getFunctionResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lambdaClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>GetFunctionCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>FunctionName</span>: <span style=color:#66d9ef>functionName</span>
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentEnvironment</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>getFunctionResult</span>.<span style=color:#a6e22e>Configuration</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>Environment</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>Variables</span> <span style=color:#f92672>||</span> {};
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add secrets to environment variables
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updatedEnvironment</span> <span style=color:#f92672>=</span> { ...<span style=color:#a6e22e>currentEnvironment</span> };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secret</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>secrets</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>updatedEnvironment</span>[<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>targetKey</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;string&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>secret.value</span> : <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Update function configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lambdaClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>UpdateFunctionConfigurationCommand</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>FunctionName</span>: <span style=color:#66d9ef>functionName</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>Environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Variables</span>: <span style=color:#66d9ef>updatedEnvironment</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create injection job record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionJob</span>: <span style=color:#66d9ef>InjectionJob</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ACTIVE&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environmentVariables</span>: <span style=color:#66d9ef>secrets.map</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>targetKey</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefresh</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>jobId</span>, <span style=color:#a6e22e>injectionJob</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>injectionMethod</span>: <span style=color:#66d9ef>config.injectionMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretCount</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>config.targetWorkload.identifier</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environmentVariables</span>: <span style=color:#66d9ef>secrets.map</span>(<span style=color:#a6e22e>s</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>targetKey</span>)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectAsMountedFiles</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// This would integrate with Kubernetes secrets or EFS/FSx for file-based injection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jobId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateJobId</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create temporary directory structure
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretsPath</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/tmp/secrets/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>jobId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// For each secret, create a file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePromises</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>secrets</span>.<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>secret</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filePath</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secretsPath</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>targetKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>fileContent</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;string&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>secret.value</span> : <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>, <span style=color:#66d9ef>null</span>, <span style=color:#ae81ff>2</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// In a real implementation, this would write to a shared volume or mounted filesystem
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// For demonstration, we&#39;ll simulate the file creation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span>: <span style=color:#66d9ef>filePath</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>size</span>: <span style=color:#66d9ef>Buffer.byteLength</span>(<span style=color:#a6e22e>fileContent</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>permissions</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;600&#39;</span> <span style=color:#75715e>// Read-write for owner only
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      };
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>files</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>Promise</span>.<span style=color:#a6e22e>all</span>(<span style=color:#a6e22e>filePromises</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionJob</span>: <span style=color:#66d9ef>InjectionJob</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ACTIVE&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>mountedFiles</span>: <span style=color:#66d9ef>files</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefresh</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>jobId</span>, <span style=color:#a6e22e>injectionJob</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>injectionMethod</span>: <span style=color:#66d9ef>config.injectionMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretCount</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>config.targetWorkload.identifier</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>mountPath</span>: <span style=color:#66d9ef>secretsPath</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>files</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>injectViaSidecarProxy</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecretInjectionConfig</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>jobId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateJobId</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create a sidecar proxy configuration that serves secrets via HTTP API
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>proxyConfig</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>port</span>: <span style=color:#66d9ef>8080</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>endpoints</span>: <span style=color:#66d9ef>secrets.map</span>(<span style=color:#a6e22e>secret</span> <span style=color:#f92672>=&gt;</span> ({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`/secrets/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>targetKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>auth</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bearer_token&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>secret.value</span>
</span></span><span style=display:flex><span>      })),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>healthCheck</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/health&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metrics</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;/metrics&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// In a real implementation, this would deploy a sidecar container
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// that provides an API for accessing secrets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionJob</span>: <span style=color:#66d9ef>InjectionJob</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>config</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ACTIVE&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sidecarConfig</span>: <span style=color:#66d9ef>proxyConfig</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefresh</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>jobId</span>, <span style=color:#a6e22e>injectionJob</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>injectionMethod</span>: <span style=color:#66d9ef>config.injectionMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretCount</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>config.targetWorkload.identifier</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sidecarEndpoint</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`http://localhost:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>proxyConfig</span>.<span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>refreshSecrets</span>(<span style=color:#a6e22e>jobId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RefreshResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>job</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>job</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Injection job </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>jobId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> not found`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Retrieve updated secrets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>updatedSecrets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retrieveSecretsForInjection</span>(<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secretMappings</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>transformedSecrets</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyTransformations</span>(<span style=color:#a6e22e>updatedSecrets</span>, <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>secretMappings</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Perform refresh based on injection method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performRefresh</span>(<span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>transformedSecrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Update job record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>lastRefresh</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>refreshCount</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>refreshCount</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>refreshResult</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>lastError</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ERROR&#39;</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Secret refresh failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performRefresh</span>(<span style=color:#a6e22e>job</span>: <span style=color:#66d9ef>InjectionJob</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RefreshResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>injectionMethod</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.ENVIRONMENT_VARIABLE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshEnvironmentVariables</span>(<span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.MOUNTED_FILE</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshMountedFiles</span>(<span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.SIDECAR_PROXY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshSidecarProxy</span>(<span style=color:#a6e22e>job</span>, <span style=color:#a6e22e>secrets</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Refresh not supported for injection method: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>injectionMethod</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>refreshEnvironmentVariables</span>(<span style=color:#a6e22e>job</span>: <span style=color:#66d9ef>InjectionJob</span>, <span style=color:#a6e22e>secrets</span>: <span style=color:#66d9ef>ProcessedSecret</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RefreshResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#66d9ef>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;LAMBDA_FUNCTION&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// For Lambda, we need to update the function configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectToLambdaFunction</span>(<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>, <span style=color:#a6e22e>secrets</span>, <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>updatedSecrets</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;environment_variable_update&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// For ECS, update the parameter store values
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secret</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>secrets</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>parameterName</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`/secrets/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>targetWorkload</span>.<span style=color:#a6e22e>identifier</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>targetKey</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>ssmClient</span>.<span style=color:#a6e22e>send</span>(<span style=color:#66d9ef>new</span> <span style=color:#a6e22e>PutParameterCommand</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Name</span>: <span style=color:#66d9ef>parameterName</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Value</span>: <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;string&#39;</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>secret.value</span> : <span style=color:#66d9ef>JSON.stringify</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SecureString&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>Overwrite</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        }));
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>updatedSecrets</span>: <span style=color:#66d9ef>secrets.length</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;parameter_store_update&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>initializeRefreshScheduler</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for jobs that need refresh every minute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(<span style=color:#66d9ef>async</span> () <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>jobId</span>, <span style=color:#a6e22e>job</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>refreshPolicy</span>.<span style=color:#a6e22e>automaticRefresh</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>minutesSinceLastRefresh</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>now</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>lastRefresh</span>.<span style=color:#a6e22e>getTime</span>()) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>minutesSinceLastRefresh</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>refreshPolicy</span>.<span style=color:#a6e22e>refreshInterval</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>refreshSecrets</span>(<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>          } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Scheduled refresh failed for job </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>jobId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>); <span style=color:#75715e>// Every minute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeInjection</span>(<span style=color:#a6e22e>jobId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>job</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>job</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Injection job </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>jobId</span><span style=color:#e6db74>}</span><span style=color:#e6db74> not found`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Clean up based on injection method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>job</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>injectionMethod</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.ENVIRONMENT_VARIABLE</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupEnvironmentVariables</span>(<span style=color:#a6e22e>job</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.MOUNTED_FILE</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupMountedFiles</span>(<span style=color:#a6e22e>job</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>InjectionMethod.SIDECAR_PROXY</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupSidecarProxy</span>(<span style=color:#a6e22e>job</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Remove job record
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to revoke injection: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getInjectionStatus</span>(<span style=color:#a6e22e>jobId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionStatus</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>job</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>injectionJobs</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>jobId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>job</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;NOT_FOUND&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Job not found&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>jobId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span>: <span style=color:#66d9ef>job.status</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>createdAt</span>: <span style=color:#66d9ef>job.createdAt</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefresh</span>: <span style=color:#66d9ef>job.lastRefresh</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refreshCount</span>: <span style=color:#66d9ef>job.refreshCount</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretCount</span>: <span style=color:#66d9ef>job.config.secretMappings.length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>job.config.injectionMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>targetWorkload</span>: <span style=color:#66d9ef>job.config.targetWorkload.identifier</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span>: <span style=color:#66d9ef>job.lastError</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=zero-trust-secret-distribution>Zero-Trust Secret Distribution</h2><p>Zero-trust architecture principles apply directly to secrets management, requiring that every access request be authenticated, authorized, and encrypted regardless of the source or destination. This approach ensures that secrets are protected even when network boundaries are compromised or when dealing with untrusted environments.</p><p>Implementing zero-trust secret distribution requires sophisticated identity verification mechanisms, encrypted communication channels, and comprehensive audit logging. The system must assume that any component could be compromised and design security controls accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Zero-trust secret distribution system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ZeroTrustContext</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>identity</span>: <span style=color:#66d9ef>VerifiedIdentity</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>networkContext</span>: <span style=color:#66d9ef>NetworkContext</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceAttestation</span>: <span style=color:#66d9ef>DeviceAttestation</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>environmentFactors</span>: <span style=color:#66d9ef>EnvironmentFactors</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>riskAssessment</span>: <span style=color:#66d9ef>RiskAssessment</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>VerifiedIdentity</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>principalId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>principalType</span>: <span style=color:#66d9ef>PrincipalType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authenticationMethods</span>: <span style=color:#66d9ef>AuthMethod</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>verificationLevel</span>: <span style=color:#66d9ef>VerificationLevel</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>certificates</span>: <span style=color:#66d9ef>Certificate</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>attestationData</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>NetworkContext</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sourceIP</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>destinationIP</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>networkZone</span>: <span style=color:#66d9ef>SecurityZone</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>encryptionLevel</span>: <span style=color:#66d9ef>EncryptionLevel</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>intermediaryNodes</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>latency</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>DeviceAttestation</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>deviceId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>platformType</span>: <span style=color:#66d9ef>PlatformType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>firmwareVersion</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>securityFeatures</span>: <span style=color:#66d9ef>SecurityFeature</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>integrityMeasurements</span>: <span style=color:#66d9ef>IntegrityMeasurement</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>trustScore</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>PrincipalType</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SERVICE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SERVICE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>USER</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;USER&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CONTAINER</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CONTAINER&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FUNCTION</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FUNCTION&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>PIPELINE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;PIPELINE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>VerificationLevel</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>BASIC</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;BASIC&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ENHANCED</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ENHANCED&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>HIGH_ASSURANCE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;HIGH_ASSURANCE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ZeroTrustSecretDistributor</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>identityVerifier</span>: <span style=color:#66d9ef>IdentityVerifier</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>riskEngine</span>: <span style=color:#66d9ef>RiskAssessmentEngine</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>encryptionManager</span>: <span style=color:#66d9ef>EncryptionManager</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>AuditLogger</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>distributionCache</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>DistributionSession</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>identityVerifier</span>: <span style=color:#66d9ef>IdentityVerifier</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>riskEngine</span>: <span style=color:#66d9ef>RiskAssessmentEngine</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>encryptionManager</span>: <span style=color:#66d9ef>EncryptionManager</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>AuditLogger</span>
</span></span><span style=display:flex><span>  ) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>identityVerifier</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>identityVerifier</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>riskEngine</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>riskEngine</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>encryptionManager</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>auditLogger</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>distributeSecret</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>distributionRequest</span>: <span style=color:#66d9ef>SecretDistributionRequest</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>DistributionResult</span>&gt; {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 1: Comprehensive identity verification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>verifiedContext</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>verifyZeroTrustContext</span>(<span style=color:#a6e22e>distributionRequest</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 2: Risk assessment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>riskAssessment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>assessDistributionRisk</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 3: Policy evaluation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>policyDecision</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluateDistributionPolicy</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>, <span style=color:#a6e22e>riskAssessment</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>policyDecision</span>.<span style=color:#a6e22e>decision</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#39;PERMIT&#39;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logDistributionDenial</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>, <span style=color:#a6e22e>policyDecision</span>.<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Distribution denied: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>policyDecision</span>.<span style=color:#a6e22e>reason</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 4: Establish secure channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secureChannel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>establishSecureChannel</span>(<span style=color:#a6e22e>verifiedContext</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 5: Retrieve and prepare secret
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secretValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retrieveSecretForDistribution</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 6: Apply additional security measures based on risk
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityMeasures</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>determineSecurityMeasures</span>(<span style=color:#a6e22e>riskAssessment</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applySecurityMeasures</span>(<span style=color:#a6e22e>secretValue</span>, <span style=color:#a6e22e>securityMeasures</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 7: Distribute secret through secure channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>distributionResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performSecureDistribution</span>(
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>preparedSecret</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secureChannel</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>securityMeasures</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 8: Create distribution session for monitoring
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createDistributionSession</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>, <span style=color:#a6e22e>distributionResult</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Step 9: Log successful distribution
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logDistributionSuccess</span>(<span style=color:#a6e22e>secretId</span>, <span style=color:#a6e22e>verifiedContext</span>, <span style=color:#a6e22e>distributionResult</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>distributionResult</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>verifyZeroTrustContext</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>SecretDistributionRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ZeroTrustContext</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Verify identity using multiple authentication factors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>identity</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>identityVerifier</span>.<span style=color:#a6e22e>verifyMultiFactor</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>credentials</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Assess network context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>networkContext</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>assessNetworkContext</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>networkInfo</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform device attestation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>deviceAttestation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performDeviceAttestation</span>(<span style=color:#a6e22e>request</span>.<span style=color:#a6e22e>deviceInfo</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Collect environmental factors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>environmentFactors</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>collectEnvironmentFactors</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform comprehensive risk assessment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>riskAssessment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>riskEngine</span>.<span style=color:#a6e22e>assessContext</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>identity</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>networkContext</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deviceAttestation</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environmentFactors</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>identity</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>networkContext</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deviceAttestation</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environmentFactors</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskAssessment</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performDeviceAttestation</span>(<span style=color:#a6e22e>deviceInfo</span>: <span style=color:#66d9ef>DeviceInfo</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>DeviceAttestation</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Verify device identity and integrity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>attestationChallenge</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateAttestationChallenge</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>attestationResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>requestDeviceAttestation</span>(<span style=color:#a6e22e>deviceInfo</span>.<span style=color:#a6e22e>deviceId</span>, <span style=color:#a6e22e>attestationChallenge</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate attestation response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>isValid</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateAttestationResponse</span>(<span style=color:#a6e22e>attestationResponse</span>, <span style=color:#a6e22e>attestationChallenge</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Device attestation failed&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Extract device security features
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityFeatures</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extractSecurityFeatures</span>(<span style=color:#a6e22e>attestationResponse</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform integrity measurements
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>integrityMeasurements</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performIntegrityMeasurements</span>(<span style=color:#a6e22e>deviceInfo</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Calculate trust score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>trustScore</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateDeviceTrustScore</span>(<span style=color:#a6e22e>securityFeatures</span>, <span style=color:#a6e22e>integrityMeasurements</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deviceId</span>: <span style=color:#66d9ef>deviceInfo.deviceId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>platformType</span>: <span style=color:#66d9ef>deviceInfo.platformType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>firmwareVersion</span>: <span style=color:#66d9ef>deviceInfo.firmwareVersion</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>securityFeatures</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>integrityMeasurements</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>trustScore</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>establishSecureChannel</span>(<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>ZeroTrustContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecureChannel</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Select encryption level based on risk assessment
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptionLevel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>selectEncryptionLevel</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>riskAssessment</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate ephemeral keys for this session
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>ephemeralKeys</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>generateEphemeralKeyPair</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Establish mutually authenticated TLS connection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tlsConfig</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>version</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;TLSv1.3&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>cipherSuite</span>: <span style=color:#66d9ef>this.selectCipherSuite</span>(<span style=color:#a6e22e>encryptionLevel</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>certificateVerification</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;MUTUAL&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>clientCertificate</span>: <span style=color:#66d9ef>context.identity.certificates</span>[<span style=color:#ae81ff>0</span>],
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ephemeralKeys</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secureChannel</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>establishTLSConnection</span>(<span style=color:#a6e22e>tlsConfig</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add additional encryption layer for highly sensitive secrets
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>encryptionLevel</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>EncryptionLevel</span>.<span style=color:#a6e22e>QUANTUM_RESISTANT</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>additionalEncryption</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>createQuantumResistantLayer</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secureChannel</span>.<span style=color:#a6e22e>addEncryptionLayer</span>(<span style=color:#a6e22e>additionalEncryption</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>secureChannel</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>applySecurityMeasures</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secretValue</span>: <span style=color:#66d9ef>SecretValue</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>measures</span>: <span style=color:#66d9ef>SecurityMeasure</span>[]
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>PreparedSecret</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>preparedSecret</span>: <span style=color:#66d9ef>PreparedSecret</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>secretValue</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>originalSize</span>: <span style=color:#66d9ef>this.calculateSecretSize</span>(<span style=color:#a6e22e>secretValue</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>preparationTime</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>securityMeasures</span>: <span style=color:#66d9ef>measures.map</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>m</span>.<span style=color:#66d9ef>type</span>)
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>measure</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>measures</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>measure</span>.<span style=color:#66d9ef>type</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecurityMeasureType.TIME_BOUND_ACCESS</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyTimeBounds</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>measure</span>.<span style=color:#a6e22e>parameters</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecurityMeasureType.GEOGRAPHIC_RESTRICTION</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyGeographicRestriction</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>measure</span>.<span style=color:#a6e22e>parameters</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecurityMeasureType.USAGE_LIMITATION</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyUsageLimitation</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>measure</span>.<span style=color:#a6e22e>parameters</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecurityMeasureType.FORWARD_SECRECY</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyForwardSecrecy</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>measure</span>.<span style=color:#a6e22e>parameters</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>SecurityMeasureType.SPLIT_KNOWLEDGE</span>:
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>preparedSecret</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applySplitKnowledge</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>measure</span>.<span style=color:#a6e22e>parameters</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>preparedSecret</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>applyTimeBounds</span>(<span style=color:#a6e22e>secret</span>: <span style=color:#66d9ef>PreparedSecret</span>, <span style=color:#a6e22e>parameters</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>PreparedSecret</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>expirationTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>parameters</span>.<span style=color:#a6e22e>validityPeriod</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Encrypt secret with time-bound key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeBoundKey</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>generateTimeBoundKey</span>(<span style=color:#a6e22e>expirationTime</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>encryptedValue</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>encrypt</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>timeBoundKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>secret</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span>: <span style=color:#66d9ef>encryptedValue</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>metadata</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>expirationTime</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeBoundKeyId</span>: <span style=color:#66d9ef>timeBoundKey.keyId</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>applySplitKnowledge</span>(<span style=color:#a6e22e>secret</span>: <span style=color:#66d9ef>PreparedSecret</span>, <span style=color:#a6e22e>parameters</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>PreparedSecret</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parameters</span>.<span style=color:#a6e22e>threshold</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalShares</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>parameters</span>.<span style=color:#a6e22e>totalShares</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Split the secret using Shamir&#39;s Secret Sharing
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>shares</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>splitSecret</span>(<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>value</span>, <span style=color:#a6e22e>threshold</span>, <span style=color:#a6e22e>totalShares</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Distribute shares to different storage locations
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>shareLocations</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributeShares</span>(<span style=color:#a6e22e>shares</span>, <span style=color:#a6e22e>parameters</span>.<span style=color:#a6e22e>shareRecipients</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>secret</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SPLIT_SECRET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>threshold</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>totalShares</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>shareLocations</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reconstructionHint</span>: <span style=color:#66d9ef>shares.reconstructionHint</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>secret</span>.<span style=color:#a6e22e>metadata</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>splitIntoShares</span>: <span style=color:#66d9ef>totalShares</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reconstructionThreshold</span>: <span style=color:#66d9ef>threshold</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performSecureDistribution</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>preparedSecret</span>: <span style=color:#66d9ef>PreparedSecret</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secureChannel</span>: <span style=color:#66d9ef>SecureChannel</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>securityMeasures</span>: <span style=color:#66d9ef>SecurityMeasure</span>[]
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>DistributionResult</span>&gt; {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Create distribution envelope with integrity protection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>envelope</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createDistributionEnvelope</span>(<span style=color:#a6e22e>preparedSecret</span>, <span style=color:#a6e22e>securityMeasures</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Sign envelope for non-repudiation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signedEnvelope</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>encryptionManager</span>.<span style=color:#a6e22e>signEnvelope</span>(<span style=color:#a6e22e>envelope</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Transmit through secure channel
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>transmissionId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>secureChannel</span>.<span style=color:#a6e22e>transmit</span>(<span style=color:#a6e22e>signedEnvelope</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Verify receipt and integrity
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>receipt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>secureChannel</span>.<span style=color:#a6e22e>waitForReceipt</span>(<span style=color:#a6e22e>transmissionId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>receipt</span>.<span style=color:#a6e22e>integrityVerified</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Distribution integrity verification failed&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>distributionId</span>: <span style=color:#66d9ef>this.generateDistributionId</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>transmissionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;SUCCESS&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>securityMeasures</span>: <span style=color:#66d9ef>securityMeasures.map</span>(<span style=color:#a6e22e>m</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>m</span>.<span style=color:#66d9ef>type</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>integrityHash</span>: <span style=color:#66d9ef>receipt.integrityHash</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>encryptionLevel</span>: <span style=color:#66d9ef>secureChannel.getEncryptionLevel</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>createDistributionSession</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>secretId</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>ZeroTrustContext</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>DistributionResult</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>session</span>: <span style=color:#66d9ef>DistributionSession</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>sessionId</span>: <span style=color:#66d9ef>result.distributionId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>secretId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>principalId</span>: <span style=color:#66d9ef>context.identity.principalId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>distributedAt</span>: <span style=color:#66d9ef>result.timestamp</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskScore</span>: <span style=color:#66d9ef>context.riskAssessment.overallScore</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>securityMeasures</span>: <span style=color:#66d9ef>result.securityMeasures</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>networkContext</span>: <span style=color:#66d9ef>context.networkContext</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deviceTrustScore</span>: <span style=color:#66d9ef>context.deviceAttestation.trustScore</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>this.calculateSessionExpiry</span>(<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>securityMeasures</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isActive</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributionCache</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>sessionId</span>, <span style=color:#a6e22e>session</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Schedule session cleanup
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleSessionCleanup</span>(<span style=color:#a6e22e>session</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateSecretUsage</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>distributionId</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>usageContext</span>: <span style=color:#66d9ef>SecretUsageContext</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>UsageValidationResult</span>&gt; {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>session</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributionCache</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>distributionId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>session</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>isActive</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Distribution session not found or expired&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate usage context against distribution constraints
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>violations</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkUsageViolations</span>(<span style=color:#a6e22e>session</span>, <span style=color:#a6e22e>usageContext</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>violations</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Usage violations detected: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>violations</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Update session usage tracking
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>lastUsed</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>usageCount</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>usageCount</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>remainingUsages</span>: <span style=color:#66d9ef>this.calculateRemainingUsages</span>(<span style=color:#a6e22e>session</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>expiresAt</span>: <span style=color:#66d9ef>session.expiresAt</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeDistribution</span>(<span style=color:#a6e22e>distributionId</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>session</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributionCache</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>distributionId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>session</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>isActive</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>revokedAt</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>revocationReason</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>reason</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logDistributionRevocation</span>(<span style=color:#a6e22e>distributionId</span>, <span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>scheduleSessionCleanup</span>(<span style=color:#a6e22e>session</span>: <span style=color:#66d9ef>DistributionSession</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeUntilExpiry</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>expiresAt</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setTimeout</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributionCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>session</span>.<span style=color:#a6e22e>sessionId</span>);
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>timeUntilExpiry</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Secrets management in cloud-native applications requires a fundamental shift from traditional approaches to comprehensive lifecycle management that addresses the unique challenges of distributed, dynamic environments. The strategies explored in this post demonstrate how organizations can implement robust secrets management systems that provide security, scalability, and operational efficiency.</p><p>The implementation of these secrets management patterns requires careful consideration of the trade-offs between security and operational complexity. Comprehensive lifecycle management provides the control and auditability needed for enterprise environments but requires sophisticated orchestration and monitoring systems. Dynamic injection patterns enable secure secret distribution without exposing sensitive information in configuration files, but they introduce dependencies on additional infrastructure components. Zero-trust distribution models provide the highest levels of security through continuous verification and risk assessment, but they require significant investment in identity management and monitoring capabilities.</p><p>As cloud-native applications continue to evolve, secrets management systems must adapt to support new deployment patterns, emerging threats, and changing regulatory requirements. Organizations implementing these patterns should focus on creating flexible, extensible systems that can integrate with existing security infrastructure while providing the automation and scalability needed for modern development practices. The foundation established by these secrets management strategies will prove essential as we continue to explore additional security considerations in the remaining posts of this series.</p></div></article></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li><li><a href=/posts/using-ai-in-software-engineering/>Harnessing AI in Software Engineering: Opportunities and Challenges</a>
<span class=post-date>May 29, 2025</span></li><li><a href=/posts/aws-serverless-cost-optimization/>Cost Optimization Strategies for AWS Serverless Applications</a>
<span class=post-date>Jun 17, 2023</span></li><li><a href=/posts/aws-sns-sqs-typescript/>Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span></li><li><a href=/posts/securing-aws-lambda/>Securing AWS Lambda Functions: Best Practices and Implementation Guide</a>
<span class=post-date>Apr 7, 2023</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/aws-sns-sqs-typescript/>AWS and Typescript: Building Event-Driven Architectures with AWS SNS/SQS and TypeScript</a>
<span class=post-date>May 21, 2023</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 3 posts in series ‚Üí</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series ‚Üí</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series ‚Üí</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series ‚Üí</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (1)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (8)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (16)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/development-tools>development tools (2)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (1)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:3rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:1rem>best practices
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:2rem>typescript
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>