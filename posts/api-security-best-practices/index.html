<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scott Obert</title><meta name=description content="Application Programming Interfaces (APIs) have become the fundamental building blocks of cloud-native applications, enabling microservices to communicate and …"><link rel=canonical href=https://scottobert.com/posts/api-security-best-practices/><meta property="og:title" content="API Security Best Practices for Cloud-Native Applications"><meta property="og:description" content="Application Programming Interfaces (APIs) have become the fundamental building blocks of cloud-native applications, enabling microservices to communicate and …"><meta property="og:type" content="article"><meta property="og:url" content="https://scottobert.com/posts/api-security-best-practices/"><meta property="og:site_name" content="Scott Obert"><meta name=twitter:card content="summary"><meta name=twitter:title content="API Security Best Practices for Cloud-Native Applications"><meta name=twitter:description content="Application Programming Interfaces (APIs) have become the fundamental building blocks of cloud-native applications, enabling microservices to communicate and …"><link rel=stylesheet href=/css/style.css><script src=/js/npm-packages.js defer></script><script src=/js/search.js defer></script><script defer src=https://cloud.umami.is/script.js data-website-id=e2461896-021d-422a-b83f-624a8819309b></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><header class=site-header><div class=container><div class=header-content><div class=header-left><h1><a href=/>Scott Obert</a></h1><nav><a href=/posts/>Blog</a>
<a href=/album/>Photo Album</a>
<button type=button class=search-toggle id=search-toggle-btn aria-label="Open search" title=Search>
<svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61.0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
<span>Search</span></button></nav></div><div class=social-links><a href=https://www.linkedin.com/in/scott-obert-3a7338b/ target=_blank rel="noopener noreferrer" title="LinkedIn Profile"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href=https://github.com/scottobert target=_blank rel="noopener noreferrer" title="GitHub Profile"><svg viewBox="0 0 24 24"><path d="M12 0C5.37.0.0 5.37.0 12c0 5.3 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61-.546-1.385-1.335-1.755-1.335-1.755-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.605-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 21.795 24 17.295 24 12c0-6.63-5.37-12-12-12"/></svg>
<span>GitHub</span></a></div></div></div></header><div class=container><nav class=breadcrumbs aria-label="Breadcrumb navigation"><ol class=breadcrumb-list><li class=breadcrumb-item><a href=https://scottobert.com/ title=Home><svg class="breadcrumb-home-icon" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
<span>Home</span></a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/posts/ title=Posts>Posts</a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/series/security-in-cloud-native-applications/ title="Series: Security in Cloud-Native Applications"><svg class="breadcrumb-series-icon" viewBox="0 0 24 24"><path d="M9 4v1.38c-.83-.33-1.72-.5-2.61-.5-1.79.0-3.58.68-4.95 2.05l3.33 3.33h1.11v1.11c.86.86 1.98 1.31 3.11 1.31 1.13.0 2.25-.45 3.11-1.31V9.26h1.11l3.33-3.33c-1.37-1.37-3.16-2.05-4.95-2.05-.89.0-1.78.17-2.61.5V4H9z"/></svg>
<span>Security in Cloud-Native Applications</span></a></li><li class=breadcrumb-item><span class=breadcrumb-separator aria-hidden=true>/</span>
<a href=https://scottobert.com/categories/security title="Category: Security"><svg class="breadcrumb-category-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
<span>Security</span></a></li><li class="breadcrumb-item breadcrumb-current"><span class=breadcrumb-separator aria-hidden=true>/</span>
<span class=breadcrumb-current-page aria-current=page>API Security Best Practices for Cloud-Native Applications</span></li></ol></nav><div class=content-layout><main class=main-content><article class=post><h1>API Security Best Practices for Cloud-Native Applications</h1><div class=post-meta><div class=post-meta-left><span>Aug 17, 2019</span>
<span>| Tags: Security, API Security, OAuth, JWT, Rate Limiting, TypeScript, AWS</span></div><div class=post-meta-right><div class=quick-social-share><button type=button class=quick-share-toggle id=quick-share-toggle title="Share this post">
<svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
<span>Share</span></button><div class=quick-share-buttons id=quick-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&text=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="quick-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="quick-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&title=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&t=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="quick-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=API+Security+Best+Practices+for+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="quick-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=API+Security+Best+Practices+for+Cloud-Native+Applications&body=Check+out+this+article%3A+API+Security+Best+Practices+for+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" class="quick-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="quick-share-button copy-link" data-url=https://scottobert.com/posts/api-security-best-practices/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const i=document.querySelector(".quick-social-share"),e=document.getElementById("quick-share-toggle"),t=document.getElementById("quick-share-buttons");if(!i||!e||!t)return;let n=!1;e.addEventListener("click",function(){n=!n,n?(t.classList.add("visible"),e.classList.add("active")):(t.classList.remove("visible"),e.classList.remove("active"))});const a=document.querySelectorAll(".quick-share-button.copy-link");a.forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{o(this)}).catch(()=>{s(e,this)}):s(e,this)})});function s(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),o(t)}catch(e){console.error("Fallback: Unable to copy",e),r(t)}document.body.removeChild(n)}function o(e){const n=e.getAttribute("title");e.setAttribute("title","Copied!"),e.classList.add("copied");const t=document.createElement("div");t.textContent="Copied!",t.style.position="absolute",t.style.bottom="100%",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.background="#28a745",t.style.color="white",t.style.padding="4px 8px",t.style.borderRadius="4px",t.style.fontSize="0.75rem",t.style.whiteSpace="nowrap",t.style.zIndex="1000",t.style.marginBottom="5px",e.style.position="relative",e.appendChild(t),setTimeout(()=>{e.setAttribute("title",n),e.classList.remove("copied"),t.parentNode&&e.removeChild(t)},2e3)}function r(e){const t=e.getAttribute("title");e.setAttribute("title","Copy failed"),e.classList.add("error"),setTimeout(()=>{e.setAttribute("title",t),e.classList.remove("error")},2e3)}})()</script></div></div><div class=post-content><p>Application Programming Interfaces (APIs) have become the fundamental building blocks of cloud-native applications, enabling microservices to communicate and external systems to integrate with internal services. However, this increased connectivity and exposure also creates significant security challenges that must be addressed through comprehensive API security strategies. Modern cloud-native applications often expose dozens or hundreds of APIs, each representing a potential attack vector that requires careful security consideration.</p><p>The security of APIs in cloud-native environments is particularly complex because these interfaces must balance accessibility with protection, enabling legitimate users and services to interact efficiently while preventing unauthorized access and malicious activities. This challenge is compounded by the dynamic nature of cloud-native deployments, where API endpoints may be created, modified, or destroyed frequently as applications scale and evolve.</p><h2 id=api-gateway-security-architecture>API Gateway Security Architecture</h2><p>A robust API gateway serves as the primary security enforcement point for cloud-native applications, providing centralized control over authentication, authorization, rate limiting, and other security policies. The gateway architecture must be designed to handle high-throughput scenarios while maintaining low latency and providing comprehensive security controls that can adapt to changing threat landscapes.</p><p>Modern API gateways must implement multiple layers of security controls, from basic authentication and authorization to advanced threat detection and response capabilities. The gateway architecture should support policy-driven security configurations that can be applied consistently across all APIs while allowing for service-specific customizations when necessary.</p><div class=plantuml-container><img id=plantuml- class=plantuml-diagram>
<a id=plantuml-link- href=# target=_blank class=plantuml-link title="Open diagram in new window"><span class=plantuml-link-icon>🔍</span></a></div><script src=/js/rawdeflate.js></script><script>function encode64(e){r="";for(i=0;i<e.length;i+=3)i+2==e.length?r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),0):i+1==e.length?r+=append3bytes(e.charCodeAt(i),0,0):r+=append3bytes(e.charCodeAt(i),e.charCodeAt(i+1),e.charCodeAt(i+2));return r}function append3bytes(e,t,n){return c1=e>>2,c2=(e&3)<<4|t>>4,c3=(t&15)<<2|n>>6,c4=n&63,r="",r+=encode6bit(c1&63),r+=encode6bit(c2&63),r+=encode6bit(c3&63),r+=encode6bit(c4&63),r}function encode6bit(e){return e<10?String.fromCharCode(48+e):(e-=10,e<26?String.fromCharCode(65+e):(e-=26,e<26?String.fromCharCode(97+e):(e-=26,e==0?"-":e==1?"_":"?")))}var deflater=window.SharedWorker&&new SharedWorker("/js/rawdeflate.js");deflater?(deflater.port.addEventListener("message",done_deflating,!1),deflater.port.start()):window.Worker&&(deflater=new Worker("/js/rawdeflate.js"),deflater.onmessage=done_deflating);function done_deflating(e){const s=document.getElementById("plantuml-"),t="https://www.plantuml.com/plantuml/img/"+encode64(e.data);s.src=t;const n=document.getElementById("plantuml-link-");n&&(n.href=t)}function compress(e){e=unescape(encodeURIComponent(e)),deflater?deflater.port&&deflater.port.postMessage?deflater.port.postMessage(e):deflater.postMessage(e):setTimeout(function(){done_deflating({data:deflate(e)})},100)}compress(`
@startuml
!define RECTANGLE class

RECTANGLE "API Gateway" as Gateway {
  +authenticateRequest()
  +authorizeAccess()
  +validateInput()
  +enforceRateLimit()
  +detectThreats()
}

RECTANGLE "Authentication Service" as Auth {
  +validateToken()
  +refreshCredentials()
  +revokeAccess()
  +auditLogin()
}

RECTANGLE "Authorization Engine" as Authz {
  +evaluatePolicy()
  +checkPermissions()
  +applyConstraints()
  +logDecision()
}

RECTANGLE "Rate Limiter" as RateLimit {
  +checkQuota()
  +updateCounters()
  +enforceThrottling()
  +handleBurst()
}

RECTANGLE "Security Scanner" as Scanner {
  +scanPayload()
  +detectInjection()
  +validateSignature()
  +checkReputation()
}

RECTANGLE "Threat Detection" as ThreatDetect {
  +analyzePattern()
  +correlateEvents()
  +assessRisk()
  +triggerResponse()
}

RECTANGLE "Backend Service" as Backend {
  +processRequest()
  +validateBusiness()
  +executeLogic()
  +returnResponse()
}

RECTANGLE "Audit Logger" as Audit {
  +logRequest()
  +trackAccess()
  +recordAnomaly()
  +generateReport()
}

Gateway --> Auth : validate credentials
Gateway --> Authz : check permissions
Gateway --> RateLimit : enforce limits
Gateway --> Scanner : scan request
Gateway --> ThreatDetect : analyze behavior
Gateway --> Backend : forward request
Gateway --> Audit : log activity

Auth --> Audit : authentication events
Authz --> Audit : authorization decisions
ThreatDetect --> Audit : security alerts
@enduml
`)</script><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Comprehensive API Gateway security implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>APIGatewayProxyEvent</span>, <span style=color:#a6e22e>APIGatewayProxyResult</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;aws-lambda&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>verify</span>, <span style=color:#a6e22e>sign</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;jsonwebtoken&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>RateLimiterRedis</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;rate-limiter-flexible&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>createHash</span>, <span style=color:#a6e22e>createHmac</span> } <span style=color:#66d9ef>from</span> <span style=color:#e6db74>&#39;crypto&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>SecurityConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authentication</span>: <span style=color:#66d9ef>AuthenticationConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorization</span>: <span style=color:#66d9ef>AuthorizationConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>rateLimiting</span>: <span style=color:#66d9ef>RateLimitingConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>inputValidation</span>: <span style=color:#66d9ef>InputValidationConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>threatDetection</span>: <span style=color:#66d9ef>ThreatDetectionConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>auditLogging</span>: <span style=color:#66d9ef>AuditLoggingConfig</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AuthenticationConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>methods</span>: <span style=color:#66d9ef>AuthMethod</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenValidation</span>: <span style=color:#66d9ef>TokenValidationConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sessionManagement</span>: <span style=color:#66d9ef>SessionConfig</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>AuthorizationConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>engine</span>: <span style=color:#66d9ef>AuthorizationEngine</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>policies</span>: <span style=color:#66d9ef>SecurityPolicy</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>defaultAction</span>: <span style=color:#66d9ef>PolicyAction</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RateLimitingConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>limits</span>: <span style=color:#66d9ef>RateLimit</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>burstAllowance</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>slidingWindow</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>keyGenerators</span>: <span style=color:#66d9ef>KeyGenerator</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>ThreatDetectionConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>patterns</span>: <span style=color:#66d9ef>ThreatPattern</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>mlModels</span>: <span style=color:#66d9ef>MLModelConfig</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>realTimeAnalysis</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>responseActions</span>: <span style=color:#66d9ef>ResponseAction</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>AuthMethod</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>BEARER_TOKEN</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;BEARER_TOKEN&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;API_KEY&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>MUTUAL_TLS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;MUTUAL_TLS&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>OAUTH2</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;OAUTH2&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>JWT</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;JWT&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>PolicyAction</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ALLOW</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ALLOW&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>DENY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;DENY&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>AUDIT</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;AUDIT&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>CHALLENGE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;CHALLENGE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SecureAPIGateway</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>securityConfig</span>: <span style=color:#66d9ef>SecurityConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>rateLimiter</span>: <span style=color:#66d9ef>RateLimiterRedis</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>threatDetector</span>: <span style=color:#66d9ef>ThreatDetector</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>auditLogger</span>: <span style=color:#66d9ef>AuditLogger</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>authenticationCache</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>CachedAuthResult</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>SecurityConfig</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rateLimiter</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>RateLimiterRedis</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>storeClient</span>: <span style=color:#66d9ef>this.createRedisClient</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>keyPrefix</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;api_rate_limit&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>points</span>: <span style=color:#66d9ef>config.rateLimiting.limits</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>?</span>.<span style=color:#a6e22e>maxRequests</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>duration</span>: <span style=color:#66d9ef>config.rateLimiting.limits</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>?</span>.<span style=color:#a6e22e>windowSeconds</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>threatDetector</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ThreatDetector</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>threatDetection</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AuditLogger</span>(<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>auditLogging</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initializeSecurityMiddleware</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleRequest</span>(<span style=color:#a6e22e>event</span>: <span style=color:#66d9ef>APIGatewayProxyEvent</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>APIGatewayProxyResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestId</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateRequestId</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create request context
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestContext</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createRequestContext</span>(<span style=color:#a6e22e>event</span>, <span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Execute security pipeline
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeSecurityPipeline</span>(<span style=color:#a6e22e>requestContext</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>action</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>PolicyAction</span>.<span style=color:#a6e22e>DENY</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createSecurityResponse</span>(<span style=color:#a6e22e>securityResult</span>, <span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Forward to backend service
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>backendResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>forwardToBackend</span>(<span style=color:#a6e22e>requestContext</span>, <span style=color:#a6e22e>securityResult</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Apply response security measures
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secureResponse</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>secureResponse</span>(<span style=color:#a6e22e>backendResponse</span>, <span style=color:#a6e22e>requestContext</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log successful request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logRequest</span>(<span style=color:#a6e22e>requestContext</span>, <span style=color:#a6e22e>securityResult</span>, Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>startTime</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>secureResponse</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Log error and return secure error response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>auditLogger</span>.<span style=color:#a6e22e>logError</span>(<span style=color:#a6e22e>requestId</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createErrorResponse</span>(<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>executeSecurityPipeline</span>(<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pipeline</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authenticateRequest</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authorizeRequest</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateInput</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkRateLimit</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>detectThreats</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>),
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applySecurityHeaders</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>)
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>SecurityResult</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.ALLOW</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>context</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>securityHeaders</span><span style=color:#f92672>:</span> {},
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>transformations</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>step</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>pipeline</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>step</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>action</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>PolicyAction</span>.<span style=color:#a6e22e>DENY</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authenticateRequest</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>authentication</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authHeader</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>headers</span>.<span style=color:#a6e22e>authorization</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authHeader</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Missing authorization header&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check cache first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cacheKey</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateAuthCacheKey</span>(<span style=color:#a6e22e>authHeader</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cached</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authenticationCache</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>cacheKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cached</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isAuthCacheExpired</span>(<span style=color:#a6e22e>cached</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>authenticatedUser</span>: <span style=color:#66d9ef>cached.user</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>authenticationMethod</span>: <span style=color:#66d9ef>cached.method</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Perform authentication based on method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performAuthentication</span>(<span style=color:#a6e22e>authHeader</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>authResult</span>.<span style=color:#a6e22e>success</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>authResult.reason</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Cache successful authentication
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheAuthResult</span>(<span style=color:#a6e22e>cacheKey</span>, <span style=color:#a6e22e>authResult</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>authenticatedUser</span>: <span style=color:#66d9ef>authResult.user</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>authenticationMethod</span>: <span style=color:#66d9ef>authResult.method</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>performAuthentication</span>(<span style=color:#a6e22e>authHeader</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>AuthenticationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>method</span>, <span style=color:#a6e22e>credentials</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>authHeader</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>method</span>.<span style=color:#a6e22e>toUpperCase</span>()) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;BEARER&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authenticateBearer</span>(<span style=color:#a6e22e>credentials</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;APIKEY&#39;</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>authenticateApiKey</span>(<span style=color:#a6e22e>credentials</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Unsupported authentication method: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>method</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authenticateBearer</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>AuthenticationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate JWT token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getJWTSecret</span>(), {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;HS256&#39;</span>, <span style=color:#e6db74>&#39;RS256&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>issuer</span>: <span style=color:#66d9ef>this.securityConfig.authentication.tokenValidation.issuer</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>audience</span>: <span style=color:#66d9ef>this.securityConfig.authentication.tokenValidation.audience</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;object&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>decoded</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Additional security checks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>securityChecks</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performTokenSecurityChecks</span>(<span style=color:#a6e22e>decoded</span>, <span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>securityChecks</span>.<span style=color:#a6e22e>passed</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>securityChecks.reason</span>
</span></span><span style=display:flex><span>          };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>decoded.sub</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>decoded.email</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>roles</span>: <span style=color:#66d9ef>decoded.roles</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>[] <span style=color:#f92672>||</span> [],
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>decoded.scope</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>          },
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>AuthMethod.JWT</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid token payload&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Token validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authenticateApiKey</span>(<span style=color:#a6e22e>apiKey</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>AuthenticationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate API key format
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateApiKeyFormat</span>(<span style=color:#a6e22e>apiKey</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid API key format&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Look up API key in secure store
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>lookupApiKey</span>(<span style=color:#a6e22e>apiKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>keyInfo</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;API key not found&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if key is active and not expired
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>keyInfo</span>.<span style=color:#a6e22e>isActive</span> <span style=color:#f92672>||</span> (<span style=color:#a6e22e>keyInfo</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>keyInfo</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&lt;=</span> <span style=color:#66d9ef>new</span> Date())) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;API key is inactive or expired&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check usage limits
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>usageCheck</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkApiKeyUsage</span>(<span style=color:#a6e22e>apiKey</span>, <span style=color:#a6e22e>keyInfo</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>usageCheck</span>.<span style=color:#a6e22e>withinLimits</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;API key usage limit exceeded&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>success</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>user</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>keyInfo.userId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>keyInfo.userEmail</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>roles</span>: <span style=color:#66d9ef>keyInfo.roles</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>keyInfo.scope</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>AuthMethod.API_KEY</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>authorizeRequest</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>authorization</span>.<span style=color:#a6e22e>enabled</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>authenticatedUser</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>authenticatedUser</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Build authorization request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authzRequest</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>subject</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>id</span>: <span style=color:#66d9ef>user.id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>roles</span>: <span style=color:#66d9ef>user.roles</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>attributes</span>: <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getUserAttributes</span>(<span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>resource</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>path</span>: <span style=color:#66d9ef>context.path</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>context.httpMethod</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>service</span>: <span style=color:#66d9ef>context.service</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>this.mapHttpMethodToAction</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>httpMethod</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>environment</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>ip</span>: <span style=color:#66d9ef>context.sourceIP</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>context.userAgent</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Evaluate authorization policies
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>authzResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>evaluateAuthorizationPolicies</span>(<span style=color:#a6e22e>authzRequest</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>authzResult</span>.<span style=color:#a6e22e>decision</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>PolicyAction</span>.<span style=color:#a6e22e>DENY</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>authzResult.reason</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>authorizationResult</span>: <span style=color:#66d9ef>authzResult</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateInput</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>inputValidation</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validationRules</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getValidationRules</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>path</span>, <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>httpMethod</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>headerValidation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateHeaders</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>headers</span>, <span style=color:#a6e22e>validationRules</span>.<span style=color:#a6e22e>headers</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>headerValidation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Header validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>headerValidation</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate query parameters
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>queryValidation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateQueryParameters</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>queryStringParameters</span>, <span style=color:#a6e22e>validationRules</span>.<span style=color:#a6e22e>queryParams</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>queryValidation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Query parameter validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>queryValidation</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate request body
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>body</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bodyValidation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateRequestBody</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>body</span>, <span style=color:#a6e22e>validationRules</span>.<span style=color:#a6e22e>body</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>bodyValidation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Body validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>bodyValidation</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check for injection attacks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionCheck</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkForInjectionAttacks</span>(<span style=color:#a6e22e>context</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>injectionCheck</span>.<span style=color:#a6e22e>detected</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Potential injection attack detected: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>injectionCheck</span>.<span style=color:#66d9ef>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkRateLimit</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>rateLimiting</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rateLimitKey</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateRateLimitKey</span>(<span style=color:#a6e22e>context</span>, <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>authenticatedUser</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>rateLimiter</span>.<span style=color:#a6e22e>consume</span>(<span style=color:#a6e22e>rateLimitKey</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>rejRes</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>retryAfter</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>rejRes</span>.<span style=color:#a6e22e>msBeforeNext</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>) <span style=color:#f92672>||</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Rate limit exceeded&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Retry-After&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>retryAfter</span>.<span style=color:#a6e22e>toString</span>(),
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;X-RateLimit-Limit&#39;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>rateLimiting</span>.<span style=color:#a6e22e>limits</span>[<span style=color:#ae81ff>0</span>]<span style=color:#f92672>?</span>.<span style=color:#a6e22e>maxRequests</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>toString</span>() <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;1000&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;X-RateLimit-Remaining&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;0&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;X-RateLimit-Reset&#39;</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>+</span> <span style=color:#a6e22e>rejRes</span>.<span style=color:#a6e22e>msBeforeNext</span>).<span style=color:#a6e22e>toISOString</span>()
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>detectThreats</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>SecurityResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>threatDetection</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>securityResult</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>context</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Analyze request patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>threatAnalysis</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>threatDetector</span>.<span style=color:#a6e22e>analyzeRequest</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>ip</span>: <span style=color:#66d9ef>context.sourceIP</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>userAgent</span>: <span style=color:#66d9ef>context.userAgent</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>path</span>: <span style=color:#66d9ef>context.path</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>method</span>: <span style=color:#66d9ef>context.httpMethod</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span>: <span style=color:#66d9ef>context.headers</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>context.body</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>threatAnalysis</span>.<span style=color:#a6e22e>riskScore</span> <span style=color:#f92672>&gt;</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>securityConfig</span>.<span style=color:#a6e22e>threatDetection</span>.<span style=color:#a6e22e>riskThreshold</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Determine response action based on risk level
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>responseAction</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>determineResponseAction</span>(<span style=color:#a6e22e>threatAnalysis</span>.<span style=color:#a6e22e>riskScore</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>responseAction</span> <span style=color:#f92672>===</span> <span style=color:#a6e22e>PolicyAction</span>.<span style=color:#a6e22e>DENY</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction.DENY</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`High risk request detected: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>threatAnalysis</span>.<span style=color:#a6e22e>threats</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>securityResult</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>threatAnalysis</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkForInjectionAttacks</span>(<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>InjectionCheckResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>injectionPatterns</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#75715e>// SQL Injection patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b)/i</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>/(&#39;|(\\x27)|(\\x2D)|(;)|(\\x00)|(\\n)|(\\r)|(\\x1a))/i</span>,
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// NoSQL Injection patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(\$where|\$ne|\$in|\$nin|\$exists|\$regex)/i</span>,
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// XSS patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(&lt;script|javascript:|vbscript:|onload=|onerror=|onclick=)/i</span>,
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Command injection patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(;|\|&amp;|&amp;&amp;|\|\||`|\$\(|\${)/</span>,
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// LDAP injection patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(\*|\)|\(|\\|\||&amp;)/</span>,
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// XML injection patterns
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#e6db74>/(&lt;!DOCTYPE|&lt;!ENTITY|SYSTEM|PUBLIC)/i</span>
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkString</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>path</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>queryStringParameters</span> <span style=color:#f92672>||</span> {}),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>body</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    ].<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39; &#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>pattern</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>injectionPatterns</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>pattern</span>.<span style=color:#a6e22e>test</span>(<span style=color:#a6e22e>checkString</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>detected</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>type</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>identifyInjectionType</span>(<span style=color:#a6e22e>pattern</span>),
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>pattern</span>: <span style=color:#66d9ef>pattern.source</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>detected</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>generateRateLimitKey</span>(<span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>, <span style=color:#a6e22e>user?</span>: <span style=color:#66d9ef>AuthenticatedUser</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keyComponents</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Include user ID if authenticated
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>user</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>keyComponents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>`user:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>keyComponents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>`ip:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>sourceIP</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Include API endpoint
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>keyComponents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>`endpoint:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>path</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Include method
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>keyComponents</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>`method:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>httpMethod</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>keyComponents</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;:&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>secureResponse</span>(<span style=color:#a6e22e>response</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>context</span>: <span style=color:#66d9ef>RequestContext</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>APIGatewayProxyResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>secureHeaders</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Content-Security-Policy&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;default-src &#39;self&#39;&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;X-Content-Type-Options&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;nosniff&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;X-Frame-Options&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;DENY&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;X-XSS-Protection&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;1; mode=block&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Strict-Transport-Security&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;max-age=31536000; includeSubDomains&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;Referrer-Policy&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;strict-origin-when-cross-origin&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove sensitive headers
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>filteredHeaders</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>filterSensitiveHeaders</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>headers</span> <span style=color:#f92672>||</span> {});
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>statusCode</span>: <span style=color:#66d9ef>response.statusCode</span> <span style=color:#f92672>||</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>filteredHeaders</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>secureHeaders</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>response.body</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isBase64Encoded</span>: <span style=color:#66d9ef>response.isBase64Encoded</span> <span style=color:#f92672>||</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>createSecurityResponse</span>(<span style=color:#a6e22e>securityResult</span>: <span style=color:#66d9ef>SecurityResult</span>, <span style=color:#a6e22e>requestId</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>APIGatewayProxyResult</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>statusCode</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getStatusCodeForSecurityAction</span>(<span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>action</span>, <span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>reason</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>statusCode</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;X-Request-ID&#39;</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>requestId</span>,
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>securityResult</span>.<span style=color:#a6e22e>headers</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>JSON.stringify</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Security validation failed&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span>: <span style=color:#66d9ef>securityResult.reason</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestId</span>
</span></span><span style=display:flex><span>      })
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>getStatusCodeForSecurityAction</span>(<span style=color:#a6e22e>action</span>: <span style=color:#66d9ef>PolicyAction</span>, <span style=color:#a6e22e>reason?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> (<span style=color:#a6e22e>action</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>PolicyAction.DENY</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reason</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;authentication&#39;</span>)) <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>401</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reason</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;authorization&#39;</span>)) <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>403</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reason</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;rate limit&#39;</span>)) <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>429</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>reason</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;validation&#39;</span>)) <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>400</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>403</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>200</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=oauth-20-and-openid-connect-integration>OAuth 2.0 and OpenID Connect Integration</h2><p>Modern API security heavily relies on OAuth 2.0 and OpenID Connect protocols to provide secure, standardized authentication and authorization mechanisms. These protocols enable secure delegation of access rights while maintaining separation of concerns between authentication providers and resource servers. Implementing these protocols correctly requires understanding their nuances and potential security vulnerabilities.</p><p>The integration of OAuth 2.0 and OpenID Connect in cloud-native applications must address challenges such as token lifecycle management, scope validation, and the secure handling of refresh tokens. The implementation must also consider the various OAuth 2.0 flows and select the appropriate flow based on the client type and security requirements.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Comprehensive OAuth 2.0 and OpenID Connect implementation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>OAuthConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>issuer</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>clientSecret</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>redirectUri</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scopes</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>pkceEnabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenEndpoint</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>authorizationEndpoint</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>jwksUri</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>userInfoEndpoint</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>TokenResponse</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>accessToken</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>refreshToken?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>idToken?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>tokenType</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>expiresIn</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>UserInfo</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>sub</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>email?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>emailVerified?</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>picture?</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>roles?</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>permissions?</span>: <span style=color:#66d9ef>string</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OAuthSecurityProvider</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>OAuthConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>jwksClient</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>tokenCache</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>string</span>, <span style=color:#a6e22e>CachedToken</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>OAuthConfig</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>jwksClient</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initializeJWKSClient</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>startTokenCleanup</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>initiateAuthorizationFlow</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>codeChallenge?</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>codeChallengeMethod?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>string</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>response_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;code&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>this.config.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>redirect_uri</span>: <span style=color:#66d9ef>this.config.redirectUri</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>this.config.scopes.join</span>(<span style=color:#e6db74>&#39; &#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>state</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add PKCE parameters if enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pkceEnabled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>codeChallenge</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#39;code_challenge&#39;</span>, <span style=color:#a6e22e>codeChallenge</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>append</span>(<span style=color:#e6db74>&#39;code_challenge_method&#39;</span>, <span style=color:#a6e22e>codeChallengeMethod</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;S256&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>authorizationEndpoint</span><span style=color:#e6db74>}</span><span style=color:#e6db74>?</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>params</span>.<span style=color:#a6e22e>toString</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>exchangeCodeForTokens</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>authorizationCode</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>string</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>codeVerifier?</span>: <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate state parameter to prevent CSRF attacks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateState</span>(<span style=color:#a6e22e>state</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Invalid state parameter&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenRequest</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>grant_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;authorization_code&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>code</span>: <span style=color:#66d9ef>authorizationCode</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>redirect_uri</span>: <span style=color:#66d9ef>this.config.redirectUri</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>this.config.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_secret</span>: <span style=color:#66d9ef>this.config.clientSecret</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add PKCE code verifier if enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>pkceEnabled</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>codeVerifier</span>) {
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>tokenRequest</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>).<span style=color:#a6e22e>code_verifier</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>codeVerifier</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>makeTokenRequest</span>(<span style=color:#a6e22e>tokenRequest</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateTokenResponse</span>(<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Cache tokens for future use
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>accessToken</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheToken</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>accessToken</span>, <span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token exchange failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateAccessToken</span>(<span style=color:#a6e22e>accessToken</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenValidationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check cache first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cached</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenCache</span>.<span style=color:#66d9ef>get</span>(<span style=color:#a6e22e>accessToken</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>cached</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isTokenExpired</span>(<span style=color:#a6e22e>cached</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>cached.claims</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>scopes</span>: <span style=color:#66d9ef>cached.scopes</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate token signature and claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>claims</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>verifyJWT</span>(<span style=color:#a6e22e>accessToken</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate token claims
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>claimsValidation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateTokenClaims</span>(<span style=color:#a6e22e>claims</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>claimsValidation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span>: <span style=color:#66d9ef>claimsValidation.reason</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Extract scopes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>scopes</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>extractScopes</span>(<span style=color:#a6e22e>claims</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Cache validated token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheToken</span>(<span style=color:#a6e22e>accessToken</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>accessToken</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokenType</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Bearer&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>expiresIn</span>: <span style=color:#66d9ef>claims.exp</span> <span style=color:#f92672>-</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>scopes.join</span>(<span style=color:#e6db74>&#39; &#39;</span>)
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>claims</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scopes</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Token validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>refreshTokens</span>(<span style=color:#a6e22e>refreshToken</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenResponse</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refreshRequest</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>grant_type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;refresh_token&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>refresh_token</span>: <span style=color:#66d9ef>refreshToken</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>this.config.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_secret</span>: <span style=color:#66d9ef>this.config.clientSecret</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>makeTokenRequest</span>(<span style=color:#a6e22e>refreshRequest</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate new tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateTokenResponse</span>(<span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Invalidate old tokens from cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>invalidateTokensForRefresh</span>(<span style=color:#a6e22e>refreshToken</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Cache new tokens
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>accessToken</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cacheToken</span>(<span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>accessToken</span>, <span style=color:#a6e22e>response</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token refresh failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getUserInfo</span>(<span style=color:#a6e22e>accessToken</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>UserInfo</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate access token first
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenValidation</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateAccessToken</span>(<span style=color:#a6e22e>accessToken</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>tokenValidation</span>.<span style=color:#a6e22e>isValid</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Invalid access token&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check if token has required scope for user info
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>tokenValidation</span>.<span style=color:#a6e22e>scopes</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;openid&#39;</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;Token does not have required scope for user info&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>userInfoEndpoint</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;GET&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Authorization&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Bearer </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>accessToken</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/json&#39;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`UserInfo request failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userInfo</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Validate user info response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateUserInfo</span>(<span style=color:#a6e22e>userInfo</span>, <span style=color:#a6e22e>tokenValidation</span>.<span style=color:#a6e22e>claims</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>sub</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>userInfo</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Failed to retrieve user info: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>revokeToken</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tokenTypeHint</span><span style=color:#f92672>?:</span> <span style=color:#e6db74>&#39;access_token&#39;</span> <span style=color:#f92672>|</span> <span style=color:#e6db74>&#39;refresh_token&#39;</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>revokeRequest</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>token</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>this.config.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_secret</span>: <span style=color:#66d9ef>this.config.clientSecret</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>tokenTypeHint</span>) {
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>revokeRequest</span> <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>any</span>).<span style=color:#a6e22e>token_type_hint</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tokenTypeHint</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>tokenEndpoint</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#39;/token&#39;</span>, <span style=color:#e6db74>&#39;/revoke&#39;</span>), {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>(<span style=color:#a6e22e>revokeRequest</span>).<span style=color:#a6e22e>toString</span>()
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token revocation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Remove from cache
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token revocation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>verifyJWT</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>any</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Promise</span>((<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>verify</span>(<span style=color:#a6e22e>token</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getSigningKey</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>), {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>algorithms</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;RS256&#39;</span>, <span style=color:#e6db74>&#39;ES256&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>issuer</span>: <span style=color:#66d9ef>this.config.issuer</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>audience</span>: <span style=color:#66d9ef>this.config.clientId</span>
</span></span><span style=display:flex><span>      }, (<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>decoded</span>) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reject</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>decoded</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getSigningKey</span>(<span style=color:#a6e22e>header</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>callback</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>jwksClient</span>.<span style=color:#a6e22e>getSigningKey</span>(<span style=color:#a6e22e>header</span>.<span style=color:#a6e22e>kid</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>signingKey</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>getPublicKey</span>();
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>callback</span>(<span style=color:#66d9ef>null</span>, <span style=color:#a6e22e>signingKey</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>callback</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateTokenClaims</span>(<span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>ValidationResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check expiration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>exp</span> <span style=color:#f92672>&lt;=</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Token has expired&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check not before
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>nbf</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>nbf</span> <span style=color:#f92672>&gt;</span> Math.<span style=color:#a6e22e>floor</span>(Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Token not yet valid&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check issuer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>iss</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>issuer</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid issuer&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check audience
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>aud</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>aud</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>clientId</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid audience&#39;</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>aud</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>clientId</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid audience&#39;</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate scope if present
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scope</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokenScopes</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scope</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>hasValidScope</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>scopes</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>scope</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>tokenScopes</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>scope</span>));
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>hasValidScope</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Invalid scope&#39;</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>isValid</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>extractScopes</span>(<span style=color:#a6e22e>claims</span>: <span style=color:#66d9ef>any</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>string</span>[] {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scope</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scope</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39; &#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scp</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> Array.<span style=color:#a6e22e>isArray</span>(<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scp</span>) <span style=color:#f92672>?</span> <span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scp</span> <span style=color:#f92672>:</span> [<span style=color:#a6e22e>claims</span>.<span style=color:#a6e22e>scp</span>];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> [];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateUserInfo</span>(<span style=color:#a6e22e>userInfo</span>: <span style=color:#66d9ef>any</span>, <span style=color:#a6e22e>expectedSub?</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate subject matches token
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>expectedSub</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>userInfo</span>.<span style=color:#a6e22e>sub</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>expectedSub</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;UserInfo subject does not match token subject&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate required fields
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>userInfo</span>.<span style=color:#a6e22e>sub</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;UserInfo missing required subject field&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Validate email if present
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>userInfo</span>.<span style=color:#a6e22e>email</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isValidEmail</span>(<span style=color:#a6e22e>userInfo</span>.<span style=color:#a6e22e>email</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>&#39;UserInfo contains invalid email address&#39;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>isValidEmail</span>(<span style=color:#a6e22e>email</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>emailRegex</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>/^[^\s@]+@[^\s@]+\.[^\s@]+$/</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>emailRegex</span>.<span style=color:#a6e22e>test</span>(<span style=color:#a6e22e>email</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>validateState</span>(<span style=color:#a6e22e>state</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implement state validation logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// This should verify that the state parameter matches what was sent
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// and includes CSRF protection
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e>// Simplified for example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateScopes</span>(<span style=color:#a6e22e>requiredScopes</span>: <span style=color:#66d9ef>string</span>[], <span style=color:#a6e22e>tokenScopes</span>: <span style=color:#66d9ef>string</span>[])<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>boolean</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>requiredScopes</span>.<span style=color:#a6e22e>every</span>(<span style=color:#a6e22e>scope</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>tokenScopes</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>scope</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>introspectToken</span>(<span style=color:#a6e22e>token</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>TokenIntrospectionResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>introspectRequest</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>token</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_id</span>: <span style=color:#66d9ef>this.config.clientId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>client_secret</span>: <span style=color:#66d9ef>this.config.clientSecret</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>fetch</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>tokenEndpoint</span>.<span style=color:#a6e22e>replace</span>(<span style=color:#e6db74>&#39;/token&#39;</span>, <span style=color:#e6db74>&#39;/introspect&#39;</span>), {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>method</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;POST&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>headers</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#e6db74>&#39;Content-Type&#39;</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;application/x-www-form-urlencoded&#39;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span>: <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>URLSearchParams</span>(<span style=color:#a6e22e>introspectRequest</span>).<span style=color:#a6e22e>toString</span>()
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>ok</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token introspection failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>status</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>statusText</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>response</span>.<span style=color:#a6e22e>json</span>();
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>active</span>: <span style=color:#66d9ef>result.active</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>result.scope</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>clientId</span>: <span style=color:#66d9ef>result.client_id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>username</span>: <span style=color:#66d9ef>result.username</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>tokenType</span>: <span style=color:#66d9ef>result.token_type</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>exp</span>: <span style=color:#66d9ef>result.exp</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>iat</span>: <span style=color:#66d9ef>result.iat</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>sub</span>: <span style=color:#66d9ef>result.sub</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>aud</span>: <span style=color:#66d9ef>result.aud</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>iss</span>: <span style=color:#66d9ef>result.iss</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Token introspection failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>error</span> <span style=color:#66d9ef>instanceof</span> Error <span style=color:#f92672>?</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Unknown error&#39;</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>startTokenCleanup</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Clean up expired tokens every 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(() <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> [<span style=color:#a6e22e>token</span>, <span style=color:#a6e22e>cached</span>] <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenCache</span>.<span style=color:#a6e22e>entries</span>()) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isTokenExpired</span>(<span style=color:#a6e22e>cached</span>)) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>tokenCache</span>.<span style=color:#66d9ef>delete</span>(<span style=color:#a6e22e>token</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>isTokenExpired</span>(<span style=color:#a6e22e>cached</span>: <span style=color:#66d9ef>CachedToken</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>boolean</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>cached</span>.<span style=color:#a6e22e>expiresAt</span> <span style=color:#f92672>&lt;=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=advanced-rate-limiting-and-throttling>Advanced Rate Limiting and Throttling</h2><p>Effective rate limiting and throttling mechanisms are essential for protecting APIs from abuse, ensuring fair resource allocation, and maintaining service availability under high load conditions. Advanced rate limiting goes beyond simple request counting to implement sophisticated algorithms that can adapt to different usage patterns and provide granular control over resource consumption.</p><p>Modern rate limiting systems must support multiple dimensions of limiting, including per-user, per-API, per-service, and global limits. They must also implement intelligent algorithms that can handle burst traffic while preventing sustained abuse and provide meaningful feedback to clients about their current usage status.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#75715e>// Advanced rate limiting and throttling system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RateLimitConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>algorithm</span>: <span style=color:#66d9ef>RateLimitAlgorithm</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>limits</span>: <span style=color:#66d9ef>RateLimit</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>keyGenerators</span>: <span style=color:#66d9ef>KeyGenerator</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>burstHandling</span>: <span style=color:#66d9ef>BurstConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quotaManagement</span>: <span style=color:#66d9ef>QuotaConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>distributedMode</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>RateLimit</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>name</span>: <span style=color:#66d9ef>string</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>maxRequests</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>windowSize</span>: <span style=color:#66d9ef>number</span>; <span style=color:#75715e>// seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>windowType</span>: <span style=color:#66d9ef>WindowType</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>scope</span>: <span style=color:#66d9ef>LimitScope</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>overrideRules</span>: <span style=color:#66d9ef>OverrideRule</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>interface</span> <span style=color:#a6e22e>QuotaConfig</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>enabled</span>: <span style=color:#66d9ef>boolean</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>resetPeriod</span>: <span style=color:#66d9ef>ResetPeriod</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>quotaTypes</span>: <span style=color:#66d9ef>QuotaType</span>[];
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>gracePeriod</span>: <span style=color:#66d9ef>number</span>;
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>warningThresholds</span>: <span style=color:#66d9ef>number</span>[];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>RateLimitAlgorithm</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>TOKEN_BUCKET</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;TOKEN_BUCKET&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>LEAKY_BUCKET</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;LEAKY_BUCKET&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FIXED_WINDOW</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FIXED_WINDOW&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SLIDING_WINDOW</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SLIDING_WINDOW&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ADAPTIVE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ADAPTIVE&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>WindowType</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>FIXED</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;FIXED&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SLIDING</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SLIDING&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>ROLLING</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;ROLLING&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>LimitScope</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>USER</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;USER&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>API_KEY</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;API_KEY&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>IP_ADDRESS</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;IP_ADDRESS&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>SERVICE</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;SERVICE&#39;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>GLOBAL</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;GLOBAL&#39;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AdvancedRateLimiter</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>RateLimitConfig</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>algorithms</span>: <span style=color:#66d9ef>Map</span>&lt;<span style=color:#f92672>RateLimitAlgorithm</span>, <span style=color:#a6e22e>RateLimitingAlgorithm</span>&gt; <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Map</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>quotaStore</span>: <span style=color:#66d9ef>QuotaStore</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>metricsCollector</span>: <span style=color:#66d9ef>MetricsCollector</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>redisClient</span>: <span style=color:#66d9ef>any</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>RateLimitConfig</span>, <span style=color:#a6e22e>redisClient</span>: <span style=color:#66d9ef>any</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>redisClient</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quotaStore</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QuotaStore</span>(<span style=color:#a6e22e>redisClient</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metricsCollector</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>MetricsCollector</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>initializeAlgorithms</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>startBackgroundTasks</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkRateLimit</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RateLimitResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>results</span>: <span style=color:#66d9ef>RateLimitResult</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate all applicable rate limit keys
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keys</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateRateLimitKeys</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check each applicable rate limit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>keys</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>findApplicableLimit</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>limit</span>) <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>algorithm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>get</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>algorithm</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>algorithm</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> Error(<span style=color:#e6db74>`Unsupported rate limiting algorithm: </span><span style=color:#e6db74>${</span><span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>algorithm</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>algorithm</span>.<span style=color:#a6e22e>checkLimit</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// If any limit is exceeded, return immediately
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>allowed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordViolation</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// All limits passed, consume tokens/quotas
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>keys</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>limit</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>findApplicableLimit</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>limit</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>algorithm</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>get</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>algorithm</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>algorithm</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>consumeToken</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Check quota limits if enabled
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>quotaManagement</span>.<span style=color:#a6e22e>enabled</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quotaResult</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkQuotaLimits</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>quotaResult</span>.<span style=color:#a6e22e>allowed</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>quotaResult</span>;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Return the most restrictive successful result
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>mostRestrictive</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>reduce</span>((<span style=color:#a6e22e>prev</span>, <span style=color:#a6e22e>current</span>) <span style=color:#f92672>=&gt;</span> 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>current</span>.<span style=color:#a6e22e>remainingRequests</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>prev</span>.<span style=color:#a6e22e>remainingRequests</span> <span style=color:#f92672>?</span> <span style=color:#a6e22e>current</span> : <span style=color:#66d9ef>prev</span>
</span></span><span style=display:flex><span>    );
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordSuccessfulRequest</span>(<span style=color:#a6e22e>request</span>, <span style=color:#a6e22e>mostRestrictive</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>mostRestrictive</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateRateLimitKeys</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RateLimitKey</span><span style=color:#960050;background-color:#1e0010>[]</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keys</span>: <span style=color:#66d9ef>RateLimitKey</span>[] <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>generator</span> <span style=color:#66d9ef>of</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>keyGenerators</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>generator</span>.<span style=color:#a6e22e>generateKey</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>keys</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>keys</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>initializeAlgorithms</span>()<span style=color:#f92672>:</span> <span style=color:#66d9ef>void</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RateLimitAlgorithm</span>.<span style=color:#a6e22e>TOKEN_BUCKET</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>TokenBucketAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RateLimitAlgorithm</span>.<span style=color:#a6e22e>LEAKY_BUCKET</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>LeakyBucketAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RateLimitAlgorithm</span>.<span style=color:#a6e22e>FIXED_WINDOW</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>FixedWindowAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RateLimitAlgorithm</span>.<span style=color:#a6e22e>SLIDING_WINDOW</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SlidingWindowAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>algorithms</span>.<span style=color:#66d9ef>set</span>(<span style=color:#a6e22e>RateLimitAlgorithm</span>.<span style=color:#a6e22e>ADAPTIVE</span>, <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AdaptiveAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metricsCollector</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TokenBucketAlgorithm</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>RateLimitingAlgorithm</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>redisClient</span>: <span style=color:#66d9ef>any</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkLimit</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RateLimitResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bucketKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`token_bucket:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>value</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get current bucket state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>bucketData</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getBucketState</span>(<span style=color:#a6e22e>bucketKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Calculate tokens to add based on time elapsed
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tokensToAdd</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateTokensToAdd</span>(<span style=color:#a6e22e>bucketData</span>.<span style=color:#a6e22e>lastRefill</span>, <span style=color:#a6e22e>now</span>, <span style=color:#a6e22e>limit</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentTokens</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>min</span>(<span style=color:#a6e22e>bucketData</span>.<span style=color:#a6e22e>tokens</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>tokensToAdd</span>, <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>currentTokens</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Allow request and update bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>newTokens</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>currentTokens</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateBucketState</span>(<span style=color:#a6e22e>bucketKey</span>, <span style=color:#a6e22e>newTokens</span>, <span style=color:#a6e22e>now</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>remainingRequests</span>: <span style=color:#66d9ef>Math.floor</span>(<span style=color:#a6e22e>newTokens</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>now</span> <span style=color:#f92672>+</span> (<span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>newTokens</span>) <span style=color:#f92672>*</span> (<span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span>)),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryAfter</span>: <span style=color:#66d9ef>0</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Request denied
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refillRate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span>; <span style=color:#75715e>// tokens per second
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeToNextToken</span> <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>currentTokens</span>) <span style=color:#f92672>/</span> <span style=color:#a6e22e>refillRate</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>remainingRequests</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>now</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>timeToNextToken</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryAfter</span>: <span style=color:#66d9ef>Math.ceil</span>(<span style=color:#a6e22e>timeToNextToken</span>)
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>consumeToken</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Token consumption is handled in checkLimit for token bucket
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getBucketState</span>(<span style=color:#a6e22e>bucketKey</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>BucketState</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>data</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>hmget</span>(<span style=color:#a6e22e>bucketKey</span>, <span style=color:#e6db74>&#39;tokens&#39;</span>, <span style=color:#e6db74>&#39;lastRefill&#39;</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tokens</span>: <span style=color:#66d9ef>parseFloat</span>(<span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>||</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>lastRefill</span>: <span style=color:#66d9ef>parseInt</span>(<span style=color:#a6e22e>data</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>||</span> Date.<span style=color:#a6e22e>now</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>updateBucketState</span>(<span style=color:#a6e22e>bucketKey</span>: <span style=color:#66d9ef>string</span>, <span style=color:#a6e22e>tokens</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>number</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>hmset</span>(<span style=color:#a6e22e>bucketKey</span>, <span style=color:#e6db74>&#39;tokens&#39;</span>, <span style=color:#a6e22e>tokens</span>.<span style=color:#a6e22e>toString</span>(), <span style=color:#e6db74>&#39;lastRefill&#39;</span>, <span style=color:#a6e22e>timestamp</span>.<span style=color:#a6e22e>toString</span>());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>expire</span>(<span style=color:#a6e22e>bucketKey</span>, <span style=color:#ae81ff>3600</span>); <span style=color:#75715e>// 1 hour TTL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>calculateTokensToAdd</span>(<span style=color:#a6e22e>lastRefill</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>now</span>: <span style=color:#66d9ef>number</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeElapsed</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>lastRefill</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>; <span style=color:#75715e>// seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>refillRate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span>; <span style=color:#75715e>// tokens per second
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>timeElapsed</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>refillRate</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SlidingWindowAlgorithm</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>RateLimitingAlgorithm</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>redisClient</span>: <span style=color:#66d9ef>any</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkLimit</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RateLimitResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>windowKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`sliding_window:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>value</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>windowStart</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>-</span> (<span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Remove expired entries and count current requests
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>zremrangebyscore</span>(<span style=color:#a6e22e>windowKey</span>, <span style=color:#e6db74>&#39;-inf&#39;</span>, <span style=color:#a6e22e>windowStart</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>currentCount</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>zcard</span>(<span style=color:#a6e22e>windowKey</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>currentCount</span> <span style=color:#f92672>&lt;</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>maxRequests</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Allow request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>remainingRequests</span>: <span style=color:#66d9ef>limit.maxRequests</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>currentCount</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>now</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryAfter</span>: <span style=color:#66d9ef>0</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Request denied - find when oldest request will expire
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>oldestRequest</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>zrange</span>(<span style=color:#a6e22e>windowKey</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#e6db74>&#39;WITHSCORES&#39;</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>retryAfter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>oldestRequest</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span>        <span style=color:#f92672>?</span> Math.<span style=color:#a6e22e>ceil</span>((parseInt(<span style=color:#a6e22e>oldestRequest</span>[<span style=color:#ae81ff>1</span>]) <span style=color:#f92672>+</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>now</span>) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>:</span> <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span>;
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>remainingRequests</span>: <span style=color:#66d9ef>0</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>now</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>retryAfter</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retryAfter</span>
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>consumeToken</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>windowKey</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`sliding_window:</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>value</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>now</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>requestId</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>now</span><span style=color:#e6db74>}</span><span style=color:#e6db74>_</span><span style=color:#e6db74>${</span>Math.<span style=color:#a6e22e>random</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add current request to window
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>zadd</span>(<span style=color:#a6e22e>windowKey</span>, <span style=color:#a6e22e>now</span>, <span style=color:#a6e22e>requestId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>.<span style=color:#a6e22e>expire</span>(<span style=color:#a6e22e>windowKey</span>, <span style=color:#a6e22e>limit</span>.<span style=color:#a6e22e>windowSize</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>60</span>); <span style=color:#75715e>// Add buffer to TTL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AdaptiveAlgorithm</span> <span style=color:#66d9ef>implements</span> <span style=color:#a6e22e>RateLimitingAlgorithm</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>redisClient</span>: <span style=color:#66d9ef>any</span>, 
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>metricsCollector</span>: <span style=color:#66d9ef>MetricsCollector</span>
</span></span><span style=display:flex><span>  ) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkLimit</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>RateLimitResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Get current system metrics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metricsCollector</span>.<span style=color:#a6e22e>getCurrentMetrics</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adjust limit based on system load
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>adjustedLimit</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateAdaptiveLimit</span>(<span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Use sliding window algorithm with adjusted limit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>slidingWindow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SlidingWindowAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>slidingWindow</span>.<span style=color:#a6e22e>checkLimit</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>adjustedLimit</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Track adaptation for future adjustments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>trackAdaptation</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>adjustedLimit</span>, <span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>result</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>result</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>consumeToken</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>, <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>RateLimit</span>, <span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metricsCollector</span>.<span style=color:#a6e22e>getCurrentMetrics</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>adjustedLimit</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateAdaptiveLimit</span>(<span style=color:#a6e22e>limit</span>, <span style=color:#a6e22e>metrics</span>, <span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>slidingWindow</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>SlidingWindowAlgorithm</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>redisClient</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>slidingWindow</span>.<span style=color:#a6e22e>consumeToken</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>adjustedLimit</span>, <span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>calculateAdaptiveLimit</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>baseLimit</span>: <span style=color:#66d9ef>RateLimit</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>: <span style=color:#66d9ef>SystemMetrics</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>RateLimit</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1.0</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adjust based on CPU usage
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>cpuUsage</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>80</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>0.5</span>; <span style=color:#75715e>// Reduce limit by 50%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>cpuUsage</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>30</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>1.2</span>; <span style=color:#75715e>// Increase limit by 20%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adjust based on memory usage
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>memoryUsage</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>85</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>0.7</span>; <span style=color:#75715e>// Reduce limit by 30%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adjust based on error rate
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>errorRate</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>0.6</span>; <span style=color:#75715e>// Reduce limit by 40%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Adjust based on response time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>avgResponseTime</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2000</span>) { <span style=color:#75715e>// 2 seconds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#ae81ff>0.8</span>; <span style=color:#75715e>// Reduce limit by 20%
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Apply user/service specific adjustments
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>userAdjustment</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getUserSpecificAdjustment</span>(<span style=color:#a6e22e>key</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adjustmentFactor</span> <span style=color:#f92672>*=</span> <span style=color:#a6e22e>userAdjustment</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      ...<span style=color:#a6e22e>baseLimit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>maxRequests</span>: <span style=color:#66d9ef>Math.max</span>(<span style=color:#ae81ff>1</span>, Math.<span style=color:#a6e22e>floor</span>(<span style=color:#a6e22e>baseLimit</span>.<span style=color:#a6e22e>maxRequests</span> <span style=color:#f92672>*</span> <span style=color:#a6e22e>adjustmentFactor</span>))
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>getUserSpecificAdjustment</span>(<span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Implement user-specific adjustments based on:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// - Historical behavior
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// - Service tier
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// - Trust score
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// - Geographic location
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1.0</span>; <span style=color:#75715e>// Simplified for example
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>trackAdaptation</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>RateLimitKey</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>originalLimit</span>: <span style=color:#66d9ef>RateLimit</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>adjustedLimit</span>: <span style=color:#66d9ef>RateLimit</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>metrics</span>: <span style=color:#66d9ef>SystemMetrics</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>result</span>: <span style=color:#66d9ef>RateLimitResult</span>
</span></span><span style=display:flex><span>  )<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>adaptationData</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span>: <span style=color:#66d9ef>Date.now</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>key</span>: <span style=color:#66d9ef>key.value</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>originalLimit</span>: <span style=color:#66d9ef>originalLimit.maxRequests</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustedLimit</span>: <span style=color:#66d9ef>adjustedLimit.maxRequests</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>adjustmentFactor</span>: <span style=color:#66d9ef>adjustedLimit.maxRequests</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>originalLimit</span>.<span style=color:#a6e22e>maxRequests</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>systemMetrics</span>: <span style=color:#66d9ef>metrics</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requestAllowed</span>: <span style=color:#66d9ef>result.allowed</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metricsCollector</span>.<span style=color:#a6e22e>recordAdaptation</span>(<span style=color:#a6e22e>adaptationData</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>QuotaManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>constructor</span>(<span style=color:#66d9ef>private</span> <span style=color:#a6e22e>quotaStore</span>: <span style=color:#66d9ef>QuotaStore</span>, <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>config</span>: <span style=color:#66d9ef>QuotaConfig</span>) {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkQuota</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>QuotaCheckResult</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quotaKeys</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateQuotaKeys</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quotaKey</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>quotaKeys</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>usage</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quotaStore</span>.<span style=color:#a6e22e>getUsage</span>(<span style=color:#a6e22e>quotaKey</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quota</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getQuotaForKey</span>(<span style=color:#a6e22e>quotaKey</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>usage</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>quota</span>.<span style=color:#a6e22e>limit</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>quotaType</span>: <span style=color:#66d9ef>quota.type</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>used</span>: <span style=color:#66d9ef>usage</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>limit</span>: <span style=color:#66d9ef>quota.limit</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>quota.resetTime</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>retryAfter</span>: <span style=color:#66d9ef>this.calculateRetryAfter</span>(<span style=color:#a6e22e>quota</span>.<span style=color:#a6e22e>resetTime</span>)
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Check warning thresholds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>usagePercentage</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>usage</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>quota</span>.<span style=color:#a6e22e>limit</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>warningThresholds</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>threshold</span> <span style=color:#f92672>=&gt;</span> <span style=color:#a6e22e>usagePercentage</span> <span style=color:#f92672>&gt;=</span> <span style=color:#a6e22e>threshold</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendQuotaWarning</span>(<span style=color:#a6e22e>quotaKey</span>, <span style=color:#a6e22e>usage</span>, <span style=color:#a6e22e>quota</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>allowed</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>consumeQuota</span>(<span style=color:#a6e22e>request</span>: <span style=color:#66d9ef>RateLimitRequest</span>, <span style=color:#a6e22e>amount</span>: <span style=color:#66d9ef>number</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quotaKeys</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateQuotaKeys</span>(<span style=color:#a6e22e>request</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>quotaKey</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>quotaKeys</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quotaStore</span>.<span style=color:#a6e22e>incrementUsage</span>(<span style=color:#a6e22e>quotaKey</span>, <span style=color:#a6e22e>amount</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>resetQuota</span>(<span style=color:#a6e22e>quotaKey</span>: <span style=color:#66d9ef>string</span>)<span style=color:#f92672>:</span> <span style=color:#a6e22e>Promise</span>&lt;<span style=color:#f92672>void</span>&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>quotaStore</span>.<span style=color:#a6e22e>resetUsage</span>(<span style=color:#a6e22e>quotaKey</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> <span style=color:#a6e22e>calculateRetryAfter</span>(<span style=color:#a6e22e>resetTime</span>: <span style=color:#66d9ef>Date</span>)<span style=color:#f92672>:</span> <span style=color:#66d9ef>number</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> Math.<span style=color:#a6e22e>max</span>(<span style=color:#ae81ff>0</span>, Math.<span style=color:#a6e22e>ceil</span>((<span style=color:#a6e22e>resetTime</span>.<span style=color:#a6e22e>getTime</span>() <span style=color:#f92672>-</span> Date.<span style=color:#a6e22e>now</span>()) <span style=color:#f92672>/</span> <span style=color:#ae81ff>1000</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>API security in cloud-native applications requires a comprehensive, multi-layered approach that addresses authentication, authorization, input validation, rate limiting, and threat detection. The implementation of these security measures must balance protection with performance, ensuring that legitimate users can access services efficiently while preventing unauthorized access and malicious activities.</p><p>The patterns and implementations explored in this post demonstrate how modern API security systems can provide robust protection through centralized gateways, standardized authentication protocols, and intelligent rate limiting mechanisms. These systems must be designed to handle the scale and complexity of cloud-native environments while providing the flexibility needed to adapt to changing security requirements and threat landscapes.</p><p>As cloud-native applications continue to evolve, API security systems must incorporate emerging technologies such as machine learning for threat detection, zero-trust architectures for enhanced verification, and adaptive security controls that can respond dynamically to changing conditions. Organizations implementing these patterns should focus on creating security systems that are both comprehensive and maintainable, providing the protection needed for modern applications while supporting the agility and scalability that cloud-native architectures enable. The security foundation established by these API protection strategies will prove essential as we explore container and serverless security considerations in the next post of this series.</p></div><div class=social-share><h3 class=social-share-title>Share this post</h3><div class=social-share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&text=API+Security+Best+Practices+for+Cloud-Native+Applications+-+%3Cp%3EApplication+Programming+Interfaces+%28APIs%29+have+become+the+fundamental+building+blocks+of+cloud-native+applications%2C+enabling+microservices+to+communicate+and+%E2%80%A6%3C%2Fp%3E" target=_blank rel="noopener noreferrer" class="social-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
<span>Twitter</span>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="social-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
<span>LinkedIn</span>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="social-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
<span>Facebook</span>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&title=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="social-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
<span>Reddit</span>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&t=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="social-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
<span>Hacker News</span>
</a><a href="https://wa.me/?text=API+Security+Best+Practices+for+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="social-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
<span>WhatsApp</span>
</a><a href="mailto:?subject=API+Security+Best+Practices+for+Cloud-Native+Applications&body=Check+out+this+article%3A+API+Security+Best+Practices+for+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" class="social-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
<span>Email</span>
</a><button type=button class="social-share-button copy-link" data-url=https://scottobert.com/posts/api-security-best-practices/ title="Copy link to clipboard">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
<span>Copy Link</span></button></div></div><script>(function(){const n=document.querySelectorAll(".copy-link");n.forEach(n=>{n.addEventListener("click",function(){const n=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(n).then(()=>{t(this)}).catch(()=>{e(n,this)}):e(n,this)})});function e(e,n){const o=document.createElement("textarea");o.value=e,o.style.position="fixed",o.style.left="-999999px",o.style.top="-999999px",document.body.appendChild(o),o.focus(),o.select();try{document.execCommand("copy"),t(n)}catch(e){console.error("Fallback: Unable to copy",e),s(n)}document.body.removeChild(o)}function t(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Copied!",e.classList.add("copied"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("copied")},2e3)}function s(e){const t=e.querySelector("span").textContent;e.querySelector("span").textContent="Error",e.classList.add("error"),setTimeout(()=>{e.querySelector("span").textContent=t,e.classList.remove("error")},2e3)}})()</script><div id=comments-section style="margin-top:2rem;padding-top:2rem;border-top:1px solid #e1e5e9"><h3 style=margin-bottom:1rem;color:#586069>Comments</h3><script src=https://giscus.app/client.js data-repo=scottobert/scottobert.github.io data-repo-id=R_kgDOHRSG6A data-category=General data-category-id=DIC_kwDOHRSG6M4CrQaA data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article><div class=floating-social-share id=floating-share><div class=floating-share-toggle id=share-toggle title="Share this post"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76.0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66.0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66.0-3 1.34-3 3s1.34 3 3 3c.79.0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65.0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></div><div class=floating-share-buttons id=share-buttons><a href="https://twitter.com/intent/tweet?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&text=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button twitter" title="Share on Twitter"><svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
</a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="floating-share-button linkedin" title="Share on LinkedIn"><svg viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853.0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601.0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144.0-2.063-.926-2.063-2.065.0-1.138.92-2.063 2.063-2.063 1.14.0 2.064.925 2.064 2.063.0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225.0H1.771C.792.0.0.774.0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2.0 22.222.0h.003z"/></svg>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="floating-share-button facebook" title="Share on Facebook"><svg viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312.0 2.686.235 2.686.235v2.953H15.83c-1.491.0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
</a><a href="https://reddit.com/submit?url=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&title=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button reddit" title="Share on Reddit"><svg viewBox="0 0 24 24"><path d="M12 0A12 12 0 000 12a12 12 0 0012 12 12 12 0 0012-12A12 12 0 0012 0zm5.01 4.744c.688.0 1.25.561 1.25 1.249a1.25 1.25.0 01-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968.0 1.754.786 1.754 1.754.0.716-.435 1.333-1.01 1.614a3.111 3.111.0 01.042.52c0 2.694-3.13 4.87-7.004 4.87s-7.004-2.176-7.004-4.87c0-.183.015-.366.043-.534A1.748 1.748.0 014.028 12c0-.968.786-1.754 1.754-1.754.463.0.898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342.0 01.14-.197.35.35.0 01.238-.042l2.906.617a1.214 1.214.0 011.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687.0 1.248-.561 1.248-1.249S9.937 12 9.249 12zm5.5.0c-.687.0-1.248.561-1.248 1.25.0.687.561 1.248 1.249 1.248S16 13.937 16 13.249c0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327.0 00-.231.094.33.33.0 000 .463c.842.842 2.484.913 2.961.913s2.105-.056 2.961-.913a.361.361.0 00.029-.463.33.33.0 00-.464.0c-.547.533-1.684.73-2.512.73-.828.0-1.979-.196-2.512-.73a.326.326.0 00-.232-.095z"/></svg>
</a><a href="https://news.ycombinator.com/submitlink?u=https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F&t=API+Security+Best+Practices+for+Cloud-Native+Applications" target=_blank rel="noopener noreferrer" class="floating-share-button hackernews" title="Share on Hacker News"><svg viewBox="0 0 24 24"><path d="M0 24V0h24v24H0zM6.951 5.896l4.112 7.708v5.064h1.583v-4.972l4.148-7.799h-1.749l-2.457 4.875c-.372.745-.688 1.434-.688 1.434s-.297-.708-.651-1.434L8.831 5.896h-1.88z"/></svg>
</a><a href="https://wa.me/?text=API+Security+Best+Practices+for+Cloud-Native+Applications+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" target=_blank rel="noopener noreferrer" class="floating-share-button whatsapp" title="Share on WhatsApp"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198.0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479.0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87.0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86.0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64.0 5.122 1.03 6.988 2.898a9.825 9.825.0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815.0 0012.05.0C5.495.0.16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882.0 005.683 1.448h.005c6.554.0 11.89-5.335 11.893-11.893A11.821 11.821.0 0020.465 3.488"/></svg>
</a><a href="mailto:?subject=API+Security+Best+Practices+for+Cloud-Native+Applications&body=Check+out+this+article%3A+API+Security+Best+Practices+for+Cloud-Native+Applications+-+https%3A%2F%2Fscottobert.com%2Fposts%2Fapi-security-best-practices%2F" class="floating-share-button email" title="Share via Email"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1.0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4-8 5-8-5V6l8 5 8-5v2z"/></svg>
</a><button type=button class="floating-share-button copy-link" data-url=https://scottobert.com/posts/api-security-best-practices/ title="Copy link">
<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1.0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1.0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1.0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button></div></div><script>(function(){const s=document.getElementById("floating-share"),t=document.getElementById("share-toggle"),n=document.getElementById("share-buttons");if(!s||!t||!n)return;let e=!1,o;t.addEventListener("click",function(){e=!e,e?(n.classList.add("visible"),t.classList.add("active"),clearTimeout(o)):(n.classList.remove("visible"),t.classList.remove("active"))});function i(){clearTimeout(o),o=setTimeout(()=>{e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)},5e3)}s.addEventListener("mouseenter",()=>{clearTimeout(o)}),s.addEventListener("mouseleave",()=>{e&&i()}),t.addEventListener("click",()=>{e&&i()});let l=0;const d=300;window.addEventListener("scroll",function(){const o=window.pageYOffset||document.documentElement.scrollTop;o>d?s.classList.add("visible"):(s.classList.remove("visible"),e&&(n.classList.remove("visible"),t.classList.remove("active"),e=!1)),l=o});const a=n.querySelector(".copy-link");a&&a.addEventListener("click",function(){const e=this.getAttribute("data-url");navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(e).then(()=>{c(this)}).catch(()=>{r(e,this)}):r(e,this)});function r(e,t){const n=document.createElement("textarea");n.value=e,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{document.execCommand("copy"),c(t)}catch(e){console.error("Fallback: Unable to copy",e)}document.body.removeChild(n)}function c(e){e.classList.add("copied"),setTimeout(()=>{e.classList.remove("copied")},2e3)}})()</script></main><aside class=blog-sidebar><div class=sidebar-widget><h3>Recent Posts</h3><ul class=recent-posts><li><a href=/posts/cross-account-lambda-s3-access/>Cross-Account Lambda Access to S3: A Complete Implementation Guide</a>
<span class=post-date>Jun 19, 2025</span></li><li><a href=/posts/lambda-to-lambda-vs-sns-chaining/>Lambda-to-Lambda Calls vs. SNS Chaining in AWS: When and How to Use Each</a>
<span class=post-date>Jun 19, 2025</span></li><li><a href=/posts/advanced-cloudformation-patterns/>Infrastructure as Code: Advanced CloudFormation Patterns</a>
<span class=post-date>Jun 13, 2025</span></li><li><a href=/posts/reverting-git-commits-safely/>Reverting Git Commits Safely: Undoing Changes Without Losing History</a>
<span class=post-date>Jun 11, 2025</span></li><li><a href=/posts/dynamodb-streams-opensearch-sync/>Real-time Data Synchronization: Using DynamoDB Streams and Lambda to Keep OpenSearch Indexes Current</a>
<span class=post-date>Jun 6, 2025</span></li></ul></div><div class=sidebar-widget><h3>Post Series</h3><ul class=recent-posts><li><a href=/posts/cross-account-lambda-s3-access/>AWS Cross-Account Patterns: Cross-Account Lambda Access to S3: A Complete Implementation Guide</a>
<span class=post-date>Jun 19, 2025</span><div class=series-meta><a href=/series/aws-cross-account-patterns/ class=series-link>View all 1 posts in series →</a></div></li><li><a href=/posts/lambda-to-lambda-vs-sns-chaining/>AWS and Typescript: Lambda-to-Lambda Calls vs. SNS Chaining in AWS: When and How to Use Each</a>
<span class=post-date>Jun 19, 2025</span><div class=series-meta><a href=/series/aws-and-typescript/ class=series-link>View all 8 posts in series →</a></div></li><li><a href=/posts/real-time-processing-architectures/>Cloud Architecture Patterns: Real-time Processing Architectures</a>
<span class=post-date>Apr 11, 2021</span><div class=series-meta><a href=/series/cloud-architecture-patterns/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/technical-debt-management-growing-codebases/>Modern Development Practices: Technical Debt Management in Growing Codebases: Strategies for Sustainable Development</a>
<span class=post-date>Dec 19, 2021</span><div class=series-meta><a href=/series/modern-development-practices/ class=series-link>View all 7 posts in series →</a></div></li><li><a href=/posts/threat-modeling-cloud-applications/>Security in Cloud-Native Applications: Threat Modeling for Cloud Applications: A Comprehensive Approach to Security Design</a>
<span class=post-date>Oct 19, 2019</span><div class=series-meta><a href=/series/security-in-cloud-native-applications/ class=series-link>View all 7 posts in series →</a></div></li></ul></div><div class=sidebar-widget><h3>Categories</h3><ul class=categories><li><a href=/categories/api-development>api development (2)</a></li><li><a href=/categories/architecture>architecture (2)</a></li><li><a href=/categories/architecture-and-design>architecture and design (10)</a></li><li><a href=/categories/artificial-intelligence>artificial intelligence (1)</a></li><li><a href=/categories/aws>aws (1)</a></li><li><a href=/categories/cloud-computing>cloud computing (23)</a></li><li><a href=/categories/code-quality>code quality (1)</a></li><li><a href=/categories/compliance>compliance (1)</a></li><li><a href=/categories/cost-optimization>cost optimization (1)</a></li><li><a href=/categories/data-engineering>data engineering (3)</a></li><li><a href=/categories/database>database (1)</a></li><li><a href=/categories/database-design>database design (1)</a></li><li><a href=/categories/debugging-and-troubleshooting>debugging and troubleshooting (1)</a></li><li><a href=/categories/developer-experience>developer experience (1)</a></li><li><a href=/categories/development-tools>development tools (3)</a></li><li><a href=/categories/development-tutorials>development tutorials (1)</a></li><li><a href=/categories/infrastructure-as-code>infrastructure as code (1)</a></li><li><a href=/categories/microservices>microservices (1)</a></li><li><a href=/categories/performance>performance (1)</a></li><li><a href=/categories/quality-assurance>quality assurance (1)</a></li><li><a href=/categories/real-time-applications>real-time applications (1)</a></li><li><a href=/categories/security>security (8)</a></li><li><a href=/categories/serverless>serverless (2)</a></li><li><a href=/categories/software-development>software development (8)</a></li><li><a href=/categories/technical-debt>technical debt (1)</a></li><li><a href=/categories/testing>testing (2)</a></li><li><a href=/categories/version-control>version control (2)</a></li></ul></div><div class=sidebar-widget><h3>Tags</h3><div class=tag-cloud><a href=/tags/ai class=tag-cloud-item style=font-size:1rem>ai
</a><a href=/tags/api-design class=tag-cloud-item style=font-size:1rem>api design
</a><a href=/tags/api-gateway class=tag-cloud-item style=font-size:1rem>api gateway
</a><a href=/tags/api-security class=tag-cloud-item style=font-size:1rem>api security
</a><a href=/tags/architecture class=tag-cloud-item style=font-size:2rem>architecture
</a><a href=/tags/athena class=tag-cloud-item style=font-size:1rem>athena
</a><a href=/tags/authentication class=tag-cloud-item style=font-size:1rem>authentication
</a><a href=/tags/authorization class=tag-cloud-item style=font-size:1rem>authorization
</a><a href=/tags/automation class=tag-cloud-item style=font-size:1rem>automation
</a><a href=/tags/aws class=tag-cloud-item style=font-size:4rem>aws
</a><a href=/tags/aws-lambda class=tag-cloud-item style=font-size:1rem>aws lambda
</a><a href=/tags/best-practices class=tag-cloud-item style=font-size:2rem>best practices
</a><a href=/tags/cdk class=tag-cloud-item style=font-size:1rem>cdk
</a><a href=/tags/chaos-engineering class=tag-cloud-item style=font-size:1rem>chaos engineering
</a><a href=/tags/ci/cd class=tag-cloud-item style=font-size:1rem>ci/cd
</a><a href=/tags/cloud-native class=tag-cloud-item style=font-size:1rem>cloud native
</a><a href=/tags/cloudformation class=tag-cloud-item style=font-size:1rem>cloudformation
</a><a href=/tags/cloudnative class=tag-cloud-item style=font-size:1rem>cloudnative
</a><a href=/tags/code-quality class=tag-cloud-item style=font-size:1rem>code quality
</a><a href=/tags/communication-patterns class=tag-cloud-item style=font-size:1rem>communication patterns
</a><a href=/tags/compliance class=tag-cloud-item style=font-size:1rem>compliance
</a><a href=/tags/containers class=tag-cloud-item style=font-size:1rem>containers
</a><a href=/tags/cost-optimization class=tag-cloud-item style=font-size:1rem>cost optimization
</a><a href=/tags/cqrs class=tag-cloud-item style=font-size:1rem>cqrs
</a><a href=/tags/cross-account class=tag-cloud-item style=font-size:1rem>cross-account
</a><a href=/tags/data-architecture class=tag-cloud-item style=font-size:1rem>data architecture
</a><a href=/tags/data-lake class=tag-cloud-item style=font-size:1rem>data lake
</a><a href=/tags/data-modeling class=tag-cloud-item style=font-size:1rem>data modeling
</a><a href=/tags/database class=tag-cloud-item style=font-size:1rem>database
</a><a href=/tags/database-design class=tag-cloud-item style=font-size:1rem>database design
</a><a href=/tags/debugging class=tag-cloud-item style=font-size:1rem>debugging
</a><a href=/tags/debugging-and-troubleshooting class=tag-cloud-item style=font-size:1rem>debugging and troubleshooting
</a><a href=/tags/developer-tips class=tag-cloud-item style=font-size:1rem>developer tips
</a><a href=/tags/development class=tag-cloud-item style=font-size:2rem>development
</a><a href=/tags/devops class=tag-cloud-item style=font-size:1rem>devops
</a><a href=/tags/devsecops class=tag-cloud-item style=font-size:1rem>devsecops
</a><a href=/tags/distributed-systems class=tag-cloud-item style=font-size:1rem>distributed systems
</a><a href=/tags/docker class=tag-cloud-item style=font-size:1rem>docker
</a><a href=/tags/dynamodb class=tag-cloud-item style=font-size:1rem>dynamodb
</a><a href=/tags/encryption class=tag-cloud-item style=font-size:1rem>encryption
</a><a href=/tags/enterprise-architecture class=tag-cloud-item style=font-size:1rem>enterprise architecture
</a><a href=/tags/event-sourcing class=tag-cloud-item style=font-size:1rem>event sourcing
</a><a href=/tags/event-driven-architecture class=tag-cloud-item style=font-size:1rem>event-driven architecture
</a><a href=/tags/eventbridge class=tag-cloud-item style=font-size:1rem>eventbridge
</a><a href=/tags/fault-tolerance class=tag-cloud-item style=font-size:1rem>fault tolerance
</a><a href=/tags/gdpr class=tag-cloud-item style=font-size:1rem>gdpr
</a><a href=/tags/git class=tag-cloud-item style=font-size:1rem>git
</a><a href=/tags/glue class=tag-cloud-item style=font-size:1rem>glue
</a><a href=/tags/governance class=tag-cloud-item style=font-size:1rem>governance
</a><a href=/tags/graphql class=tag-cloud-item style=font-size:1rem>graphql
</a><a href=/tags/hipaa class=tag-cloud-item style=font-size:1rem>hipaa
</a><a href=/tags/iam class=tag-cloud-item style=font-size:1rem>iam
</a><a href=/tags/identity-management class=tag-cloud-item style=font-size:1rem>identity management
</a><a href=/tags/infrastructure class=tag-cloud-item style=font-size:1rem>infrastructure
</a><a href=/tags/infrastructure-as-code class=tag-cloud-item style=font-size:1rem>infrastructure as code
</a><a href=/tags/jwt class=tag-cloud-item style=font-size:1rem>jwt
</a><a href=/tags/kinesis class=tag-cloud-item style=font-size:1rem>kinesis
</a><a href=/tags/kubernetes class=tag-cloud-item style=font-size:1rem>kubernetes
</a><a href=/tags/lambda class=tag-cloud-item style=font-size:1rem>lambda
</a><a href=/tags/load-testing class=tag-cloud-item style=font-size:1rem>load testing
</a><a href=/tags/metrics class=tag-cloud-item style=font-size:1rem>metrics
</a><a href=/tags/microservices class=tag-cloud-item style=font-size:1rem>microservices
</a><a href=/tags/monitoring class=tag-cloud-item style=font-size:1rem>monitoring
</a><a href=/tags/multi-account class=tag-cloud-item style=font-size:1rem>multi-account
</a><a href=/tags/nosql class=tag-cloud-item style=font-size:1rem>nosql
</a><a href=/tags/oauth class=tag-cloud-item style=font-size:1rem>oauth
</a><a href=/tags/octave class=tag-cloud-item style=font-size:1rem>octave
</a><a href=/tags/opensearch class=tag-cloud-item style=font-size:1rem>opensearch
</a><a href=/tags/pasta class=tag-cloud-item style=font-size:1rem>pasta
</a><a href=/tags/patterns class=tag-cloud-item style=font-size:1rem>patterns
</a><a href=/tags/pci-dss class=tag-cloud-item style=font-size:1rem>pci-dss
</a><a href=/tags/performance-testing class=tag-cloud-item style=font-size:1rem>performance testing
</a><a href=/tags/productivity class=tag-cloud-item style=font-size:1rem>productivity
</a><a href=/tags/rate-limiting class=tag-cloud-item style=font-size:1rem>rate limiting
</a><a href=/tags/real-time class=tag-cloud-item style=font-size:1rem>real-time
</a><a href=/tags/refactoring class=tag-cloud-item style=font-size:1rem>refactoring
</a><a href=/tags/reliability class=tag-cloud-item style=font-size:1rem>reliability
</a><a href=/tags/resilience class=tag-cloud-item style=font-size:1rem>resilience
</a><a href=/tags/rest class=tag-cloud-item style=font-size:1rem>rest
</a><a href=/tags/rest-api class=tag-cloud-item style=font-size:1rem>rest api
</a><a href=/tags/riskassessment class=tag-cloud-item style=font-size:1rem>riskassessment
</a><a href=/tags/s3 class=tag-cloud-item style=font-size:1rem>s3
</a><a href=/tags/search class=tag-cloud-item style=font-size:1rem>search
</a><a href=/tags/secrets-management class=tag-cloud-item style=font-size:1rem>secrets management
</a><a href=/tags/security class=tag-cloud-item style=font-size:2rem>security
</a><a href=/tags/securitydesign class=tag-cloud-item style=font-size:1rem>securitydesign
</a><a href=/tags/serverless class=tag-cloud-item style=font-size:2rem>serverless
</a><a href=/tags/soc2 class=tag-cloud-item style=font-size:1rem>soc2
</a><a href=/tags/software-engineering class=tag-cloud-item style=font-size:1rem>software engineering
</a><a href=/tags/standards class=tag-cloud-item style=font-size:1rem>standards
</a><a href=/tags/stream-processing class=tag-cloud-item style=font-size:1rem>stream processing
</a><a href=/tags/streams class=tag-cloud-item style=font-size:1rem>streams
</a><a href=/tags/stride class=tag-cloud-item style=font-size:1rem>stride
</a><a href=/tags/tdd class=tag-cloud-item style=font-size:1rem>tdd
</a><a href=/tags/technical-debt class=tag-cloud-item style=font-size:1rem>technical debt
</a><a href=/tags/testing class=tag-cloud-item style=font-size:1rem>testing
</a><a href=/tags/threatmodeling class=tag-cloud-item style=font-size:1rem>threatmodeling
</a><a href=/tags/typescript class=tag-cloud-item style=font-size:3rem>typescript
</a><a href=/tags/version-control class=tag-cloud-item style=font-size:1rem>version control
</a><a href=/tags/websockets class=tag-cloud-item style=font-size:1rem>websockets
</a><a href=/tags/zero-trust class=tag-cloud-item style=font-size:1rem>zero trust</a></div></div><div class=sidebar-widget><h3>Subscribe</h3><div class=subscribe-links><a href=/index.xml class=rss-link><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg>
RSS Feed</a></div></div><div class="sidebar-widget npm-packages"><h3>My NPM Packages</h3><div id=npm-list></div></div></aside></div></div><footer class=site-footer><div class=container><p>&copy; 2025 Scott Obert</p></div></footer></body></html>